
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>prettify_MATLAB_html</title><meta name="generator" content="MATLAB 9.12"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2022-06-07"><meta name="DC.source" content="prettify_MATLAB_html.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">prettify_MATLAB_html(inputhtmlFile, verbose, overloadPublish, addCommandsToToolbar)</a></li><li><a href="#3">==========================================================================================================================================================</a></li><li><a href="#4">Documentation :</a></li><li><a href="#5">Version history :</a></li><li><a href="#6">Notes :</a></li><li><a href="#7">Authorship:</a></li><li><a href="#8">==========================================================================================================================================================</a></li><li><a href="#9">Constants</a></li><li><a href="#10">Check sufficient inputs</a></li><li><a href="#11">Clear show_warning and write_fstrm_to_file sub-functions</a></li><li><a href="#12">Overload publish</a></li><li><a href="#13">Execute toolbar functions</a></li><li><a href="#14">Some input checking</a></li><li><a href="#15">Open input file</a></li><li><a href="#16">Find [cssClass] tags</a></li><li><a href="#17">Themes</a></li><li><a href="#18">Define extra css</a></li><li><a href="#19">Define javascript</a></li><li><a href="#20">Insert extra css and javascript</a></li><li><a href="#21">Fix/tweak publish's css</a></li><li><a href="#22">html validation fixes</a></li><li><a href="#23">Insert floating "return" link</a></li><li><a href="#24">Find start and end of page body source</a></li><li><a href="#25">Move any <a href="style">style</a>&lt;/style&gt; section to before the body</a></li><li><a href="#26">Process [h2] tags</a></li><li><a href="#27">Process [targetn] and [jumpton] tags</a></li><li><a href="#28">Process colour, scale, and class tags</a></li><li><a href="#29">Find [dtls] and [smry] tags</a></li><li><a href="#30">Process [dtls] and [smry] tags</a></li><li><a href="#32">&nbsp;&nbsp;&nbsp;&nbsp;Remove excess line breaks after any tables in details sections</a></li><li><a href="#33">&nbsp;&nbsp;&nbsp;&nbsp;Remove excess spacing after any lists at the end of details sections</a></li><li><a href="#34">&nbsp;&nbsp;&nbsp;&nbsp;Add breaks between tables and images</a></li><li><a href="#36">Process [bottomMarginx] tags</a></li><li><a href="#37">Assign image-fit class to all images</a></li><li><a href="#38">Process undocumented [png2svg] tags</a></li><li><a href="#39">Process undocumented [removepng] tags</a></li><li><a href="#40">Process [darkAlt] tags</a></li><li><a href="#41">Replace [br] with <a href="br">br</a></a></li><li><a href="#42">Process undocumented [rembr] and [delbr] tags</a></li><li><a href="#43">Insert breaks of specified pixel height ([brx] tags)</a></li><li><a href="#44">Remove excess spacing after codeoutput sections</a></li><li><a href="#45">Remove erroneous <a href="p">p</a>&lt;/p&gt; tags</a></li><li><a href="#46">Insert link to FEX page</a></li><li><a href="#47">Remove/modify remaining prettify_MATLAB_html tags</a></li><li><a href="#48">Final bit of javascript</a></li><li><a href="#49">Write the output file</a></li><li><a href="#51">Subroutines</a></li><li><a href="#52">&nbsp;&nbsp;&nbsp;&nbsp;Index updater</a></li><li><a href="#54">&nbsp;&nbsp;&nbsp;&nbsp;Show warning dialogue if warnings were generated</a></li><li><a href="#57">==========================================================================================================================================================</a></li><li><a href="#58">Helper functions</a></li><li><a href="#59">&nbsp;&nbsp;&nbsp;&nbsp;Tag processing</a></li><li><a href="#60">&nbsp;&nbsp;&nbsp;&nbsp;Get path of this .m file</a></li><li><a href="#61">&nbsp;&nbsp;&nbsp;&nbsp;Save handle to built-in Publish function</a></li><li><a href="#62">&nbsp;&nbsp;&nbsp;&nbsp;Warning functions</a></li><li><a href="#63">&nbsp;&nbsp;&nbsp;&nbsp;Toolbar button functions</a></li><li><a href="#64">&nbsp;&nbsp;&nbsp;&nbsp;File read &amp; write</a></li><li><a href="#65">&nbsp;&nbsp;&nbsp;&nbsp;New line constant</a></li><li><a href="#66">==========================================================================================================================================================</a></li><li><a href="#67">Version history:</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> prettify_MATLAB_html(inputhtmlFile, verbose, overloadPublish, addCommandsToToolbar)
</pre><h2 id="2">prettify_MATLAB_html(inputhtmlFile, verbose, overloadPublish, addCommandsToToolbar)</h2><pre class="language-matlab">Given <span class="string">a</span> <span class="string">MATLAB-generated</span> <span class="string">HTML</span> <span class="string">file</span> <span class="string">as</span> <span class="string">an</span> <span class="string">input</span>, this <span class="string">function</span> <span class="string">adds</span> <span class="string">additional</span>
features <span class="string">such</span> <span class="string">as</span> <span class="string">disclosure</span> <span class="string">boxes</span> <span class="string">and</span> <span class="string">expand-all/collapse-all</span> <span class="string">links.</span> <span class="string">This</span> <span class="string">makes</span>
the <span class="string">document</span> <span class="string">more</span> <span class="string">closely</span> <span class="string">resemble</span> <span class="string">"official"</span> <span class="string">MATLAB</span> <span class="string">help</span> <span class="string">files.</span>
It <span class="string">also</span> <span class="string">gives</span> <span class="string">extended</span> <span class="string">formatting</span> <span class="string">options</span>, provides <span class="string">an</span> <span class="string">optional</span> <span class="string">dark</span> <span class="string">theme</span>, and
automatically <span class="string">enhances</span> <span class="string">the</span> <span class="string">formatting</span> <span class="string">of</span> <span class="string">inline</span> <span class="string">code</span> <span class="string">and</span> <span class="string">images.</span>
</pre><pre class="codeinput"><span class="comment">%	Version 6.5</span>
<span class="comment">%</span>
<span class="comment">%   Inputs:</span>
<span class="comment">%</span>
<span class="comment">%   inputhtmlFile:    Character vector. The name or full path of the MATLAB-generated</span>
<span class="comment">%                     HTML file to be processed. The file is automatically over-</span>
<span class="comment">%                     written by the processed file.</span>
<span class="comment">%</span>
<span class="comment">%   verbose:          Logical. Optional input to suppress the begin and end messages</span>
<span class="comment">%                     that are printed to the command line when prettify_MATLAB_html</span>
<span class="comment">%                     is run. Set to "false" to suppress the messages.</span>
<span class="comment">%</span>
<span class="comment">%   overloadPublish:  Logical. When used, the first two inputs are ignored. This is an</span>
<span class="comment">%                     optional input to configure an overload for MATLAB's publish</span>
<span class="comment">%                     function, so that when you press "publish" in the toolbar of a</span>
<span class="comment">%                     MATLAB editor window, the generated HTML will automatically be</span>
<span class="comment">%                     processed by prettify_MATLAB_html. This only needs to be done</span>
<span class="comment">%                     once per MATLAB session. If you put a call to:</span>
<span class="comment">%                     prettify_MATLAB_html([], [], true);</span>
<span class="comment">%                     in your startup.m file, publish will get overloaded every time</span>
<span class="comment">%                     you run MATLAB. To stop overloading the built-in publish</span>
<span class="comment">%                     function, set overloadPublish to false:</span>
<span class="comment">%                     prettify_MATLAB_html([], [], false);</span>
<span class="comment">%</span>
<span class="comment">%   addCommandsToToolbar:</span>
<span class="comment">%                     Logical. When used, the first two inputs are ignored. This is</span>
<span class="comment">%                     an optional input used to add shortcuts to the quick-access</span>
<span class="comment">%                     toolbar that then allow you to easily add prettify_MATLAB_html</span>
<span class="comment">%                     tags to your .m files. Set to true to add the commands.</span>
<span class="comment">%                     In MATLAB versions prior to 2018a, the buttons are added to your</span>
<span class="comment">%                     shortcuts, and you have to restart to get them to be added to the</span>
<span class="comment">%                     Quick-Access Toolbar. If anyone knows how to add shortcuts to the</span>
<span class="comment">%                     Quick-Access Toolbar programatically, without requiring a</span>
<span class="comment">%                     restart, please let me know: harry.dymond@bristol.ac.uk</span>
<span class="comment">%</span>
<span class="comment">%   Most prettify_MATLAB_html features require you to use additional markup "tags" in</span>
<span class="comment">%   the original source .m file, for example to indicate where you want the disclosure</span>
<span class="comment">%   boxes (the "expand"/"collapse" links are automatically generated).</span>
<span class="comment">%</span>
<span class="comment">%   See the &lt;a href="matlab:ans=dir(which('prettify_MATLAB_html.m'));</span>
<span class="comment">%   open([ans.folder filesep 'prettify documentation' filesep 'html' filesep 'prettify_MATLAB_html_helpdoc.html']);</span>
<span class="comment">%   clear ans"&gt;help document&lt;/a&gt; for more information</span>
</pre><h2 id="3">==========================================================================================================================================================</h2><h2 id="4">Documentation :</h2><pre class="language-matlab">Please <span class="string">see</span> <span class="string">the</span> <span class="string">help</span> <span class="string">document:</span> <span class="string">/prettify</span> <span class="string">documentation/html/prettify_MATLAB_html_helpdoc.html</span> <span class="string">for</span> <span class="string">more</span> <span class="string">information</span> <span class="string">(type "help prettify_MATLAB_html" at</span>
the <span class="string">MATLAB</span> <span class="string">command</span> <span class="string">line</span> <span class="string">to</span> <span class="string">get</span> <span class="string">a</span> <span class="string">clickable</span> <span class="string">link</span> <span class="string">to</span> <span class="string">the</span> <span class="string">help</span> <span class="string">document).</span>
</pre><pre class="codeinput"><span class="comment">%============================================================================================================================================================</span>
<span class="comment">%</span>
</pre><h2 id="5">Version history :</h2><pre class="language-matlab">Version <span class="string">history</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">end</span> <span class="string">of</span> <span class="string">this</span> <span class="string">file</span>
</pre><pre class="codeinput"><span class="comment">%============================================================================================================================================================</span>
<span class="comment">%</span>
</pre><h2 id="6">Notes :</h2><pre class="language-matlab">This <span class="string">file</span> <span class="string">uses</span> <span class="string">"sections"</span> <span class="string">to</span> <span class="string">help</span> <span class="string">segment</span> <span class="string">the</span> <span class="string">code</span> <span class="string">for</span> <span class="string">readability.</span> <span class="string">It</span> <span class="string">is</span> <span class="string">recommended</span> <span class="string">to</span> <span class="string">enable</span> <span class="string">folding</span> <span class="string">of</span> <span class="string">sections</span> <span class="string">in</span> <span class="untermstring">MATLAB's preferences, so</span>
that <span class="string">sections</span> <span class="string">can</span> <span class="string">be</span> <span class="string">collapsed/expanded.</span> <span class="string">Lines</span> <span class="string">are</span> <span class="string">157</span> <span class="string">characters</span> <span class="string">wide.</span> <span class="string">The</span> <span class="string">position</span> <span class="string">of</span> <span class="string">the</span> <span class="string">vertical</span> <span class="string">text-limit</span> <span class="string">line</span> <span class="string">(if shown)</span> <span class="string">may</span> <span class="string">be</span> <span class="string">moved</span> <span class="string">by</span> <span class="string">going</span> <span class="string">to</span>
MATLAB <span class="string">preferences</span> <span class="string">-&gt;</span> <span class="string">Editor/Debugger</span> <span class="string">-&gt;</span> <span class="string">Display</span> <span class="string">-&gt;</span> <span class="string">Right-hand</span> <span class="string">text</span> <span class="string">limit</span>
</pre><pre class="language-matlab">The <span class="string">code</span> <span class="string">uses</span> <span class="string">the</span> <span class="string">following</span> <span class="string">naming</span> <span class="string">convention</span> <span class="string">:</span>
    _____________________________________________
                      |
        Item(s)       |   Naming convention
    __________________|__________________________
        Variables     |   initialLowerTitleCase
    ------------------+--------------------------
        Functions     |   lower_case(<span class="keyword">...</span><span class="comment">)</span>
    ------------------+--------------------------
        constants     |   UPPER_CASE
    __________________|__________________________
</pre><pre class="codeinput"><span class="comment">%============================================================================================================================================================</span>
<span class="comment">%</span>
</pre><h2 id="7">Authorship:</h2><pre class="language-matlab">Written <span class="string">by</span> <span class="string">Harry</span> <span class="string">Dymond</span>, Electrical <span class="string">Energy</span> <span class="string">Management</span> <span class="string">Group</span>, University <span class="string">of</span> <span class="string">Bristol</span>, UK; harry.dymond@bris.ac.uk. If you find any bugs, please <span class="string">email</span> <span class="string">me!</span>
Developed <span class="string">with</span> <span class="string">MATLAB</span> <span class="string">R2018a</span> <span class="string">running</span> <span class="string">on</span> <span class="string">Windows</span> <span class="string">10</span> <span class="string">and</span> <span class="string">macOS</span> <span class="string">Mojave.</span>
</pre><h2 id="8">==========================================================================================================================================================</h2><h2 id="9">Constants</h2><pre class="codeinput">    HELP_URL     = [<span class="string">'    Click &lt;a href="matlab:ans=dir(which(''prettify_MATLAB_html.m''));'</span> <span class="keyword">...</span>
                    <span class="string">'open([ans.folder filesep ''prettify documentation'' filesep ''html'' filesep ''prettify_MATLAB_html_helpdoc.html'']);'</span> <span class="keyword">...</span>
                    <span class="string">'clear ans"&gt;here&lt;/a&gt; to see the help document for more information.'</span>];
    NO_START_ERR = <span class="string">'ERROR: couldn''t find start of content in html file'</span>;
    DEBUG        = getappdata(0,<span class="string">'PRETTY_DEBUG'</span>); <span class="keyword">if</span> isempty(DEBUG), DEBUG = false; <span class="keyword">end</span>
</pre><h2 id="10">Check sufficient inputs</h2><pre class="codeinput">    assert(nargin&gt;=1,[<span class="string">'    Call syntax error. Call syntax is:'</span> NL <span class="keyword">...</span>
                      <span class="string">'    prettify_MATLAB_html(inputhtmlFile, verbose, overloadPublish, addCommandsToToolbar)'</span> NL <span class="keyword">...</span>
                      <span class="string">'    Where inputs verbose, overloadPublish, and addCommandsToToolbar are optional.'</span> NL HELP_URL NL]);
    <span class="keyword">try</span>
</pre><h2 id="11">Clear show_warning and write_fstrm_to_file sub-functions</h2><pre class="codeinput">    show_warning(true)
    write_fstrm_to_file([], [], [])
</pre><h2 id="12">Overload publish</h2><pre class="codeinput">    <span class="keyword">if</span> nargin&gt;=3 &amp;&amp; islogical(overloadPublish)
        PUBLISH_OVERLOAD_FOLDER_NAME = <span class="string">'publish overload'</span>;
        ERROR_MSG_START = <span class="string">'Not installed correctly. In the folder that contains the prettify_MATLAB_html.m file, there should be a '</span>;
        <span class="keyword">if</span> ~exist([my_path PUBLISH_OVERLOAD_FOLDER_NAME],<span class="string">'dir'</span>), error([ERROR_MSG_START <span class="string">'folder named "'</span> PUBLISH_OVERLOAD_FOLDER_NAME <span class="string">'"'</span>]); <span class="keyword">end</span>
        pathList     = strsplit(path,<span class="string">':'</span>);
        overloadPath = pathList(cellfun(@(str)contains(str,PUBLISH_OVERLOAD_FOLDER_NAME),pathList));
        <span class="keyword">if</span> ~isempty(overloadPath)
            <span class="keyword">for</span> i=1:length(overloadPath)
                overloadPath{i} = strsplit(overloadPath{i},<span class="string">';'</span>);
                overloadPath{i} = overloadPath{i}{1};
                rmpath(overloadPath{i});
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> overloadPublish
            save_publish_handle;
            <span class="keyword">if</span> ~isempty(overloadPath), <span class="keyword">for</span> i=1:length(overloadPath), addpath(overloadPath{i}); <span class="keyword">end</span>
            <span class="keyword">else</span>                                                   , addpath([my_path PUBLISH_OVERLOAD_FOLDER_NAME]); <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> nargin == 3, <span class="keyword">return</span>; <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="13">Execute toolbar functions</h2><pre class="codeinput">    <span class="keyword">if</span> nargin==4
        <span class="keyword">if</span> islogical(addCommandsToToolbar) &amp;&amp; addCommandsToToolbar
            add_pretty_commands_to_toolbar;
        <span class="keyword">elseif</span> ischar(addCommandsToToolbar)
            document = matlab.desktop.editor.getActive;
            <span class="keyword">if</span> isempty(document), <span class="keyword">return</span>, <span class="keyword">end</span>
            tagName = addCommandsToToolbar;
            <span class="keyword">switch</span> tagName
                <span class="keyword">case</span> {<span class="string">'[dtls]'</span>,<span class="string">'[smry]'</span>,<span class="string">'[cssClasses]'</span>}, wrap_text_in_tag(document, tagName);
                <span class="keyword">case</span> <span class="string">'target'</span>                          , insert_target(document);
                <span class="keyword">case</span> <span class="string">'jumpto'</span>                          , jumpton_wrap(document);
                <span class="keyword">case</span> <span class="string">'class'</span>                           , class_wrap(document);
                <span class="keyword">case</span> <span class="string">'scale'</span>                           , wrap_text_in_tag(document, <span class="string">'[scale'</span>, <span class="string">'x'</span>);
                <span class="keyword">case</span> <span class="string">'colour'</span>                          , colour_wrap(document);
                <span class="keyword">case</span> <span class="string">'table'</span>                           , insert_table(document);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">return</span>
    <span class="keyword">end</span>
</pre><h2 id="14">Some input checking</h2><pre class="codeinput">    assert(ischar(inputhtmlFile),[<span class="string">'ERROR: First input to prettify_MATLAB_html should be a character vector specifying '</span><span class="keyword">...</span>
                                  <span class="string">'the html file to be processed, either by just file name, or by full path.'</span> NL HELP_URL NL]);
    <span class="keyword">if</span> nargin &lt; 2 || ~islogical(verbose), verbose = true; <span class="keyword">end</span>
    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'\nReading input file...\n'</span>); <span class="keyword">end</span>
    fInfo = dir(inputhtmlFile);
    assert(~isempty(fInfo),[<span class="string">'ERROR: Specified html file could not be found. Make sure the html file '</span><span class="keyword">...</span>
                            <span class="string">'is in the present working directory, or otherwise on the MATLAB path'</span>]);
</pre><h2 id="15">Open input file</h2><pre class="codeinput">    fstrm = read_file_to_mem(inputhtmlFile);
    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'Processing:\n'</span>); <span class="keyword">end</span>
</pre><h2 id="16">Find [cssClass] tags</h2><pre class="codeinput">    [fstrm, classNames, userCSS] = process_cssClasses_tags(fstrm);
    <span class="comment">% add built-in classes as valid class names (not done in process_cssClasses_tags so as not to pollute class list when "class" Toolbar button is used)</span>
    classNames     = [classNames {<span class="string">'codeinput'</span>, <span class="string">'codeoutput'</span>, <span class="string">'error'</span>, <span class="string">'keyword'</span>, <span class="string">'comment'</span>, <span class="string">'string'</span>, <span class="string">'untermstring'</span>, <span class="string">'syscmd'</span>}];
</pre><h2 id="17">Themes</h2><pre class="codeinput">    themeSwitchPos = strfind(fstrm,<span class="string">'&lt;div class="content"&gt;'</span>);
    assert (~isempty(themeSwitchPos), NO_START_ERR);
    themeSwitchPos = themeSwitchPos(1) + 20;
    <span class="keyword">if</span> ~strcmp(char(fstrm(themeSwitchPos+1:themeSwitchPos+4)),<span class="string">'&lt;h1&gt;'</span>) <span class="keyword">...</span>
    || strcmp(char(fstrm(themeSwitchPos+1:themeSwitchPos+9)),<span class="string">'&lt;h1&gt;&lt;/h1&gt;'</span>), extraStr = <span class="string">'&lt;div&gt;&amp;nbsp;&lt;/div&gt;'</span>; <span class="comment">%#ok&lt;ALIGN&gt;</span>
    <span class="keyword">else</span>                                                                 , extraStr = <span class="string">''</span>                 ; <span class="keyword">end</span>
    themeSwitch    = <span class="string">''</span>;
    <span class="keyword">if</span> contains(char(fstrm),<span class="string">'[themesEnabled]'</span>)
        classNames     = [classNames {<span class="string">'show-if-light'</span>, <span class="string">'show-if-dark'</span>}];
        themeSwitch    = [<span class="string">'&lt;div&gt;&lt;p onclick="toggle_theme()" style="text-align:right; float:right; padding-left:10px; margin:0;"&gt;'</span><span class="keyword">...</span>
                          <span class="string">'&lt;a href="javascript:void(0);" id="ToggleTheme"&gt;&amp;nbsp;&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;'</span><span class="keyword">...</span>
                          <span class="string">'&lt;script&gt;set_theme(null)&lt;/script&gt;'</span> extraStr];
        fstrm = [fstrm(1:themeSwitchPos) themeSwitch fstrm(themeSwitchPos+1:end)];
        fstrm = strrep(fstrm,<span class="string">'[themesEnabled]'</span>,<span class="string">''</span>);
    <span class="keyword">else</span>
        fstrm = [fstrm(1:themeSwitchPos) <span class="string">'&lt;script&gt;document.getElementById("dark-theme").sheet.disabled = true;&lt;/script&gt;'</span> fstrm(themeSwitchPos+1:end)];
    <span class="keyword">end</span>
</pre><h2 id="18">Define extra css</h2><pre class="codeinput">    extraCSS = [userCSS NL <span class="keyword">...</span>
                <span class="string">'#tooltiptext {'</span> NL <span class="keyword">...</span>
                <span class="string">'  visibility: hidden;'</span> NL <span class="keyword">...</span>
                <span class="string">'  padding: 5px 10px;'</span> NL <span class="keyword">...</span>
                <span class="string">'  font-size: 75%;'</span> NL <span class="keyword">...</span>
                <span class="string">'  line-height:110%;'</span> NL <span class="keyword">...</span>
                <span class="string">'  text-align: center;'</span> NL <span class="keyword">...</span>
                <span class="string">'  background-color: black;'</span> NL <span class="keyword">...</span>
                <span class="string">'  color: #ddd;'</span> NL <span class="keyword">...</span>
                <span class="string">'  border-radius: 6px;'</span> NL <span class="keyword">...</span>
                <span class="string">'  position: fixed;'</span> NL <span class="keyword">...</span>
                <span class="string">'  bottom: 11px;'</span> NL <span class="keyword">...</span>
                <span class="string">'  right: 62px;'</span> NL <span class="keyword">...</span>
                <span class="string">'  z-index: 2;'</span> NL <span class="keyword">...</span>
                <span class="string">'}'</span> NL <span class="keyword">...</span>
                <span class="string">'#tooltiptext::after {'</span> NL <span class="keyword">...</span>
                <span class="string">'  content: " ";'</span> NL <span class="keyword">...</span>
                <span class="string">'  position: absolute;'</span> NL <span class="keyword">...</span>
                <span class="string">'  top: 50%;'</span> NL <span class="keyword">...</span>
                <span class="string">'  left: 100%;'</span> NL <span class="keyword">...</span>
                <span class="string">'  margin-top: -5px;'</span> NL <span class="keyword">...</span>
                <span class="string">'  border-width: 5px;'</span> NL <span class="keyword">...</span>
                <span class="string">'  border-style: solid;'</span> NL <span class="keyword">...</span>
                <span class="string">'  border-color: transparent transparent transparent black;'</span> NL <span class="keyword">...</span>
                <span class="string">'}'</span> NL <span class="keyword">...</span>
                <span class="string">'.tooltip:hover #tooltiptext {'</span> NL <span class="keyword">...</span>
                <span class="string">'  visibility: visible;'</span> NL <span class="keyword">...</span>
                <span class="string">'}'</span> NL <span class="keyword">...</span>
                <span class="string">'#return-link {'</span> NL <span class="keyword">...</span>
                <span class="string">'    position: fixed;'</span> NL <span class="keyword">...</span>
                <span class="string">'    bottom: 10px;'</span> NL <span class="keyword">...</span>
                <span class="string">'    right: 10px;'</span> NL <span class="keyword">...</span>
                <span class="string">'    overflow: visible;'</span> NL <span class="keyword">...</span>
                <span class="string">'    font-size:120%;'</span> NL <span class="keyword">...</span>
                <span class="string">'    background: rgba(0, 0, 0, 0.75);'</span> NL <span class="keyword">...</span>
                <span class="string">'    border-style: solid;'</span> NL <span class="keyword">...</span>
                <span class="string">'    border-width: 3pt;'</span> NL <span class="keyword">...</span>
                <span class="string">'    border-color: #202020;'</span> NL <span class="keyword">...</span>
                <span class="string">'    border-radius: 4px;'</span> NL <span class="keyword">...</span>
                <span class="string">'    cursor: pointer;'</span> NL <span class="keyword">...</span>
                <span class="string">'    }'</span> NL <span class="keyword">...</span>
                <span class="string">'#return-link &gt; p { padding:3px; margin:0; color:#C0C0C0;}'</span> NL <span class="keyword">...</span>
                <span class="string">'.MATLAB-Help {'</span> NL <span class="keyword">...</span>
                <span class="string">'width: 100%;'</span> NL <span class="keyword">...</span>
                <span class="string">'margin-bottom: 12px;'</span> NL <span class="keyword">...</span>
                <span class="string">'border: 1px solid #ccc;'</span> NL <span class="keyword">...</span>
                <span class="string">'border-right: none;'</span> NL <span class="keyword">...</span>
                <span class="string">'border-bottom: none;'</span> NL <span class="keyword">...</span>
                <span class="string">'font-size: 96%;'</span> NL <span class="keyword">...</span>
                <span class="string">'line-height: 1.4;'</span> NL <span class="keyword">...</span>
                <span class="string">'table-layout: fixed;'</span> NL <span class="keyword">...</span>
                <span class="string">'overflow:hidden;}'</span> NL <span class="keyword">...</span>
                NL <span class="keyword">...</span>
                <span class="string">'.MATLAB-Help &gt; thead &gt; tr &gt; th {'</span> NL <span class="keyword">...</span>
                <span class="string">'padding: 6px 5px;'</span> NL <span class="keyword">...</span>
                <span class="string">'border: none;'</span> NL <span class="keyword">...</span>
                <span class="string">'border-right: 1px solid #ccc;'</span> NL <span class="keyword">...</span>
                <span class="string">'border-bottom: 1px solid #ccc;'</span> NL <span class="keyword">...</span>
                <span class="string">'background: #F2F2F2;'</span> NL <span class="keyword">...</span>
                <span class="string">'color: #000;'</span> NL <span class="keyword">...</span>
                <span class="string">'font-weight: bold;'</span> NL <span class="keyword">...</span>
                <span class="string">'text-align: left;'</span> NL <span class="keyword">...</span>
                <span class="string">'vertical-align: middle;}'</span> NL <span class="keyword">...</span>
                NL <span class="keyword">...</span>
                <span class="string">'.MATLAB-Help td{padding: 5px 5px;'</span> NL <span class="keyword">...</span>
                <span class="string">'border: none;'</span> NL <span class="keyword">...</span>
                <span class="string">'border-right: 1px solid #ccc;'</span> NL <span class="keyword">...</span>
                <span class="string">'border-bottom: 1px solid #ccc;'</span> NL <span class="keyword">...</span>
                <span class="string">'vertical-align: middle;}'</span> NL <span class="keyword">...</span>
                NL<span class="keyword">...</span>
                <span class="string">'.language-matlab { line-height:135% }'</span> NL NL<span class="keyword">...</span>
                <span class="string">'.collapse-link {float:right; line-height:200%; padding-left:10px; margin:0}'</span> NL NL <span class="keyword">...</span>
                NL <span class="keyword">...</span>
                <span class="string">'details &gt; summary,'</span> NL <span class="keyword">...</span>
                <span class="string">'.details-div {'</span> NL <span class="keyword">...</span>
                <span class="string">'  padding: 8px 20px;'</span> NL <span class="keyword">...</span>
                <span class="string">'  border-style: solid;'</span> NL <span class="keyword">...</span>
                <span class="string">'  border-width: 1.2pt;'</span> NL <span class="keyword">...</span>
                <span class="string">'  border-color: #E0E0E0;'</span> NL <span class="keyword">...</span>
                <span class="string">'}'</span> NL <span class="keyword">...</span>
                <span class="string">'details &gt; summary {'</span> NL <span class="keyword">...</span>
                <span class="string">'  border-radius:6px 6px 0 0;'</span> NL <span class="keyword">...</span>
                <span class="string">'  background-color: #F2F2F2;'</span> NL <span class="keyword">...</span>
                <span class="string">'  cursor: pointer;'</span> NL <span class="keyword">...</span>
                <span class="string">'}'</span> NL <span class="keyword">...</span>
                <span class="string">'.details-div {'</span> NL <span class="keyword">...</span>
                <span class="string">'  border-top-style: none;'</span> NL <span class="keyword">...</span>
                <span class="string">'  border-radius: 0 0 6px 6px;'</span> NL <span class="keyword">...</span>
                <span class="string">'}'</span> NL <span class="keyword">...</span>
                <span class="string">'.image-fit-svg,'</span> NL <span class="keyword">...</span>
                <span class="string">'.image-fit {'</span> NL <span class="keyword">...</span>
                <span class="string">'    max-width:  95%;'</span> NL <span class="keyword">...</span>
                <span class="string">'    max-height: 100%;'</span> NL <span class="keyword">...</span>
                <span class="string">'    margin:     auto;'</span> NL <span class="keyword">...</span>
                <span class="string">'}'</span> NL <span class="keyword">...</span>
                <span class="string">'.image-fit-svg{ padding:0px; max-width:500px; }'</span> NL <span class="keyword">...</span>
                <span class="string">'details &gt; img.image-fit-svg{ padding: 0px 0px 10px; }'</span> NL <span class="keyword">...</span>
                <span class="string">'@media (max-width: 580px) {'</span> NL <span class="keyword">...</span>
                <span class="string">'  .image-fit-svg { max-width: 95%; }'</span> NL <span class="keyword">...</span>
                <span class="string">'}'</span> NL <span class="keyword">...</span>
                <span class="string">'.pretty-link  { color:#001188 !important; }'</span> NL
                ];
    darkTheme = [NL <span class="string">'&lt;style id="dark-theme"&gt;'</span> NL <span class="keyword">...</span>
                <span class="string">'    h2, h3       { color: #B0B0B0; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    html body    { background-color: #101010; color: #B0B0B0; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    .pretty-link { color: #C46313 !important; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    a, a:visited { color: #C46313 }'</span> NL <span class="keyword">...</span>
                <span class="string">'    a:hover      { color: orange; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    details &gt; summary,'</span> NL <span class="keyword">...</span>
                <span class="string">'    .details-div      { border-color:     #505050; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    details &gt; summary { background-color: #202020; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    pre.codeinput     { border-width: 1.2pt; border-color:#001B33; background:#001129; color:#F0F0F0; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    pre.codeoutput    { color:#A5A5A5; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    span.keyword      { color:#FF9D00; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    span.comment      { color:#808080; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    span.string       { color:#3AD900; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    span.untermstring { color:#FFEE80; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    span.syscmd       { color:#CCCCCC; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    .MATLAB-Help, .MATLAB-Help &gt; thead &gt; tr &gt; th, .MATLAB-Help td { border-color:#505050; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    .MATLAB-Help &gt; thead &gt; tr &gt; th { background: #202020; color: #B0B0B0; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    .summary-sub-heading { color:#909090; }'</span> NL <span class="keyword">...</span>
                <span class="string">'    .show-if-light    { display:none }'</span> NL <span class="keyword">...</span>
                <span class="string">'&lt;/style&gt;'</span> NL <span class="keyword">...</span>
                <span class="string">'&lt;style id="hide-dark"&gt;'</span> NL <span class="keyword">...</span>
                <span class="string">'     .show-if-dark { display:none }'</span> NL <span class="keyword">...</span>
                <span class="string">'&lt;/style&gt;'</span><span class="keyword">...</span>
                NL];
    jumpShift = [NL <span class="string">'&lt;style id="anchor-offsets"&gt;'</span> NL <span class="keyword">...</span>
                <span class="string">'    h2::before, a[id]::before{'</span> NL <span class="keyword">...</span>
                <span class="string">'    content: "";'</span> NL <span class="keyword">...</span>
                <span class="string">'    display: block;'</span> NL <span class="keyword">...</span>
                <span class="string">'    height: 100px;'</span> NL <span class="keyword">...</span>
                <span class="string">'    margin: -100px 0 0;'</span> NL <span class="keyword">...</span>
                <span class="string">'    visibility: hidden;'</span> NL <span class="keyword">...</span>
                <span class="string">'    width:10%;'</span> NL <span class="keyword">...</span>
                <span class="string">'    z-index: -1;'</span> NL <span class="keyword">...</span>
                <span class="string">'}'</span> NL <span class="keyword">...</span>
                <span class="string">'&lt;/style&gt;'</span> <span class="keyword">...</span>
                NL];
</pre><h2 id="19">Define javascript</h2><pre class="codeinput">    javaScript =   [<span class="string">'&lt;script&gt;'</span> NL <span class="keyword">...</span>
                    <span class="string">'          var returnElem = null;'</span> NL <span class="keyword">...</span>
                    <span class="string">'          var skipCheck  = false;'</span> NL NL <span class="keyword">...</span>
                    <span class="string">'          function hide_back_link()'</span> NL <span class="keyword">...</span>
                    <span class="string">'          {'</span> NL <span class="keyword">...</span>
                    <span class="string">'              returnButton.style.display = "none";'</span> NL <span class="keyword">...</span>
                    <span class="string">'              try{'</span> NL <span class="keyword">...</span>
                    <span class="string">'                 window.removeEventListener("scroll", update_back_position, true);'</span> NL <span class="keyword">...</span>
                    <span class="string">'                 window.removeEventListener("resize", update_back_position, true);'</span> NL <span class="keyword">...</span>
                    <span class="string">'                 parent.window.removeEventListener("scroll", update_back_position, true);'</span> NL <span class="keyword">...</span>
                    <span class="string">'                 parent.window.removeEventListener("resize", update_back_position, true);}'</span> NL <span class="keyword">...</span>
                    <span class="string">'              catch(e){}'</span> NL <span class="keyword">...</span>
                    <span class="string">'          }'</span> NL NL <span class="keyword">...</span>
                    <span class="string">'          function get_offset(element)'</span> NL <span class="keyword">...</span>
                    <span class="string">'          {'</span> NL <span class="keyword">...</span>
                    <span class="string">'              if (!element.getClientRects().length){ return { top: 0, left: 0 }; }'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var rect = element.getBoundingClientRect();'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var win  = element.ownerDocument.defaultView;'</span> NL <span class="keyword">...</span>
                    <span class="string">'              return ( {top:  rect.top  + win.pageYOffset,'</span> NL <span class="keyword">...</span>
                    <span class="string">'                        left: rect.left + win.pageXOffset} );'</span> NL <span class="keyword">...</span>
                    <span class="string">'          }'</span> NL NL <span class="keyword">...</span>
                    <span class="string">'          function jump_to()'</span> NL <span class="keyword">...</span>
                    <span class="string">'          {'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var clickedElem = event.target;'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var clickedID   = clickedElem.closest("span");'</span> NL <span class="keyword">...</span>
                    <span class="string">'              if (clickedID){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                clickedID = clickedID.getAttribute("id");'</span> NL <span class="keyword">...</span>
                    <span class="string">'                if (clickedID.localeCompare("jump-close")===0) { return };}'</span> NL <span class="keyword">...</span>
                    <span class="string">'              clickedID = clickedElem.closest("div").getAttribute("id");'</span> NL <span class="keyword">...</span>
                    <span class="string">'              if (clickedID &amp;&amp; clickedID.localeCompare("return-link")===0)'</span> NL <span class="keyword">...</span>
                    <span class="string">'              {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  if (returnElem)'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      event.preventDefault();'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      hide_back_link();'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      returnElem.scrollIntoView();'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      if (contentDiv.getAttribute("data-isHelpBrowser")){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                         contentDiv.scrollTop = contentDiv.scrollTop-100; }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      if (contentDiv.getAttribute("data-isMATLABCentral")){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                         parent.window.scrollBy(0,-100)}'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      returnElem = null;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  }'</span> NL <span class="keyword">...</span>
                    <span class="string">'              }'</span> NL <span class="keyword">...</span>
                    <span class="string">'              else'</span> NL <span class="keyword">...</span>
                    <span class="string">'              {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  var href = clickedElem.closest("a").getAttribute("href");'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  if ( href &amp;&amp; href[0] == "#" )'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                     var target = document.getElementById(href.substring(1));'</span> NL <span class="keyword">...</span>
                    <span class="string">'                     var enclosingBox = target;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                     while ( enclosingBox )'</span> NL <span class="keyword">...</span>
                    <span class="string">'                     {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                        prevBox      = enclosingBox;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                        enclosingBox = enclosingBox.closest("details");'</span> NL <span class="keyword">...</span>
                    <span class="string">'                        if ( enclosingBox===prevBox ){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                           enclosingBox = enclosingBox.parentElement'</span> NL <span class="keyword">...</span>
                    <span class="string">'                           if ( enclosingBox ) { enclosingBox = enclosingBox.closest("details"); }  }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                        if (enclosingBox &amp;&amp; !enclosingBox.open) { open_details(enclosingBox.id) }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                     }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                     if (target &amp;&amp; in_iFrame() &amp;&amp; !contentDiv.getAttribute("data-isHelpBrowser") ){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                        event.preventDefault();'</span> NL <span class="keyword">...</span>
                    <span class="string">'                        target.scrollIntoView(); }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                     var nextElem = target.nextElementSibling;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                     var nextNode = target.nextSibling;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                     while ( nextNode &amp;&amp; nextNode.nodeType==Node.TEXT_NODE &amp;&amp; nextNode.data.trim().length == 0 ){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                        nextNode = nextNode.nextSibling;}'</span> NL <span class="keyword">...</span>
                    <span class="string">'                     if ( nextElem &amp;&amp; nextElem===nextNode &amp;&amp; nextElem.localName.localeCompare("details")===0 &amp;&amp; '</span><span class="keyword">...</span>
                                                                                                                                    <span class="string">'!nextElem.open){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                        open_details(nextElem.id);}'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  else { return }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  if (!contentDiv.getAttribute("data-isHelpBrowser"))'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      update_back_position();'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      returnButton.style.display = "block";'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      var linkTop   = clickedElem.offsetTop;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      var targetTop = target.offsetTop;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      if (targetTop&gt;linkTop){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                          document.getElementById("down").style.display = "none";'</span> NL <span class="keyword">...</span>
                    <span class="string">'                          document.getElementById("up").style.display   = "inline"; }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      else{'</span> NL <span class="keyword">...</span>
                    <span class="string">'                          document.getElementById("up").style.display   = "none";'</span> NL <span class="keyword">...</span>
                    <span class="string">'                          document.getElementById("down").style.display = "inline"; }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      returnElem = clickedElem;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  }'</span> NL <span class="keyword">...</span>
                    <span class="string">'              }'</span> NL <span class="keyword">...</span>
                    <span class="string">'          }'</span> NL NL <span class="keyword">...</span>
                    <span class="string">'          function open_details(detailsID)'</span> NL <span class="keyword">...</span>
                    <span class="string">'          {'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var details  = document.getElementById(detailsID);'</span> NL <span class="keyword">...</span>
                    <span class="string">'              skipCheck    = true;'</span> NL <span class="keyword">...</span>
                    <span class="string">'              state_check(details.id);'</span> NL <span class="keyword">...</span>
                    <span class="string">'              details.open = true;'</span> NL <span class="keyword">...</span>
                    <span class="string">'          }'</span> NL NL <span class="keyword">...</span>
                    <span class="string">'          function update_back_position()'</span> NL <span class="keyword">...</span>
                    <span class="string">'          {'</span> NL <span class="keyword">...</span>
                    <span class="string">'              try'</span> NL <span class="keyword">...</span>
                    <span class="string">'              {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  window.addEventListener("scroll", update_back_position, true);'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  window.addEventListener("resize", update_back_position, true);'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  var scrollPos;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  if (in_iFrame())'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      parent.window.addEventListener("scroll", update_back_position, true);'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      parent.window.addEventListener("resize", update_back_position, true);'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      var iFrame         = window.frameElement;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      var frameOffset    = get_offset(iFrame);'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      var documentBottom = parent.window.innerHeight  + parent.window.scrollY;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      var extHeight      = Math.round(frameOffset.top + iFrame.getBoundingClientRect().height - documentBottom);'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      if (extHeight&lt;0) { extHeight = 0; }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      returnButton.style.bottom = (10+extHeight) + "px";'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      document.getElementById("tooltiptext").style.bottom = (11+extHeight) + "px";'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      scrollPos = contentDiv.scrollTop - 25 + iFrame.getBoundingClientRect().height - extHeight;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  else{'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      scrollPos = window.scrollY + window.innerHeight - 25;}'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  if (returnElem.offsetTop&gt;scrollPos){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      document.getElementById("down").style.display = "inline";'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      document.getElementById("up").style.display   = "none";   }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  else{'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      document.getElementById("down").style.display = "none";'</span> NL <span class="keyword">...</span>
                    <span class="string">'                      document.getElementById("up").style.display   = "inline"; }'</span> NL <span class="keyword">...</span>
                    <span class="string">'              }'</span> NL <span class="keyword">...</span>
                    <span class="string">'              catch(e){}'</span> NL <span class="keyword">...</span>
                    <span class="string">'          }'</span> NL <span class="keyword">...</span>
                    <span class="string">'          function set_theme(themePref)'</span> NL <span class="keyword">...</span>
                    <span class="string">'          {'</span> NL <span class="keyword">...</span>
                    <span class="string">'            var themeSwitch     = document.getElementById("ToggleTheme");'</span> NL <span class="keyword">...</span>
                    <span class="string">'            var themeSwitchText = "switch to";'</span> NL <span class="keyword">...</span>
                    <span class="string">'            var switchToText    = null;'</span> NL <span class="keyword">...</span>
                    <span class="string">'            if (!themePref){ themePref = get_theme_pref(); }'</span> NL <span class="keyword">...</span>
                    <span class="string">'            if (themePref.localeCompare("light")===0){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                document.getElementById("dark-theme").sheet.disabled = true;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                document.getElementById("hide-dark").sheet.disabled  = false;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                switchToText = " dark theme";}'</span> NL <span class="keyword">...</span>
                    <span class="string">'            else{'</span> NL <span class="keyword">...</span>
                    <span class="string">'                document.getElementById("dark-theme").sheet.disabled = false;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                document.getElementById("hide-dark").sheet.disabled  = true;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                switchToText = " light theme";}'</span> NL <span class="keyword">...</span>
                    <span class="string">'            themeSwitch.innerHTML = themeSwitchText + switchToText;'</span> NL <span class="keyword">...</span>
                    <span class="string">'            set_theme_pref(themePref);'</span> NL <span class="keyword">...</span>
                    <span class="string">'          }'</span> NL NL <span class="keyword">...</span>
                    <span class="string">'          function toggle_theme()'</span> NL <span class="keyword">...</span>
                    <span class="string">'          {'</span> NL <span class="keyword">...</span>
                    <span class="string">'            if (document.getElementById("dark-theme").sheet.disabled) { set_theme("dark");  }'</span> NL <span class="keyword">...</span>
                    <span class="string">'            else                                                      { set_theme("light"); }'</span> NL <span class="keyword">...</span>
                    <span class="string">'          }'</span> NL NL <span class="keyword">...</span>
                    <span class="string">'          function set_theme_pref(themePref)'</span> NL <span class="keyword">...</span>
                    <span class="string">'          {'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var d = new Date();'</span> NL <span class="keyword">...</span>
                    <span class="string">'              d.setTime(d.getTime() + (2*365*24*60*60*1000));'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var expires = "expires="+ d.toUTCString();'</span> NL <span class="keyword">...</span>
                    <span class="string">'              document.cookie = "themepref=" + themePref + ";" + expires + "path=/";'</span> NL <span class="keyword">...</span>
                    <span class="string">'              localStorage.setItem("PRETTY_THEME", themePref);'</span> NL <span class="keyword">...</span>
                    <span class="string">'          }'</span> NL <span class="keyword">...</span>
                    NL <span class="keyword">...</span>
                    <span class="string">'          function get_theme_pref() {'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var name = "themepref=";'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var decodedCookie = decodeURIComponent(document.cookie);'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var ca = decodedCookie.split('';'');'</span> NL <span class="keyword">...</span>
                    <span class="string">'              for(var i = 0; i &lt; ca.length; i++) {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                var c = ca[i];'</span> NL <span class="keyword">...</span>
                    <span class="string">'                while (c.charAt(0) == '' '') {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  c = c.substring(1);'</span> NL <span class="keyword">...</span>
                    <span class="string">'                }'</span> NL <span class="keyword">...</span>
                    <span class="string">'                if (c.indexOf(name) == 0) {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  return c.substring(name.length, c.length);'</span> NL <span class="keyword">...</span>
                    <span class="string">'                }'</span> NL <span class="keyword">...</span>
                    <span class="string">'              }'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var docTheme = localStorage.getItem("PRETTY_THEME");'</span> NL <span class="keyword">...</span>
                    <span class="string">'              if (docTheme) { return docTheme }'</span> NL <span class="keyword">...</span>
                    <span class="string">'              else          { return "light"  }'</span> NL <span class="keyword">...</span>
                    <span class="string">'          }'</span> NL <span class="keyword">...</span>
                    NL <span class="keyword">...</span>
                    <span class="string">'          function toggle_details(section)'</span> NL <span class="keyword">...</span>
                    <span class="string">'          {'</span> NL <span class="keyword">...</span>
                    <span class="string">'            var link;'</span> NL <span class="keyword">...</span>
                    <span class="string">'            var subSection;'</span> NL <span class="keyword">...</span>
                    <span class="string">'            var details;'</span> NL <span class="keyword">...</span>
                    <span class="string">'            var linkText;'</span> NL <span class="keyword">...</span>
                    <span class="string">'            var i;'</span> NL <span class="keyword">...</span>
                    <span class="string">'            var openState  = true;'</span> NL <span class="keyword">...</span>
                    <span class="string">'            var border     = "6px 6px 0 0;"'</span> NL <span class="keyword">...</span>
                    <span class="string">'            if (section===0)'</span> NL <span class="keyword">...</span>
                    <span class="string">'            {'</span> NL <span class="keyword">...</span>
                    <span class="string">'              link = document.getElementById("Toggle"+section.toString());'</span> NL <span class="keyword">...</span>
                    <span class="string">'              if (link.innerHTML.localeCompare("collapse all on page")===0){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  openState = false;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  border    = "6px;"'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  linkText  = "expand all";}'</span> NL <span class="keyword">...</span>
                    <span class="string">'              else{'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  linkText   = "collapse all";}'</span> NL <span class="keyword">...</span>
                    <span class="string">'              link.innerHTML = linkText + " on page";'</span> NL <span class="keyword">...</span>
                    <span class="string">'              for (i = 0; i &lt; allDetails.length; i++){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                 allDetails[i].open = openState;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                 allDetails[i].children[0].setAttribute( ''style'', "border-radius:"+border );'</span> NL <span class="keyword">...</span>
                    <span class="string">'                 link = document.getElementById("Toggle"+allDetails[i].id.split(".", 1));'</span> NL <span class="keyword">...</span>
                    <span class="string">'                 if (allDetails[i].id.charAt(0).localeCompare("0") &amp;&amp; link){link.innerHTML = linkText;}}'</span> NL <span class="keyword">...</span>
                    <span class="string">'            }'</span> NL <span class="keyword">...</span>
                    <span class="string">'            else'</span> NL <span class="keyword">...</span>
                    <span class="string">'            {'</span> NL <span class="keyword">...</span>
                    <span class="string">'               link = document.getElementById("Toggle"+section.toString());'</span> NL <span class="keyword">...</span>
                    <span class="string">'               subSection = 1;'</span> NL <span class="keyword">...</span>
                    <span class="string">'               if (link.innerHTML.localeCompare("collapse all")===0){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  openState      = false;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  border         = "6px;"'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  link.innerHTML = "expand all";}'</span> NL <span class="keyword">...</span>
                    <span class="string">'               else{'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  link.innerHTML = "collapse all";}'</span> NL <span class="keyword">...</span>
                    <span class="string">'               details = document.getElementById(section.toString()+"."+subSection.toString());'</span> NL <span class="keyword">...</span>
                    <span class="string">'               while (details){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                    details.open = openState;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                    details.children[0].setAttribute( ''style'', "border-radius:"+border );'</span> NL <span class="keyword">...</span>
                    <span class="string">'                    subSection++;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                    details = document.getElementById(section.toString()+"."+subSection.toString());}'</span> NL <span class="keyword">...</span>
                    <span class="string">'               var allCollapsed = true;'</span> NL <span class="keyword">...</span>
                    <span class="string">'               var allExpanded  = true;'</span> NL <span class="keyword">...</span>
                    <span class="string">'               for (i = 0; i &lt; allDetails.length; i++){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                   check_if_open(allDetails[i]);}'</span> NL <span class="keyword">...</span>
                    <span class="string">'               link = document.getElementById("Toggle0");'</span> NL <span class="keyword">...</span>
                    <span class="string">'               if (allExpanded) {link.innerHTML = "collapse all on page";}'</span> NL <span class="keyword">...</span>
                    <span class="string">'               if (allCollapsed){link.innerHTML = "expand all on page";}'</span> NL <span class="keyword">...</span>
                    <span class="string">'            }'</span> NL <span class="keyword">...</span>
                    <span class="string">'            function check_if_open(details)'</span> NL <span class="keyword">...</span>
                    <span class="string">'            {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                if (details.open){allCollapsed = false;}'</span> NL <span class="keyword">...</span>
                    <span class="string">'                else             {allExpanded  = false;}'</span> NL <span class="keyword">...</span>
                    <span class="string">'            }'</span> NL <span class="keyword">...</span>
                    <span class="string">'          }'</span> NL NL <span class="keyword">...</span>
                    <span class="string">'          function state_check(detailsID)'</span> NL <span class="keyword">...</span>
                    <span class="string">'          {'</span> NL <span class="keyword">...</span>
                    <span class="string">'              // first deal with just the section'</span> NL <span class="keyword">...</span>
                    <span class="string">'              if (event.detail){document.activeElement.blur();}'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var clickedElem   = event.target;'</span> NL <span class="keyword">...</span>
                    <span class="string">'              if (!skipCheck &amp;&amp; clickedElem.localName.localeCompare("summary"))'</span> NL <span class="keyword">...</span>
                    <span class="string">'              { '</span> NL <span class="keyword">...</span>
                    <span class="string">'                if (!(clickedElem.closest("summary"))) { return };'</span> NL <span class="keyword">...</span>
                    <span class="string">'              };'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var details       = document.getElementById(detailsID);'</span> NL <span class="keyword">...</span>
                    <span class="string">'              if ( !skipCheck ) {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  var parentID  = clickedElem.closest("details").id;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  if (details.id.localeCompare(parentID)) { return };}'</span> NL <span class="keyword">...</span>
                    <span class="string">'              skipCheck         = false;'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var clickedStatus = details.open;'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var section       = detailsID.split(".", 1);'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var subSection    = 1;'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var allCollapsed  = true;'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var allExpanded   = true;'</span> NL <span class="keyword">...</span>
                    <span class="string">'              var link          = document.getElementById("Toggle"+section);'</span> NL <span class="keyword">...</span>
                    <span class="string">'              if (clickedStatus) { details.children[0].setAttribute( ''style'', "border-radius:6px;" ); }'</span> NL <span class="keyword">...</span>
                    <span class="string">'              else               { details.children[0].setAttribute( ''style'', "border-radius:6px 6px 0 0;" ); }'</span> NL <span class="keyword">...</span>
                    <span class="string">'              if (link)'</span> NL <span class="keyword">...</span>
                    <span class="string">'              {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  details = document.getElementById(section+"."+subSection.toString());'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  while (details){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                    check_if_open(details);'</span> NL <span class="keyword">...</span>
                    <span class="string">'                    subSection++;'</span> NL <span class="keyword">...</span>
                    <span class="string">'                    details = document.getElementById(section+"."+subSection.toString());}'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  if (allExpanded) {link.innerHTML = "collapse all";}'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  if (allCollapsed){link.innerHTML = "expand all";}'</span> NL <span class="keyword">...</span>
                    <span class="string">'              }'</span> NL <span class="keyword">...</span>
                    <span class="string">'              // then the whole page'</span> NL <span class="keyword">...</span>
                    <span class="string">'              allCollapsed   = true;'</span> NL <span class="keyword">...</span>
                    <span class="string">'              allExpanded    = true;'</span> NL <span class="keyword">...</span>
                    <span class="string">'              for (var i = 0; i &lt; allDetails.length; i++){'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  check_if_open(allDetails[i]);}'</span> NL <span class="keyword">...</span>
                    <span class="string">'              link = document.getElementById("Toggle0");'</span> NL <span class="keyword">...</span>
                    <span class="string">'              if (allExpanded) {link.innerHTML = "collapse all on page";}'</span> NL <span class="keyword">...</span>
                    <span class="string">'              if (allCollapsed){link.innerHTML = "expand all on page";}'</span> NL NL <span class="keyword">...</span>
                    <span class="string">'              function check_if_open(details)'</span> NL <span class="keyword">...</span>
                    <span class="string">'              {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  var openStatus'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  if (detailsID.localeCompare( details.id )===0 ){openStatus = !clickedStatus;}'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  else                                           {openStatus = details.open;}'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  if (openStatus){allCollapsed = false;}'</span> NL <span class="keyword">...</span>
                    <span class="string">'                  else           {allExpanded  = false;}'</span> NL <span class="keyword">...</span>
                    <span class="string">'              }'</span> NL <span class="keyword">...</span>
                    <span class="string">'          }'</span> NL <span class="keyword">...</span>
                    NL <span class="keyword">...</span>
                    <span class="string">'          function in_iFrame ()'</span> NL <span class="keyword">...</span>
                    <span class="string">'          {'</span> NL <span class="keyword">...</span>
                    <span class="string">'               try {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                   return window.self !== window.top;'</span> NL <span class="keyword">...</span>
                    <span class="string">'               } catch (e) {'</span> NL <span class="keyword">...</span>
                    <span class="string">'                   return true;'</span> NL <span class="keyword">...</span>
                    <span class="string">'               }'</span> NL <span class="keyword">...</span>
                    <span class="string">'          }'</span> NL <span class="keyword">...</span>
                    <span class="string">'&lt;/script&gt;'</span> NL];
</pre><h2 id="20">Insert extra css and javascript</h2><pre class="codeinput">    STYLE_CLOSE = <span class="string">'&lt;/style&gt;'</span>;
    cssClose    = strfind(fstrm,STYLE_CLOSE);
    cssClose    = cssClose(1);
    rewindCount = 0;
    <span class="keyword">while</span> fstrm(cssClose)~=NL, rewindCount = rewindCount+1; cssClose = cssClose-1; <span class="keyword">end</span>
    fstrm = [fstrm(1:cssClose-1+length(STYLE_CLOSE)+rewindCount) NL javaScript fstrm(cssClose+length(STYLE_CLOSE)+rewindCount:end)];
    fstrm = [fstrm(1:cssClose-1) extraCSS <span class="string">'&lt;/style&gt;'</span> darkTheme jumpShift fstrm(cssClose+length(STYLE_CLOSE)+rewindCount:end)];
</pre><h2 id="21">Fix/tweak publish's css</h2><pre class="codeinput">    fstrm = strrep(fstrm, <span class="string">'.content { font-size:1.2em; line-height:140%;'</span>, <span class="string">'.content { font-size:1.2em; line-height:160%;'</span>);
    fstrm = strrep(fstrm, <span class="string">'pre { margin:0px 0px 20px; }'</span>, <span class="string">'pre { margin:0px 0px 15px; overflow-x:auto; }'</span>);
    fstrm = strrep(fstrm, <span class="string">'pre, code { font-size:12px; }'</span>, <span class="string">'pre { font-size:12px; }'</span>);
    fstrm = strrep(fstrm, <span class="string">'tt { font-size: 1.2em; }'</span>,<span class="string">'code { font-size: 1.15em; }'</span>);
    fstrm = strrep(fstrm, <span class="string">'pre.codeoutput { padding:10px 11px; margin:0px 0px 20px;'</span>,<span class="string">'pre.codeoutput { padding:10px 11px; margin:0px 0px 15px;'</span>);
</pre><h2 id="22">html validation fixes</h2><pre class="codeinput">    fstrm = strrep(fstrm, [<span class="string">'&lt;!DOCTYPE html'</span> NL <span class="string">'  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"&gt;'</span>],<span class="string">'&lt;!DOCTYPE html&gt;'</span>);
    fstrm = strrep(fstrm, <span class="string">'&lt;html&gt;'</span>, <span class="string">'&lt;html lang="en"&gt;'</span>);
    fstrm = strrep(fstrm, <span class="string">'&lt;style type="text/css"&gt;'</span>,<span class="string">'&lt;style&gt;'</span>);
    fstrm = strrep(fstrm, <span class="string">':focus{outine:0}'</span>,<span class="string">''</span>);
    fstrm = strrep(fstrm, <span class="string">'&lt;tt'</span>,<span class="string">'&lt;code'</span>); fstrm = strrep(fstrm, <span class="string">'&lt;/tt&gt;'</span>,<span class="string">'&lt;/code&gt;'</span>);
</pre><h2 id="23">Insert floating "return" link</h2><pre class="codeinput">    fstrm = strrep(fstrm,<span class="string">'&lt;div class="content"&gt;'</span>,<span class="keyword">...</span>
                         [<span class="string">'&lt;div class="content"&gt;'</span> NL <span class="keyword">...</span>
                          <span class="string">'&lt;div id="return-link" style="display:none;" class="tooltip"&gt;'</span> NL <span class="keyword">...</span>
                          <span class="string">'&lt;p onclick="jump_to()"&gt;'</span> NL <span class="keyword">...</span>
                          <span class="string">'    &lt;span onclick="jump_to()"&gt;&lt;span id="up"&gt;&amp;#8679;&lt;/span&gt;&lt;span id="down"&gt;&amp;#8681;&lt;/span&gt;'</span> NL <span class="keyword">...</span>
                          <span class="string">'    &lt;span onclick="hide_back_link()" style="padding:2px; font-size:120%;" id="jump-close"&gt;'</span> <span class="keyword">...</span>
                              <span class="string">'&lt;b onclick="hide_back_link()"&gt;&amp;times;&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;'</span> NL <span class="keyword">...</span>
                          <span class="string">'&lt;/p&gt;'</span> NL <span class="keyword">...</span>
                          <span class="string">'&lt;div id="tooltiptext"&gt;click to return&lt;br&gt;(click &lt;b&gt;&amp;times;&lt;/b&gt; to hide)&lt;/div&gt;'</span> NL <span class="keyword">...</span>
                          <span class="string">'&lt;/div&gt;'</span>]);
</pre><h2 id="24">Find start and end of page body source</h2><pre class="codeinput">    [sourceStart, htmlEnd] = find_source(fstrm);
    <span class="keyword">if</span> DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), <span class="string">'input.html'</span>, 1); <span class="keyword">end</span>
</pre><h2 id="25">Move any <a href="style">style</a>&lt;/style&gt; section to before the body</h2><pre class="codeinput">    styleStart = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;style'</span>);
    <span class="keyword">if</span> ~isempty(styleStart)
        styleStart = styleStart + sourceStart - 1;
        styleEnd   = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;/style&gt;'</span>);
        assert(length(styleStart)==length(styleEnd),<span class="string">'ERROR: Imbalanced &lt;style&gt;&lt;/style&gt; tags; there are %i opening tags and %i closing tags'</span>, <span class="keyword">...</span>
                                                    length(styleStart), length(styleEnd));
        styleEnd = styleEnd + sourceStart - 1;
        <span class="keyword">for</span> i = 1:length(styleStart)
            sectionLength = 1+styleEnd(i)+7-styleStart(i);
            fstrm = [fstrm(1:sourceStart-1) fstrm(styleStart(i):styleEnd(i)+7) fstrm(sourceStart:end)];
            styleStart(i) = styleStart(i) + sectionLength;
            styleEnd(i)   = styleEnd(i)   + sectionLength;
            sourceStart   = sourceStart   + sectionLength;
            fstrm(styleStart(i):styleEnd(i)+7) = [];
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="26">Process [h2] tags</h2><pre class="codeinput">    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'   [h2] tags...\n'</span>); <span class="keyword">end</span>
    userHeadingCounter = 0;
    fstrm = strrep(fstrm,<span class="string">'[h2]'</span> ,<span class="string">'&lt;h2&gt;'</span> );
    fstrm = strrep(fstrm,<span class="string">'[/h2]'</span>,<span class="string">'&lt;/h2&gt;'</span>);
    userHeadings = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'[h2.CElink]'</span>);
    <span class="keyword">if</span> ~isempty(userHeadings)
        userHeadings = userHeadings + sourceStart - 1;
        <span class="keyword">for</span> i = 1:length(userHeadings)
            userHeadingCounter = userHeadingCounter+1;
            headingTag = [<span class="string">'&lt;h2 id="userHeading'</span> num2str(userHeadingCounter) <span class="string">'"&gt;'</span>];
            fstrm = [fstrm(1:userHeadings(i)-1) headingTag fstrm(userHeadings(i)+11:end)];
            userHeadings = userHeadings + length(headingTag)-11;
            htmlEnd      = htmlEnd      + length(headingTag)-11;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), <span class="string">'after processing [h2] tags.html'</span>, 1); <span class="keyword">end</span>
</pre><h2 id="27">Process [targetn] and [jumpton] tags</h2><pre class="codeinput">    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'   target and jump tags...\n'</span>); <span class="keyword">end</span>
    [fstrm, htmlEnd] = process_target_and_jump_tags(fstrm, htmlEnd);
    <span class="keyword">if</span> DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), <span class="string">'after processing internal links.html'</span>, 1); <span class="keyword">end</span>
</pre><h2 id="28">Process colour, scale, and class tags</h2><pre class="codeinput">    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'   colour, scale, and class tags...\n'</span>); <span class="keyword">end</span>
    tagList = {<span class="string">'colour'</span>,<span class="string">'scale'</span>,<span class="string">'class'</span>};
    validValList = {[],[],classNames};
    <span class="keyword">for</span> i = 1:length(tagList)
        tagName = tagList{i};
        [tagOpens, tagCloses] = get_tag_pairs([<span class="string">'['</span> tagName <span class="string">']'</span>], fstrm, htmlEnd);
        [fstrm, htmlEnd, tagOpens, tagCloses, vals, tagEnds] = find_valid_prettify_tags(tagName, tagOpens, tagCloses, validValList{i}, fstrm, htmlEnd);
        [fstrm, htmlEnd] = prettyTag2htmlTag(tagName, tagOpens, tagCloses, vals, tagEnds, fstrm, sourceStart, htmlEnd, DEBUG);
        <span class="keyword">if</span> DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), [<span class="string">'after processing '</span> tagName <span class="string">'.html'</span>], 1); <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="29">Find [dtls] and [smry] tags</h2><pre class="codeinput">    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'   dtls tags...\n'</span>); <span class="keyword">end</span>
    [detailsOpens, detailsCloses] = get_tag_pairs(<span class="string">'[dtls]'</span>, fstrm, htmlEnd);
    [summaryOpens, summaryCloses] = get_tag_pairs(<span class="string">'[smry]'</span>, fstrm, htmlEnd);
    assert(length(summaryOpens)==length(detailsOpens), <span class="string">'ERROR: Number of [smry] tags does not match the number of [dtls] tags'</span>);
    detailsTags = {detailsOpens, detailsCloses};
    wrapTags = {<span class="string">'&lt;span'</span>,<span class="string">'&lt;pre'</span>};
    <span class="keyword">for</span> i = 1:2
        <span class="keyword">if</span> i == 1, slash = <span class="string">''</span>;
        <span class="keyword">else</span>     , slash = <span class="string">'/'</span>; <span class="keyword">end</span>
        <span class="keyword">for</span> j = 1:length(detailsOpens)
            <span class="keyword">for</span> k = 1:length(wrapTags)
                wrapTag  = wrapTags{k};
                wrapIdxs = strfind(fstrm(sourceStart:detailsTags{i}(j)), wrapTag) + sourceStart - 1;
                <span class="keyword">if</span> ~isempty(wrapIdxs)
                    wrapIdxs = wrapIdxs(end);
                    <span class="keyword">if</span> ~contains(fstrm(wrapIdxs:detailsTags{i}(j)),[<span class="string">'&lt;/'</span> wrapTag(2:end) <span class="string">'&gt;'</span>])
                        <span class="keyword">if</span> k == 1, warnStr1 = <span class="string">'appears inside a comment section of'</span>;  warnStr2 = <span class="string">'forgotten a space'</span>;
                        <span class="keyword">else</span>     , warnStr1 = <span class="string">'is wrapped in &lt;pre&gt;...&lt;/pre&gt; tags in'</span>; warnStr2 = <span class="string">'put too many spaces'</span>; <span class="keyword">end</span>
                        show_warning(sprintf([<span class="string">'[%cdtls] tag %i %s the html document - this may cause an error.\n'</span> <span class="keyword">...</span>
                                              <span class="string">'Possibly you have forgotten to start a new section in the source .m file, or %s '</span>    <span class="keyword">...</span>
                                              <span class="string">'between the start-of-line "%%" and the [%cdtls] tag.'</span>], slash, j, warnStr1, warnStr2, slash));
                        <span class="keyword">break</span>
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    [countOfDtlsTags, detailsCloses] = sort_tag_closes(detailsOpens, detailsCloses);
    <span class="keyword">for</span> i = 1:countOfDtlsTags
        assert(summaryOpens (i)&gt;detailsOpens (i),<span class="string">'ERROR: [smry] tag %i opened before [dtls] tag %i'</span>, i, i);
        assert(summaryCloses(i)&lt;detailsCloses(i),<span class="string">'ERROR: [dtls] tag pair %i closed before [smry] tag pair %i'</span>, i, i);
    <span class="keyword">end</span>
    imgTags = [];
</pre><h2 id="30">Process [dtls] and [smry] tags</h2><pre class="codeinput">    <span class="keyword">if</span> ~isempty(detailsOpens)
</pre><pre class="codeinput">        dummySections        = 0;
        revertedCount        = false;
        revertAt             = 0;
        subSectionCounterBak = NaN;
        collapseAllStyle = <span class="string">'class="collapse-link"'</span>;
        collapseAllPos   = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;h2&gt;Contents&lt;/h2&gt;'</span>) + sourceStart - 1;
        noSections       = false;
        insertPoint      = detailsOpens(1)-1;
        <span class="keyword">if</span> isempty(collapseAllPos) || any(detailsOpens&lt;collapseAllPos(1))
            <span class="keyword">if</span> isempty(collapseAllPos), noSections = true; collapseAllPos=0; <span class="keyword">end</span>
            firstP = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;div class="content"&gt;'</span>) + sourceStart - 1;
            firstP = strfind(fstrm(firstP(1):htmlEnd),<span class="string">'&lt;p&gt;'</span>) + firstP(1) - 1;
            assert (~isempty(firstP),[NO_START_ERR <span class="string">' - is entire source .m file comment-only? Did you forget to start a section?'</span>]);
            <span class="keyword">if</span> isempty(themeSwitch)
                collapseAll = [<span class="string">'&lt;p style="margin:0px; line-height:0;"&gt;&amp;nbsp;&lt;/p&gt;&lt;p onclick="toggle_details(0)"'</span><span class="keyword">...</span>
                               <span class="string">' style="float:right; padding-left:10px; margin:0;"&gt;&lt;a href="javascript:void(0);" id="Toggle0"&gt;collapse all on page&lt;/a&gt;&lt;/p&gt;'</span>];
                fstrm       = strrep(fstrm,<span class="string">'&lt;script&gt;document.getElementById("dark-theme")'</span>,[collapseAll <span class="string">'&lt;script&gt;document.getElementById("dark-theme")'</span>]);
            <span class="keyword">else</span>
                newThemeSwitch = strrep(themeSwitch,[<span class="string">'&lt;p onclick="toggle_theme()" style="text-align:right; float:right; padding-left:10px; margin:0;"&gt;'</span><span class="keyword">...</span>
                                                     <span class="string">'&lt;a '</span>],<span class="keyword">...</span>
                                                    [<span class="string">'&lt;p style="text-align:right; float:right; padding-left:10px; margin:0;"&gt;&lt;span '</span> <span class="keyword">...</span>
                                                     <span class="string">'onclick="toggle_theme()" style="line-height:100%; padding-bottom:1px; border-bottom:1px '</span> <span class="keyword">...</span>
                                                     <span class="string">'solid #d6d4d4;"&gt;&lt;a '</span>]);
                newThemeSwitch = strrep(newThemeSwitch,<span class="string">'&lt;/a&gt;'</span>,<span class="string">'&lt;/a&gt;&lt;/span&gt;'</span>);
                fstrm          = strrep(fstrm,themeSwitch,newThemeSwitch);

                update_idxs(length(newThemeSwitch)-length(themeSwitch));
                collapseAll = <span class="string">'&lt;br&gt;&lt;span onclick="toggle_details(0)"&gt;&lt;a href="javascript:void(0);" id="Toggle0"&gt;collapse all on page&lt;/a&gt;&lt;/span&gt;&amp;nbsp;'</span>;
                fstrm       = strrep(fstrm,<span class="string">'&lt;/p&gt;&lt;/div&gt;&lt;script&gt;set_theme(null)&lt;/script&gt;'</span>,[collapseAll <span class="string">'&lt;/p&gt;&lt;/div&gt;&lt;script&gt;set_theme(null)&lt;/script&gt;'</span>]);
            <span class="keyword">end</span>
        <span class="keyword">else</span>
            collapseAllPos = collapseAllPos(1);
            collapseAll = [<span class="string">'&lt;p style="margin:0px; line-height:0;"&gt;&amp;nbsp;&lt;/p&gt;&lt;p onclick="toggle_details(0)" '</span> collapseAllStyle <span class="string">'&gt;'</span><span class="keyword">...</span>
                           <span class="string">'&lt;a href="javascript:void(0);" id="Toggle0"&gt;collapse all on page&lt;/a&gt;&lt;/p&gt;'</span>];
            fstrm = [fstrm(1:collapseAllPos-1) collapseAll fstrm(collapseAllPos:end)];
        <span class="keyword">end</span>
        update_idxs(length(collapseAll));
        collapseAllPos = collapseAllPos(1)+length(collapseAll);
        sectionsCounter   = 0;
        subSectionCounter = 1;
        detailsBeforeContents = detailsOpens&lt;collapseAllPos;
        <span class="keyword">for</span> detailsSectionCounter = 1:countOfDtlsTags
            <span class="keyword">if</span> revertAt &amp;&amp; detailsOpens(detailsSectionCounter)&gt;detailsCloses(revertAt)
                sectionsCounter      = sectionsCounterBak;
                subSectionCounter    = subSectionCounterBak;
                subSectionCounterBak = NaN;
                revertedCount        = true;
                revertAt             = 0;
            <span class="keyword">end</span>
            <span class="keyword">if</span> ~noSections
                <span class="keyword">if</span> detailsBeforeContents(detailsSectionCounter)
                    sectionsCounter=-1;
                    <span class="keyword">if</span> subSectionCounter==1
                        sectionCollapseState = [<span class="string">'&lt;div style="display:none;"&gt;&lt;p id="Toggle'</span> num2str(sectionsCounter) <span class="string">'"&gt;collapse all&lt;/p&gt;&lt;/div&gt;'</span>];
                        fstrm = [fstrm(1:detailsOpens(detailsSectionCounter)-1) sectionCollapseState fstrm(detailsOpens(detailsSectionCounter):end)];
                        insertPoint = detailsOpens(detailsSectionCounter)-1;
                        update_idxs(length(sectionCollapseState));
                    <span class="keyword">end</span>
                <span class="keyword">elseif</span> sectionsCounter==-1
                    sectionsCounter = 0;
                <span class="keyword">end</span>
            <span class="keyword">elseif</span> sectionsCounter == 0
                sectionsCounter = 1;
            <span class="keyword">end</span>
            <span class="keyword">if</span> detailsSectionCounter==1, headingSearchStart = 1;
            <span class="keyword">else</span>                       , headingSearchStart = detailsOpens(detailsSectionCounter-1); <span class="keyword">end</span>
            headingIdx = strfind( fstrm(headingSearchStart:detailsOpens(detailsSectionCounter)), <span class="string">'&lt;h2 id="'</span> );
            <span class="keyword">if</span> ~isempty(headingIdx)
                skipHeading = false;
                headingIdx  = headingSearchStart-1+headingIdx(end);
                idEnd       = strfind(fstrm(headingIdx+9:detailsOpens(detailsSectionCounter)),<span class="string">'"'</span>);
                <span class="keyword">if</span> isempty(idEnd), error(<span class="string">'ERROR: malformed &lt;h2&gt; tag (no closing " for id)'</span>); <span class="keyword">end</span>
                idEnd = idEnd(1) + headingIdx + 7;
                headingNum = str2double(fstrm(headingIdx+8:idEnd));
                <span class="keyword">if</span> isnan(headingNum), isDummySection = true;
                <span class="keyword">else</span>                , isDummySection = false; <span class="keyword">end</span>
                headingNestLevel = sum(headingIdx&lt;detailsCloses(1:detailsSectionCounter-1));
                <span class="keyword">if</span> detailsSectionCounter&gt;1 &amp;&amp; headingNestLevel
                    <span class="keyword">if</span> ~isDummySection
                        error(<span class="string">'ERROR: Section heading %i is inside a [dtls] box: this is not supported'</span>, headingNum);
                    <span class="keyword">elseif</span> headingNestLevel &gt; sum(detailsOpens(detailsSectionCounter)&lt;detailsCloses(1:detailsSectionCounter-1))
                        skipHeading = true;
                    <span class="keyword">elseif</span> ~noSections
                        revertAt = find(headingIdx&lt;detailsCloses(1:detailsSectionCounter-1),1,<span class="string">'last'</span>);
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
                <span class="keyword">if</span> ~skipHeading
                    sectionsCounter = sectionsCounter + 1;
                    <span class="keyword">if</span> ~isDummySection
                        subSectionCounterBak = NaN;
                    <span class="keyword">else</span>
                        <span class="keyword">if</span> isnan(subSectionCounterBak)
                            sectionsCounterBak   = sectionsCounter - 1;
                            subSectionCounterBak = subSectionCounter;
                        <span class="keyword">end</span>
                    <span class="keyword">end</span>
                    <span class="keyword">if</span> revertedCount, sectionsCounter = sectionsCounter + dummySections; <span class="keyword">end</span>
                    revertedCount = false;
                    subSectionCounter = 1;
                    headingClose  = strfind(fstrm(headingIdx:detailsOpens(detailsSectionCounter)),<span class="string">'&lt;/h2&gt;'</span>);
                    headingClose  = headingClose(1) + headingIdx - 1;
                    <span class="keyword">if</span> ~contains(fstrm(headingIdx:headingClose),<span class="string">'display:none'</span>)
                        sectionHeader     = [<span class="string">'&lt;p style="margin:0px; line-height:0;"&gt;&amp;nbsp;&lt;/p&gt;&lt;p onclick="toggle_details('</span> num2str(sectionsCounter)<span class="keyword">...</span>
                                             <span class="string">')" class="collapse-link"&gt;&lt;a href="javascript:void(0);" id="Toggle'</span> num2str(sectionsCounter) <span class="keyword">...</span>
                                             <span class="string">'"&gt;collapse all&lt;/a&gt;&lt;/p&gt;'</span>];
                        fstrm = [fstrm(1:headingIdx-1) sectionHeader fstrm(headingIdx:end)];
                        insertPoint = headingIdx-1;
                        update_idxs(length(sectionHeader));
                    <span class="keyword">end</span>
                    <span class="keyword">if</span> isDummySection, dummySections = dummySections+1; <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="comment">% &lt;p&gt;...[dtls] -&gt; ...[dtls][smry]...[/smry]&lt;p&gt;</span>
            <span class="comment">% look for unbalanced &lt;p&gt;&lt;/p&gt; tags before the [dtls] tag</span>
            pBeforeDtls = strfind(fstrm(sourceStart:detailsOpens(detailsSectionCounter)),<span class="string">'&lt;p'</span>) + sourceStart - 1;
            <span class="keyword">if</span> ~isempty(pBeforeDtls)
                closepBeforeDtls = strfind(fstrm(sourceStart:detailsOpens(detailsSectionCounter)),<span class="string">'&lt;/p&gt;'</span>) + sourceStart - 1;
                <span class="keyword">if</span> length(pBeforeDtls) &gt; length(closepBeforeDtls)
                    <span class="keyword">while</span> closepBeforeDtls(end)&gt;pBeforeDtls(end)
                        closepBeforeDtls(end) = [];
                        pBeforeDtls(end)      = [];
                    <span class="keyword">end</span>
                    <span class="comment">% move pBeforeDtls(end) to after the [/smry] tag associated with this [dtls] tag, but only if the pBeforeDtls is a plain "&lt;p&gt;"</span>
                    <span class="keyword">if</span> strcmp(fstrm(pBeforeDtls(end):pBeforeDtls(end)+2),<span class="string">'&lt;p&gt;'</span>)
                        fstrm(pBeforeDtls(end):pBeforeDtls(end)+2) = [];
                        detailsOpens ( detailsSectionCounter ) = detailsOpens ( detailsSectionCounter ) - 3;
                        summaryCloses( detailsSectionCounter ) = summaryCloses( detailsSectionCounter ) - 3;
                        fstrm = [fstrm(1:summaryCloses(detailsSectionCounter)+6) <span class="string">'&lt;p&gt;'</span> fstrm(summaryCloses(detailsSectionCounter)+7:end)];
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="comment">% [/dtls]...&lt;/p&gt; -&gt; [/dtls]&lt;p&gt;...&lt;/p&gt; + delete the previous &lt;p&gt;</span>
            <span class="comment">% or [/dtls]&lt;/p&gt; -&gt; [/dtls] + delete the previous &lt;p&gt;</span>
            closepAfterDtls = strfind(fstrm(detailsCloses(detailsSectionCounter):htmlEnd),<span class="string">'&lt;/p&gt;'</span>) + detailsCloses(detailsSectionCounter) - 1;
            <span class="keyword">if</span> ~isempty(closepAfterDtls)
                closepAfterDtls = closepAfterDtls(1);
                pAfterDtls      = strfind(fstrm(detailsCloses(detailsSectionCounter):htmlEnd),<span class="string">'&lt;p'</span>) + detailsCloses(detailsSectionCounter) - 1;
                <span class="keyword">if</span> isempty(pAfterDtls) || pAfterDtls(1)&gt;closepAfterDtls
                    <span class="keyword">if</span> strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+10),<span class="string">'&lt;/p&gt;'</span>)
                        fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+10) = [];
                        insertPoint = detailsCloses(detailsSectionCounter);
                        update_idxs(-4);
                    <span class="keyword">else</span>
                        fstrm = [fstrm(1:detailsCloses(detailsSectionCounter)+6) <span class="string">'&lt;p&gt;'</span> fstrm(detailsCloses(detailsSectionCounter)+7:end)];
                        insertPoint = detailsCloses(detailsSectionCounter);
                        update_idxs(3);
                    <span class="keyword">end</span>
                    pInDtls = strfind(fstrm(detailsOpens(detailsSectionCounter):detailsCloses(detailsSectionCounter)),<span class="string">'&lt;p&gt;'</span>);
                    <span class="keyword">if</span> ~isempty(pInDtls)
                        pInDtls = pInDtls(end) + detailsOpens(detailsSectionCounter) - 1;
                        fstrm(pInDtls:pInDtls+2) = [];
                        insertPoint = pInDtls;
                        update_idxs(-3);
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="comment">% [dtls] -&gt; &lt;details open onclick="state_check(&lt;ID&gt;)" id="&lt;ID&gt;"&gt;</span>
            detailsId     = [num2str(sectionsCounter) <span class="string">'.'</span> num2str(subSectionCounter)];
            detailsOpener = [<span class="string">'&lt;details open onclick="state_check('''</span> detailsId <span class="string">''')" id="'</span> detailsId <span class="string">'"&gt;'</span>];
            fstrm = [fstrm(1:detailsOpens(detailsSectionCounter)-1) detailsOpener fstrm(detailsOpens(detailsSectionCounter)+6:end)];
            insertPoint = detailsOpens(detailsSectionCounter)-1;
            update_idxs(length(detailsOpener)-6);
            <span class="comment">% [/dtls] -&gt; &lt;/div&gt;&lt;/details&gt;</span>
            addBreak = <span class="string">''</span>;
            <span class="comment">% add line break after [dtls] section, if necessary</span>
            <span class="keyword">if</span> ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+13),<span class="string">'&lt;p&gt;&lt;/p&gt;'</span>)                <span class="keyword">...</span>
            &amp;&amp; ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+14),<span class="string">'&lt;p&gt; &lt;/p&gt;'</span>)               <span class="keyword">...</span>
            &amp;&amp; ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+14),[<span class="string">'&lt;p&gt;'</span> char(160) <span class="string">'&lt;/p&gt;'</span>]) <span class="keyword">...</span>
            &amp;&amp; ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+24),<span class="string">'&lt;p class="footer"&gt;'</span>)     <span class="keyword">...</span>
            &amp;&amp; ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+12),<span class="string">'&lt;p&gt;&lt;br'</span>)                 <span class="keyword">...</span>
            &amp;&amp; ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+12),<span class="string">'&lt;p&gt;[br'</span>)                 <span class="keyword">...</span>
            &amp;&amp; ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+9) ,<span class="string">'&lt;br'</span>)                    <span class="keyword">...</span>
            &amp;&amp; ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+9) ,<span class="string">'[br'</span>)
                addBreak = <span class="string">'&lt;br&gt;'</span>;
            <span class="keyword">end</span>
            dtlsClose = [<span class="string">'&lt;/div&gt;&lt;/details&gt;'</span> addBreak];
            fstrm = [fstrm(1:detailsCloses(detailsSectionCounter)-1) dtlsClose fstrm(detailsCloses(detailsSectionCounter)+7:end)];
            insertPoint = detailsCloses(detailsSectionCounter)-1;
            update_idxs(length(dtlsClose)-7);
            subSectionCounter = subSectionCounter + 1;
            <span class="keyword">if</span> DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), [<span class="string">'after replacing [dtls] tag set '</span> num2str(detailsSectionCounter) <span class="string">'.html'</span>], 1); <span class="keyword">end</span>
        <span class="keyword">end</span>
        fstrm = strrep(fstrm,<span class="string">'[smry]'</span>,<span class="string">'&lt;summary&gt;'</span>);
        fstrm = strrep(fstrm,<span class="string">'[/smry]'</span>,<span class="string">'&lt;/summary&gt;&lt;div class="details-div"&gt;'</span>);
        <span class="keyword">if</span> DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), <span class="string">'after replacing [smry] tags.html'</span>, 1); <span class="keyword">end</span>
        insertPoint = detailsOpens(1)-1;
        update_idxs(31*countOfDtlsTags);
</pre><h2 id="32">&nbsp;&nbsp;&nbsp;&nbsp;Remove excess line breaks after any tables in details sections</h2><pre class="codeinput">        detailsOpens  = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;details open '</span>) + sourceStart - 1;
        detailsCloses = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;/details&gt;'</span>) + sourceStart - 1;
        [countOfDtlsTags, detailsCloses] = sort_tag_closes(detailsOpens, detailsCloses);
        <span class="keyword">for</span> detailsCounter = 1:countOfDtlsTags
            tableCloseIdxs = strfind(fstrm(detailsOpens(detailsCounter):detailsCloses(detailsCounter)),<span class="string">'&lt;/table&gt;'</span>)  + detailsOpens(detailsCounter) - 1;
            <span class="keyword">for</span> i = 1:length(tableCloseIdxs)
                brIdx = strfind(fstrm(tableCloseIdxs(i)+8:detailsCloses(detailsCounter)-5),<span class="string">'&lt;br&gt;'</span>);
                <span class="keyword">if</span> isempty(brIdx), <span class="keyword">continue</span>, <span class="keyword">end</span>
                brIdx = brIdx(1) + tableCloseIdxs(i) + 7;
                <span class="keyword">if</span> strcmp(sscanf( fstrm(tableCloseIdxs(i)+8:brIdx+3),<span class="string">'%s'</span> ),<span class="string">'&lt;br&gt;'</span>)
                    fstrm(brIdx:brIdx+3) = [];
                    tableCloseIdxs = tableCloseIdxs-4;
                    insertPoint    = brIdx;
                    update_idxs(-4);
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
</pre><h2 id="33">&nbsp;&nbsp;&nbsp;&nbsp;Remove excess spacing after any lists at the end of details sections</h2><pre class="codeinput">        <span class="keyword">for</span> listTag = {<span class="string">'ul'</span>,<span class="string">'ol'</span>}
            <span class="keyword">for</span> detailsCounter = 1:countOfDtlsTags
                listIdxs = strfind(fstrm(detailsOpens(detailsCounter):detailsCloses(detailsCounter)),[<span class="string">'&lt;'</span> listTag{:} <span class="string">'&gt;'</span>]);
                listIdxs = sort( [listIdxs strfind(fstrm(detailsOpens(detailsCounter):detailsCloses(detailsCounter)),[<span class="string">'&lt;'</span> listTag{:} <span class="string">' style="'</span>])] );
                <span class="keyword">if</span> ~isempty(listIdxs)
                    listIdxs   = listIdxs(end) + detailsOpens(detailsCounter) - 1;
                    listTagEnd = strfind(fstrm(listIdxs:detailsCloses(detailsCounter)),<span class="string">'&gt;'</span>);
                    listTagEnd = listTagEnd(1) + listIdxs - 1;
                    listEnd  = strfind(fstrm(listIdxs:detailsCloses(detailsCounter)),[<span class="string">'&lt;/'</span> listTag{:} <span class="string">'&gt;'</span>]) + listIdxs - 1;
                    <span class="keyword">if</span> ~isempty(listEnd) &amp;&amp; ~contains(fstrm(listIdxs:listTagEnd),<span class="string">'margin'</span>)
                        <span class="keyword">if</span> strcmp(fstrm(listEnd:detailsCloses(detailsCounter)),[<span class="string">'&lt;/'</span> listTag{:} <span class="string">'&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;'</span>]) <span class="keyword">...</span>
                        || strcmp(fstrm(listEnd:detailsCloses(detailsCounter)),[<span class="string">'&lt;/'</span> listTag{:} <span class="string">'&gt;&lt;/div&gt;&lt;/div&gt;&lt;'</span>]) <span class="keyword">...</span>
                        || strcmp(fstrm(listEnd:detailsCloses(detailsCounter)),[<span class="string">'&lt;/'</span> listTag{:} <span class="string">'&gt;&lt;/span&gt;&lt;/div&gt;&lt;'</span>]) <span class="keyword">...</span>
                        || strcmp(fstrm(listEnd:detailsCloses(detailsCounter)),[<span class="string">'&lt;/'</span> listTag{:} <span class="string">'&gt;&lt;/div&gt;&lt;'</span>])
                            <span class="keyword">if</span> fstrm(listIdxs+3)==<span class="string">'&gt;'</span>
                                fstrm = [fstrm(1:listIdxs+2) <span class="string">' style="margin-bottom:0px;"'</span> fstrm(listIdxs+3:end)];
                                insertPoint = listIdxs+2;
                                update_idxs(27);
                            <span class="keyword">else</span> <span class="comment">% &lt;ul style="blah -&gt; &lt;ul style="margin-bottome:0px; blah</span>
                                fstrm = [fstrm(1:listIdxs+10) <span class="string">'margin-bottom:0px; '</span> fstrm(listIdxs+11:end)];
                                insertPoint = listIdxs+10;
                                update_idxs(19);
                            <span class="keyword">end</span>
                        <span class="keyword">end</span>
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), <span class="string">'before adding breaks between tables and images.html'</span>, 1); <span class="keyword">end</span>
</pre><h2 id="34">&nbsp;&nbsp;&nbsp;&nbsp;Add breaks between tables and images</h2><pre class="codeinput">        <span class="keyword">for</span> detailsCounter = 1:countOfDtlsTags
            tableThenImage = strfind(fstrm(detailsOpens(detailsCounter):detailsCloses(detailsCounter)),<span class="string">'&lt;/table&gt;&lt;img '</span>)  + detailsOpens(detailsCounter) - 1;
            <span class="keyword">for</span> i = 1:length(tableThenImage)
                fstrm = [fstrm(1:tableThenImage(i)+7) <span class="string">'[br15]'</span> fstrm(tableThenImage(i)+8:end)];
                insertPoint = tableThenImage(i)+7;
                update_idxs(6);
                tableThenImage = tableThenImage+6;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), <span class="string">'after adding [br15].html'</span>, 1); <span class="keyword">end</span>
</pre><pre class="codeinput">    <span class="keyword">end</span>
</pre><h2 id="36">Process [bottomMarginx] tags</h2><pre class="codeinput">    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'   bottom margin tags...\n'</span>); <span class="keyword">end</span>
    marginTagList = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'[bottomMargin'</span>) + sourceStart - 1;
    [fstrm, htmlEnd, marginTagList, ~ , margins, marginTagEnds] = find_valid_prettify_tags(<span class="string">'bottomMargin'</span>, marginTagList, [], [], fstrm, htmlEnd);
    <span class="keyword">for</span> i = 1:length(marginTagList)
        tagLength = 1+marginTagEnds(i)-marginTagList(i);
        <span class="keyword">if</span> strcmp(fstrm(marginTagList(i)-3:marginTagList(i)-1),<span class="string">'&lt;p&gt;'</span>)
            style     = [<span class="string">' style="margin-bottom: '</span> num2str(margins(i)) <span class="string">'px;"'</span>];
            <span class="keyword">if</span> strcmp(fstrm(marginTagEnds(i)+1:marginTagEnds(i)+9),<span class="string">'&lt;/p&gt;&lt;div&gt;'</span>)
                <span class="comment">% &lt;p&gt;[bottomMarginx]&lt;/p&gt;&lt;div&gt; -&gt; &lt;div style="margin-bottom:xpx;"&gt;</span>
                fstrm = [fstrm(1:marginTagEnds(i)+8) style fstrm(marginTagEnds(i)+9:end)];
                fstrm(marginTagList(i)-3:marginTagEnds(i)+4) = [];
                charsAdded = length(style) - (tagLength+7);
            <span class="keyword">else</span>
                <span class="comment">% &lt;p&gt;[bottomMarginx] -&gt; &lt;p style="margin-bottom:xpx;"&gt;</span>
                fstrm = [fstrm(1:marginTagList(i)-2) style fstrm(marginTagList(i)-1:end)];
                fstrm(marginTagList(i)+length(style):marginTagEnds(i)+length(style)) = [];
                charsAdded = length(style) - tagLength;
            <span class="keyword">end</span>
        <span class="keyword">else</span>
            fstrm(marginTagList(i):marginTagEnds(i)) = [];
            charsAdded = -tagLength;
        <span class="keyword">end</span>
        marginTagList = marginTagList + charsAdded;
        marginTagEnds = marginTagEnds + charsAdded;
        htmlEnd       = htmlEnd       + charsAdded;
    <span class="keyword">end</span>
    <span class="keyword">if</span> DEBUG &amp;&amp; ~isempty(marginTagList), write_fstrm_to_file(fstrm(sourceStart:htmlEnd), <span class="string">'after processing bottomMarginx.html'</span>, 1); <span class="keyword">end</span>
</pre><h2 id="37">Assign image-fit class to all images</h2><pre class="codeinput">    imgTags = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;img '</span>) + sourceStart - 1;
    <span class="keyword">for</span> i = 1:length(imgTags)
        srcIdx    = strfind(fstrm(imgTags(i):htmlEnd),<span class="string">' src='</span>);
        srcIdx    = srcIdx(1) + imgTags(i) - 1;
        imgTagEnd = strfind(fstrm(imgTags(i):htmlEnd),<span class="string">'&gt;'</span>);
        imgTagEnd = imgTagEnd(1) + imgTags(i) - 1;
        assert(~isempty(srcIdx) &amp;&amp; ~isempty(imgTagEnd),<span class="string">'ERROR: malformed image tags found'</span>);
        <span class="keyword">if</span> contains(fstrm(srcIdx:imgTagEnd),<span class="string">'.svg'</span>), fitClass = <span class="string">'image-fit-svg'</span>;
        <span class="keyword">else</span>                                       , fitClass = <span class="string">'image-fit'</span>;     <span class="keyword">end</span>
        classStrs = {<span class="string">'class="'</span>,<span class="string">'class ="'</span>,<span class="string">'class= "'</span>,<span class="string">'class = "'</span>};
        <span class="keyword">for</span> classStr = classStrs
            classIdx = strfind(fstrm(imgTags(i):imgTagEnd),classStr{:});
            <span class="keyword">if</span> ~isempty(classIdx)
                classIdx = classIdx(1) + imgTags(i) - 1;
                <span class="keyword">if</span> contains(fstrm(imgTags(i):imgTagEnd),<span class="string">'image-fit'</span>)
                    <span class="keyword">break</span>
                <span class="keyword">end</span>
                fstrm       = [fstrm(1:classIdx-1) classStr{:} fitClass <span class="string">' '</span> fstrm(classIdx+length(classStr{:}):end)];
                insertPoint = classIdx-1;
                update_idxs(length(fitClass)+1);
                <span class="keyword">break</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> isempty(classIdx)
            classToAdd    = [<span class="string">'class="'</span> fitClass <span class="string">'"'</span>];
            <span class="keyword">if</span> contains(fstrm(imgTags(i):imgTagEnd),<span class="string">'vspace="5" hspace="5"'</span>)
                charsToRemove = srcIdx - imgTags(i) - 5;
                fstrm         = [fstrm(1:imgTags(i)+4) classToAdd fstrm(srcIdx:end)];
            <span class="keyword">else</span>
                charsToRemove = -1;
                fstrm         = [fstrm(1:imgTags(i)+4) classToAdd <span class="string">' '</span> fstrm(imgTags(i)+5:end)];
            <span class="keyword">end</span>
            insertPoint = imgTags(i)+4;
            update_idxs(length(classToAdd)-charsToRemove);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="38">Process undocumented [png2svg] tags</h2><p>WARNING - MATLAB central does not support .svg images, so they have to be hosted externally</p><pre class="codeinput">    [png2svgOpens, png2svgCloses] = get_tag_pairs(<span class="string">'[png2svg]'</span>, fstrm, htmlEnd);
    imageFolder = strfind(fstrm(1:htmlEnd),<span class="string">'[imageFolder='</span>);
    <span class="keyword">if</span> ~isempty(imageFolder)
        imageFolder    = imageFolder(1);
        imageFolderEnd = strfind(fstrm(imageFolder:htmlEnd),<span class="string">']'</span>);
        imageFolder    = fstrm(imageFolder+13:imageFolder+imageFolderEnd(1)-2);
    <span class="keyword">end</span>
    <span class="keyword">for</span> i = 1:length(png2svgOpens)
        imgTags = strfind(fstrm(png2svgOpens(i):png2svgCloses(i)),<span class="string">'&lt;img '</span>) + png2svgOpens(i) - 1;
        <span class="keyword">for</span> j = 1:length(imgTags)
            srcIdx    = strfind(fstrm(imgTags(j):png2svgCloses(i)),<span class="string">' src='</span>);
            srcIdx    = srcIdx(1) + imgTags(j) - 1;
            imgTagEnd = strfind(fstrm(srcIdx:png2svgCloses(i)),<span class="string">'&gt;'</span>);
            imgTagEnd = imgTagEnd(1) + srcIdx - 1;
            <span class="keyword">if</span> contains(fstrm(srcIdx:imgTagEnd),<span class="string">'.png" alt=""&gt;'</span>)
                fstrm = [fstrm(1:srcIdx-1) strrep(fstrm(srcIdx:imgTagEnd),<span class="string">'.png" alt=""&gt;'</span>,<span class="string">'_.svg" alt=""&gt;'</span>) fstrm(imgTagEnd+1:end)];
                imgTags(j+1:end) = imgTags(j+1:end) + 1;
                imgTagEnd        = imgTagEnd + 1;
                <span class="comment">% image-fit -&gt; image-fit-svg</span>
                fstrm = [fstrm(1:imgTags(j)-1) strrep(fstrm(imgTags(j):imgTagEnd),<span class="string">'image-fit'</span>,<span class="string">'image-fit-svg'</span>) fstrm(imgTagEnd+1:end)];
                insertPoint = imgTags(j)-1;
                update_idxs(5);
                png2svgOpens  = png2svgOpens  + 5;
                png2svgCloses = png2svgCloses + 5;
                <span class="keyword">if</span> ~isempty(imageFolder)
                    fstrm = [fstrm(1:srcIdx+9) imageFolder <span class="string">'/'</span> fstrm(srcIdx+10:end)];
                    insertPoint = srcIdx+9;
                    update_idxs(length(imageFolder)+1);
                    png2svgOpens  = png2svgOpens  + length(imageFolder)+1;
                    png2svgCloses = png2svgCloses + length(imageFolder)+1;
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="39">Process undocumented [removepng] tags</h2><pre class="codeinput">    [removepngOpens, removepngCloses] = get_tag_pairs(<span class="string">'[removepng]'</span>, fstrm, htmlEnd);
    <span class="keyword">for</span> i = 1:length(removepngOpens)
        imgTags = strfind(fstrm(removepngOpens(i):removepngCloses(i)),<span class="string">'&lt;img '</span>) + removepngOpens(i) - 1;
        <span class="keyword">for</span> j = 1:length(imgTags)
            srcIdx    = strfind(fstrm(imgTags(j):removepngCloses(i)),<span class="string">' src='</span>);
            srcIdx    = srcIdx(1) + imgTags(j) - 1;
            imgTagEnd = strfind(fstrm(srcIdx:removepngCloses(i)),<span class="string">'&gt;'</span>);
            imgTagEnd = imgTagEnd(1) + srcIdx - 1;
            <span class="keyword">if</span> contains(fstrm(srcIdx:imgTagEnd),<span class="string">'.png" alt=""&gt;'</span>)
                fstrm(imgTags(j):imgTagEnd) = [];
                imgTagLength = (imgTagEnd+1-imgTags(j));
                insertPoint  = imgTags(j);
                update_idxs(-imgTagLength);
                removepngOpens   = removepngOpens   - imgTagLength;
                removepngCloses  = removepngCloses  - imgTagLength;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="40">Process [darkAlt] tags</h2><pre class="codeinput">    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'   darkAlt tags...\n'</span>); <span class="keyword">end</span>
    IMG_EXTS = {<span class="string">'png'</span>,<span class="string">'jpg'</span>,<span class="string">'jpeg'</span>,<span class="string">'svg'</span>};
    IMG_EXTS = [IMG_EXTS upper(IMG_EXTS)];
    [darkAltOpens, darkAltCloses] = get_tag_pairs(<span class="string">'[darkAlt]'</span>, fstrm, htmlEnd);
    <span class="keyword">for</span> i = 1:length(darkAltOpens)
        imgTags = strfind(fstrm(darkAltOpens(i):darkAltCloses(i)),<span class="string">'&lt;img '</span>) + darkAltOpens(i) - 1;
        <span class="keyword">if</span> ~isempty(imgTags)
            fstrm = [fstrm(1:darkAltOpens(i)-1) <span class="keyword">...</span>
                     strrep(fstrm(darkAltOpens(i):darkAltCloses(i)),<span class="string">'image-fit"'</span>,<span class="string">'image-fit show-if-light"'</span>) <span class="keyword">...</span>
                     fstrm(darkAltCloses(i)+1:end)];
            fstrm = [fstrm(1:darkAltOpens(i)-1) <span class="keyword">...</span>
                     strrep(fstrm(darkAltOpens(i):darkAltCloses(i)),<span class="string">'image-fit-svg'</span>,<span class="string">'image-fit-svg show-if-light'</span>) <span class="keyword">...</span>
                     fstrm(darkAltCloses(i)+1:end)];
            insertPoint = darkAltOpens(i)-1;
            update_idxs(14*length(imgTags))
            darkAltOpens(i+1:end)  = darkAltOpens(i+1:end) + 14*length(imgTags);
            darkAltCloses          = darkAltCloses         + 14*length(imgTags);
        <span class="keyword">end</span>
        imgTags = strfind(fstrm(darkAltOpens(i):darkAltCloses(i)),<span class="string">'&lt;img '</span>) + darkAltOpens(i) - 1;
        <span class="keyword">for</span> j = 1:length(imgTags)
            srcIdx    = strfind(fstrm(imgTags(j):darkAltCloses(i)),<span class="string">' src='</span>);
            srcIdx    = srcIdx(1) + imgTags(j) - 1;
            imgTagEnd = strfind(fstrm(srcIdx:darkAltCloses(i)),<span class="string">'&gt;'</span>);
            imgTagEnd = imgTagEnd(1) + srcIdx - 1;
            duplicate = fstrm(imgTags(j):imgTagEnd);
            <span class="keyword">for</span> ext = IMG_EXTS
                <span class="keyword">if</span> contains(fstrm(srcIdx:imgTagEnd),[<span class="string">'.'</span> ext{:} <span class="string">'" alt=""&gt;'</span>])
                    fstrm = [fstrm(1:imgTagEnd) <span class="keyword">...</span>
                             strrep(strrep(duplicate,[<span class="string">'.'</span> ext{:} <span class="string">'" alt=""&gt;'</span>],[<span class="string">'_dark.'</span> ext{:} <span class="string">'" alt=""&gt;'</span>]),<span class="string">'show-if-light'</span>,<span class="string">'show-if-dark'</span>) <span class="keyword">...</span>
                             fstrm(imgTagEnd+1:end)];
                    insertPoint = imgTagEnd;
                    update_idxs(length(duplicate)+4);
                    darkAltOpens(i+1:end)  = darkAltOpens(i+1:end) + length(duplicate)+4;
                    darkAltCloses          = darkAltCloses         + length(duplicate)+4;
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="41">Replace [br] with <a href="br">br</a></h2><pre class="codeinput">    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'   [br] tags...\n'</span>); <span class="keyword">end</span>
    fstrm = strrep(fstrm,<span class="string">'[br]'</span>,<span class="string">'&lt;br&gt;'</span>);
</pre><h2 id="42">Process undocumented [rembr] and [delbr] tags</h2><pre class="codeinput">    rembrTags = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'[rembr]'</span>) + sourceStart - 1;
    <span class="keyword">for</span> i = 1:length(rembrTags)
        brTag = strfind(fstrm(sourceStart:rembrTags(i)),<span class="string">'&lt;br&gt;'</span>);
        brTag = brTag(end) + sourceStart - 1;
        <span class="keyword">if</span> strcmp(sscanf(fstrm(brTag:rembrTags(i)-1),<span class="string">'%s'</span>),<span class="string">'&lt;br&gt;'</span>)
            fstrm(brTag:brTag+3) = [];
            rembrTags = rembrTags - 4;
            htmlEnd   = htmlEnd   - 4;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    delbrTags = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'[delbr]'</span>) + sourceStart - 1;
    <span class="keyword">for</span> i = 1:length(delbrTags)
        brTag = strfind(fstrm(delbrTags(i):htmlEnd),<span class="string">'&lt;br&gt;'</span>);
        brTag = brTag(1) + delbrTags(i) - 1;
        <span class="keyword">if</span> strcmp(sscanf(fstrm(delbrTags(i)+7:brTag+3),<span class="string">'%s'</span>),<span class="string">'&lt;br&gt;'</span>)
            fstrm(brTag:brTag+3) = [];
            delbrTags = delbrTags - 4;
            htmlEnd   = htmlEnd   - 4;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'   [delsp] tags...\n'</span>); <span class="keyword">end</span>
    delspTags = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'[delsp]'</span>) + sourceStart - 1;
    <span class="keyword">for</span> i = 1:length(delspTags)
        <span class="keyword">if</span> fstrm(delspTags(i)+7) == <span class="string">' '</span>
            fstrm(delspTags(i)+7) = [];
            delspTags = delspTags - 1;
            htmlEnd   = htmlEnd   - 1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="43">Insert breaks of specified pixel height ([brx] tags)</h2><pre class="codeinput">    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'   [brx] tags...\n'</span>); <span class="keyword">end</span>
    brxTagList = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'[br'</span>) + sourceStart - 1;
    [fstrm, htmlEnd, brxTagList, ~ , ~, brTagEnds] = find_valid_prettify_tags(<span class="string">'br'</span>, brxTagList, [], [], fstrm, htmlEnd);
    <span class="keyword">for</span> j = 1:length(brxTagList)
        <span class="comment">%[brx] -&gt; &lt;br style="display:block; content:''; margin-top:xpx;"&gt;</span>
        fstrm = [fstrm(1:brxTagList(j)-1) <span class="string">'&lt;br style="display:block; content:''''; margin-top:'</span> fstrm(brxTagList(j)+3:brTagEnds(j)-1) <span class="keyword">...</span>
                 <span class="string">'px;"&gt;'</span> fstrm(brTagEnds(j)+1:end)];
        brxTagList = brxTagList + 50;
        brTagEnds  = brTagEnds  + 50;
        htmlEnd    = htmlEnd    + 50;
    <span class="keyword">end</span>
</pre><h2 id="44">Remove excess spacing after codeoutput sections</h2><pre class="codeinput">    codeoutLoc = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;pre class="codeoutput"&gt;'</span>) + sourceStart - 1;
    <span class="keyword">for</span> i = 1:length(codeoutLoc)
        codeoutEnd = strfind(fstrm(codeoutLoc(i):htmlEnd),<span class="string">'&lt;/pre&gt;'</span>);
        charsDeleted = 0;
        <span class="keyword">if</span> ~isempty(codeoutEnd)
            codeoutEnd = codeoutEnd(1) + codeoutLoc(i) - 1;
            <span class="keyword">while</span> fstrm(codeoutEnd-1-charsDeleted)==NL
                fstrm(codeoutEnd-1-charsDeleted)=[];
                charsDeleted = charsDeleted + 1;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        htmlEnd             = htmlEnd             - charsDeleted;
        codeoutLoc(i+1:end) = codeoutLoc(i+1:end) - charsDeleted;
        <span class="keyword">if</span> strcmp(fstrm(codeoutEnd-charsDeleted+6:codeoutEnd-charsDeleted+21),<span class="string">'&lt;/div&gt;&lt;/details&gt;'</span>)
            fstrm = [fstrm(1:codeoutLoc(i)+4) <span class="string">'style=margin-bottom:0px; '</span> fstrm(codeoutLoc(i)+5:end)];
            htmlEnd             = htmlEnd             + 25;
            codeoutLoc(i+1:end) = codeoutLoc(i+1:end) + 25;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="45">Remove erroneous <a href="p">p</a>&lt;/p&gt; tags</h2><pre class="codeinput">    pOpens    = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;p '</span>)  + sourceStart - 1;
    unstyledP = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;p&gt;'</span>) + sourceStart - 1;
    pOpens    = sort([pOpens unstyledP]);
    pCloses   = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;/p&gt;'</span>) + sourceStart - 1;
    assert(length(pOpens)==length(pCloses),<span class="string">'ERROR: Imbalanced &lt;p&gt;&lt;/p&gt; tags detected. There are %i opening tags and %i closing tags'</span>,<span class="keyword">...</span>
                                            length(pOpens),length(pCloses))
    [~, pCloses] = sort_tag_closes(pOpens, pCloses);
    pCloses      = pCloses(ismember(pOpens,unstyledP));
    pOpens       = pOpens (ismember(pOpens,unstyledP));
    <span class="keyword">for</span> i = 1:length(pOpens)
        <span class="keyword">if</span> contains(fstrm(pOpens(i):pCloses(i)), {<span class="string">'&lt;/p&gt;'</span>,<span class="string">'&lt;/table&gt;'</span>,<span class="string">'&lt;/ol&gt;'</span>,<span class="string">'&lt;/ul&gt;'</span>,<span class="string">'&lt;/pre&gt;'</span>,<span class="string">'&lt;/div&gt;'</span>,<span class="string">'&lt;/img&gt;'</span>,<span class="string">'&lt;/dl&gt;'</span>,<span class="string">'&lt;/h1&gt;'</span>,<span class="string">'&lt;/h2&gt;'</span>,<span class="string">'&lt;/h3&gt;'</span>,<span class="string">'&lt;/h4&gt;'</span>, <span class="keyword">...</span>
                                                  <span class="string">'&lt;/h5&gt;'</span>,<span class="string">'&lt;/h6&gt;'</span>})
            fstrm(pOpens(i):pOpens(i)+2) = [];
            pCloses(pCloses&gt;pOpens(i)) = pCloses(pCloses&gt;pOpens(i)) - 3;
            pOpens (pCloses&gt;pOpens(i)) = pOpens (pCloses&gt;pOpens(i)) - 3;
            fstrm(pCloses(i):pCloses(i)+3) = [];
            pOpens (pCloses&gt;pCloses(i)) = pOpens (pCloses&gt;pCloses(i)) - 4;
            pCloses(pCloses&gt;pCloses(i)) = pCloses(pCloses&gt;pCloses(i)) - 4;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="46">Insert link to FEX page</h2><p>handle defunct [frameBufferx] tag</p><pre class="codeinput">    frameBufferTag = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'[frameBuffer'</span>) + sourceStart - 1;
    <span class="keyword">if</span> ~isempty(frameBufferTag)
        assert(length(frameBufferTag)==1,<span class="string">'ERROR: only one [frameBufferx] tag is allowed'</span>);
        frameBufferTagEnd = strfind(fstrm(frameBufferTag:htmlEnd),<span class="string">']'</span>) + frameBufferTag - 1;
        fstrm(frameBufferTag:frameBufferTagEnd) = [];
    <span class="keyword">end</span>
    frameBuffer = <span class="string">'&lt;p id="iFrameBuf"&gt;&amp;nbsp;&lt;/p&gt;'</span>;
    finalA = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;a'</span>);
    finalA = finalA(end) + sourceStart - 1;
    <span class="keyword">if</span> strcmp(fstrm(finalA-4:finalA-1),<span class="string">'&lt;br&gt;'</span>), fstrm(finalA-4:finalA-1) = []; <span class="keyword">end</span>
    finalCloseA = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;/a&gt;'</span>);
    finalCloseA = finalCloseA(end) + sourceStart - 1;
    <span class="comment">% get version number from opening comments</span>
    fid    = fopen([mfilename(<span class="string">'fullpath'</span>) <span class="string">'.m'</span>],<span class="string">'r'</span>);
    line   = <span class="string">''</span>; <span class="keyword">while</span> ~contains(line,<span class="string">'Version'</span>), line = fgetl(fid); <span class="keyword">end</span>
    verStr = sscanf(line,<span class="string">'%%   Version %s'</span>);
    fclose(fid);
    <span class="comment">% add link and frame buffer to footer</span>
    fstrm  = [fstrm(1:finalCloseA+3) <span class="string">' and subsequently processed by '</span> <span class="keyword">...</span>
              <span class="string">'&lt;a class="pretty-link" href="https://www.mathworks.com/matlabcentral/fileexchange/78059-prettify-matlab-html"&gt;prettify_MATLAB_html&lt;/a&gt;'</span> <span class="keyword">...</span>
              <span class="string">' V'</span> verStr <span class="string">'&lt;/p&gt;'</span> frameBuffer fstrm(finalCloseA+12:end)]; <span class="comment">% skip over &lt;br&gt;&lt;/p&gt; in original source</span>
</pre><h2 id="47">Remove/modify remaining prettify_MATLAB_html tags</h2><pre class="codeinput">    tagsToRemove = {<span class="string">'[rembr]'</span>,<span class="string">'[delbr]'</span>,<span class="string">'[delsp]'</span>,<span class="string">'[png2svg]'</span>,<span class="string">'[/png2svg]'</span>,<span class="string">'[removepng]'</span>,<span class="string">'[/removepng]'</span>,<span class="string">'[darkAlt]'</span>,<span class="string">'[/darkAlt]'</span>,<span class="string">'[imageFolder='</span>};
    <span class="keyword">for</span> tag = tagsToRemove
        <span class="keyword">if</span> tag{:}(end)~=<span class="string">']'</span>
            tagStarts = strfind(fstrm,tag{:});
            <span class="keyword">for</span> tagStart = tagStarts
                tagEnd = strfind(fstrm(tagStart:end),<span class="string">']'</span>);
                fstrm(tagStart:tagStart+tagEnd(1)-1)=[];
            <span class="keyword">end</span>
        <span class="keyword">else</span>
            fstrm = strrep(fstrm,tag{:},<span class="string">''</span>);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    fstrm = strrep(fstrm,<span class="string">'[ targetn]'</span>,<span class="string">'[target&lt;i&gt;n&lt;/i&gt;]'</span>);
    fstrm = strrep(fstrm,<span class="string">'[ jumpton]'</span>,<span class="string">'[jumpto&lt;i&gt;n&lt;/i&gt;]'</span>);
    fstrm = strrep(fstrm,<span class="string">'[ scalex]'</span> ,<span class="string">'[scale&lt;i&gt;x&lt;/i&gt;]'</span>);
    fstrm = strrep(fstrm,<span class="string">'[ class.class-name]'</span> ,<span class="string">'[class.&lt;i&gt;class-name&lt;/i&gt;]'</span>);
    fstrm = strrep(fstrm,<span class="string">'[ brx]'</span>    ,<span class="string">'[br&lt;i&gt;x&lt;/i&gt;]'</span>);
    fstrm = strrep(fstrm,<span class="string">'[ bottomMarginx]'</span>    ,<span class="string">'[bottomMargin&lt;i&gt;x&lt;/i&gt;]'</span>);
    tagsToModify = {<span class="string">'[ br'</span>,<span class="string">'[ bottomMargin'</span>,<span class="string">'[ target'</span>,<span class="string">'[ rembr]'</span>,<span class="string">'[ delbr]'</span>,<span class="string">'[ delsp]'</span>,<span class="string">'[ frameBufferx]'</span>};
    <span class="keyword">for</span> tag = tagsToModify
        fstrm = strrep(fstrm,tag{:},[tag{:}(1) tag{:}(3:end)]);
    <span class="keyword">end</span>
    tagsToModify = {<span class="string">'[ dtls]'</span>,<span class="string">'[ smry]'</span>,<span class="string">'[ jumpto'</span>,<span class="string">'[ cssClasses'</span>,<span class="string">'[ colour'</span>,<span class="string">'[ scale'</span>,<span class="string">'[ class'</span>,<span class="string">'[ themesEnabled]'</span>,<span class="string">'[ darkAlt]'</span>,<span class="string">'[ h2]'</span>,<span class="string">'[ h2.CElink]'</span>};
    <span class="keyword">for</span> tag = tagsToModify
        fstrm = strrep(fstrm,tag{:},[tag{:}(1) tag{:}(3:end)]);
        fstrm = strrep(fstrm,[tag{:}(1:2) <span class="string">'/'</span> tag{:}(3:end)],[tag{:}(1) <span class="string">'/'</span> tag{:}(3:end)]);
    <span class="keyword">end</span>
</pre><h2 id="48">Final bit of javascript</h2><pre class="codeinput">    fstrm = strrep(fstrm,<span class="string">'&lt;/body&gt;'</span>,[<span class="string">'&lt;script&gt;'</span> NL <span class="keyword">...</span>
                                    <span class="string">'var allDetails   = document.getElementsByTagName(''details'');'</span> NL <span class="keyword">...</span>
                                    <span class="string">'var contentDiv   = document.getElementsByClassName("content"); contentDiv = contentDiv[0];'</span> NL <span class="keyword">...</span>
                                    <span class="string">'var returnButton = document.getElementById("return-link");'</span> NL <span class="keyword">...</span>
                                    <span class="string">'document.getElementById("iFrameBuf").style.display = "none";'</span> NL <span class="keyword">...</span>
                                    <span class="string">'if(in_iFrame())'</span> NL <span class="keyword">...</span>
                                    <span class="string">'{'</span> NL <span class="keyword">...</span>
                                    <span class="string">'   try{'</span> NL <span class="keyword">...</span>
                                    <span class="string">'      var footerNav = parent.document.getElementsByClassName("footernav");'</span> NL <span class="keyword">...</span>
                                    <span class="string">'      var tabPane   = parent.document.getElementsByClassName("tab-pane");}'</span> NL <span class="keyword">...</span>
                                    <span class="string">'   catch(err) { var footerNav = []; var tabPane = [];};'</span> NL <span class="keyword">...</span>
                                    <span class="string">'   if(!(footerNav.length) || tabPane.length)'</span> NL <span class="keyword">...</span><span class="comment"> we are embedded in a frame that's not a MATLAB help browser frame</span>
                                    <span class="string">'   {'</span> NL <span class="keyword">...</span>
                                    <span class="string">'      contentDiv.style.overflowY = "scroll";'</span>   NL <span class="keyword">...</span>
                                    <span class="string">'      contentDiv.style.overflowX = "hidden";'</span>   NL <span class="keyword">...</span>
                                    <span class="string">'      contentDiv.style.position  = "absolute";'</span> NL <span class="keyword">...</span>
                                    <span class="string">'      contentDiv.style.width     = "95%";'</span>      NL <span class="keyword">...</span>
                                    <span class="string">'      contentDiv.style.top       = 0;'</span>          NL <span class="keyword">...</span>
                                    <span class="string">'      contentDiv.style.bottom    = 0;'</span>          NL <span class="keyword">...</span>
                                    <span class="string">'      if (tabPane.length){'</span> NL <span class="keyword">...</span>
                                    <span class="string">'         contentDiv.setAttribute("data-isMATLABCentral","1");'</span> NL <span class="keyword">...</span>
                                    <span class="string">'         returnButton.style.right = "40px";'</span> NL <span class="keyword">...</span>
                                    <span class="string">'         document.getElementById("tooltiptext").style.right = "92px"; }'</span> NL <span class="keyword">...</span>
                                    <span class="string">'      document.getElementById("iFrameBuf").style.display = "block";'</span> NL <span class="keyword">...</span>
                                    <span class="string">'   }'</span> NL <span class="keyword">...</span>
                                    <span class="string">'   else { contentDiv.setAttribute("data-isHelpBrowser","1"); }'</span> NL <span class="keyword">...</span>
                                    <span class="string">'}'</span> NL <span class="keyword">...</span>
                                    <span class="string">'if (!contentDiv.getAttribute("data-isHelpBrowser") &amp;&amp; !contentDiv.getAttribute("data-isMATLABCentral") ){'</span> NL <span class="keyword">...</span>
                                    <span class="string">'   document.getElementById("anchor-offsets").sheet.disabled = true; }'</span> NL <span class="keyword">...</span>
                                    <span class="string">'var jumpLinks = document.getElementsByTagName("a");'</span> NL <span class="keyword">...</span>
                                    <span class="string">'for (var i = 0; i &lt; jumpLinks.length; i++){'</span> NL <span class="keyword">...</span>
                                    <span class="string">'  href = jumpLinks[i].getAttribute("href");'</span> NL <span class="keyword">...</span>
                                    <span class="string">'  if (href &amp;&amp; href[0] == "#") { jumpLinks[i].onclick = jump_to;}}'</span> NL <span class="keyword">...</span>
                                    <span class="string">'&lt;/script&gt;&lt;/body&gt;'</span>]);
</pre><h2 id="49">Write the output file</h2><pre class="codeinput">    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'Writing output file...\n'</span>); <span class="keyword">end</span>
    write_fstrm_to_file(fstrm, inputhtmlFile);
    <span class="keyword">if</span> DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), <span class="string">'processing complete.html'</span>, 1); <span class="keyword">end</span>
    <span class="keyword">if</span> verbose, fprintf(1,<span class="string">'Processing complete.\n'</span>); <span class="keyword">end</span>
    show_warning_dialogue;
</pre><pre class="codeinput">    <span class="keyword">catch</span> MEx
        show_warning_dialogue;
        throwError = false;
        <span class="keyword">if</span> ~isempty(MEx.identifier)
            fprintf(2,<span class="string">'\nPLEASE REPORT BUGS TO: &lt;a href="mailto:harry.dymond@bristol.ac.uk"&gt;harry.dymond@bristol.ac.uk&lt;/a&gt;\n\n'</span>);
            errorMsg = [<span class="string">'Error!'</span> NL <span class="string">'Please see MATLAB command line for more information'</span>];
            throwError = true;
        <span class="keyword">else</span>
            errorMsg = MEx.message;
        <span class="keyword">end</span>
        callStack = dbstack;
        <span class="keyword">if</span> length(callStack)&gt;1 &amp;&amp; strcmp(callStack(2).file,<span class="string">'publish.m'</span>)
            uiwait(msgbox(errorMsg,<span class="string">''</span>,<span class="string">'error'</span>,<span class="string">'modal'</span>));
        <span class="keyword">else</span>
            fprintf(2,errorMsg);
        <span class="keyword">end</span>
        <span class="keyword">if</span> throwError
            fprintf(2,<span class="string">'Error in %s on &lt;a href="matlab:opentoline(''%s'', %i)"&gt;line %i&lt;/a&gt;:\n'</span>, <span class="keyword">...</span>
                      MEx.stack(1).name, MEx.stack(1).file, MEx.stack(1).line, MEx.stack(1).line)
            throw(MEx)
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="51">Subroutines</h2><pre class="codeinput">    <span class="keyword">function</span> update_idxs(insertionLength)
</pre><h2 id="52">&nbsp;&nbsp;&nbsp;&nbsp;Index updater</h2><pre class="codeinput">        detailsOpens ( detailsOpens  &gt; insertPoint ) = detailsOpens ( detailsOpens  &gt; insertPoint ) + insertionLength;
        detailsCloses( detailsCloses &gt; insertPoint ) = detailsCloses( detailsCloses &gt; insertPoint ) + insertionLength;
        summaryCloses( summaryCloses &gt; insertPoint ) = summaryCloses( summaryCloses &gt; insertPoint ) + insertionLength;
        imgTags      ( imgTags       &gt; insertPoint ) = imgTags      ( imgTags       &gt; insertPoint ) + insertionLength;

        htmlEnd = htmlEnd + insertionLength;
</pre><pre class="codeinput">    <span class="keyword">end</span>

    <span class="keyword">function</span> show_warning_dialogue
</pre><h2 id="54">&nbsp;&nbsp;&nbsp;&nbsp;Show warning dialogue if warnings were generated</h2><pre class="codeinput">        callStack = dbstack;
        <span class="keyword">if</span> length(callStack)&gt;1 &amp;&amp; ismember(<span class="string">'publish.m'</span>,{callStack.file}) &amp;&amp; ~isempty(show_warning([]))
            uiwait(msgbox([num2str(show_warning([])) <span class="string">' warnings generated'</span> NL <span class="string">'Please see MATLAB command line for more information'</span>],<span class="string">''</span>,<span class="string">'warn'</span>,<span class="string">'modal'</span>));
        <span class="keyword">end</span>
</pre><pre class="codeinput">    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><h2 id="57">==========================================================================================================================================================</h2><h2 id="58">Helper functions</h2><h2 id="59">&nbsp;&nbsp;&nbsp;&nbsp;Tag processing</h2><pre class="codeinput"><span class="keyword">function</span> [fstrm, classNames, userCSS] = process_cssClasses_tags(fstrm, getClassNamesOnly)
    <span class="keyword">if</span> nargin&lt;2, getClassNamesOnly = false; <span class="keyword">end</span>
    <span class="keyword">if</span> getClassNamesOnly,     htmlEnd  = length(fstrm);
    <span class="keyword">else</span>                , [~, htmlEnd] = find_source(fstrm); <span class="keyword">end</span>
    [cssOpens, cssCloses] = get_tag_pairs(<span class="string">'[cssClasses]'</span>, fstrm, htmlEnd);
    userCSS = <span class="string">''</span>;
    <span class="keyword">if</span> isempty(cssOpens), classNames = {}; <span class="keyword">return</span>, <span class="keyword">end</span>
    <span class="keyword">if</span> length(cssOpens)&gt;1
        throwAsCaller(MException(<span class="string">'prettify:too many cssClass blocks'</span>,<span class="string">'There should only be one pair of [cssClasses][/cssClasses] tags in your source file'</span>))
    <span class="keyword">end</span>
    openBraces   = strfind(fstrm(cssOpens:cssCloses),<span class="string">'{'</span>) + cssOpens - 1;
    closeBraces  = strfind(fstrm(cssOpens:cssCloses),<span class="string">'}'</span>) + cssOpens - 1;
    classNames{length(openBraces)} = <span class="string">''</span>;
    fileIdx      = cssOpens + 12;
    <span class="keyword">for</span> classCounter = 1:length(openBraces)
        <span class="comment">% check first char after [cssClass]</span>
        <span class="comment">% [/cssClass]</span>
        warnMsg        = <span class="string">''</span>;
        WARN_MSG_START = [<span class="string">'css class '</span> num2str(classCounter) <span class="string">' is malformed: '</span>];
        <span class="keyword">while</span> fileIdx&lt;cssCloses &amp;&amp; char(fstrm(fileIdx))~=<span class="string">'.'</span>
            fileIdx = fileIdx + 1;
        <span class="keyword">end</span>
        <span class="keyword">if</span> fstrm(fileIdx) ~= <span class="string">'.'</span>
            warnMsg = [WARN_MSG_START <span class="string">'css class declarations should start with a dot'</span>];
        <span class="keyword">else</span>
            <span class="keyword">if</span> isempty(warnMsg) &amp;&amp; openBraces(classCounter)&gt;closeBraces(classCounter)
                warnMsg = [WARN_MSG_START <span class="string">'opening ''{'' found after closing ''}'''</span>];
            <span class="keyword">end</span>
            classNames{classCounter} = sscanf(char(fstrm(fileIdx:openBraces(classCounter)-1)),<span class="string">'.%s'</span>);
            <span class="keyword">if</span> any( cellfun( @(x)isequal(x,classNames{classCounter}), classNames( 1:length(classNames)~=classCounter ) )  )
                warnMsg = [WARN_MSG_START classNames{classCounter} <span class="string">' has already been declared'</span>];
                classNames{classCounter} = <span class="string">''</span>;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> ~isempty(warnMsg)
            show_warning(warnMsg)
        <span class="keyword">elseif</span> ~getClassNamesOnly
            userCSS = [userCSS <span class="string">'.'</span> classNames{classCounter} <span class="string">' '</span> fstrm(openBraces(classCounter):closeBraces(classCounter)) NL]; <span class="comment">%#ok&lt;AGROW&gt;</span>
        <span class="keyword">end</span>
        fileIdx = closeBraces(classCounter) + 1;
        <span class="keyword">if</span> ~isempty(warnMsg), openBraces(classCounter) = 0; <span class="keyword">end</span>
    <span class="keyword">end</span>
    classNames(openBraces==0)=[];
    <span class="keyword">if</span> getClassNamesOnly
        clear <span class="string">userCSS</span>;
    <span class="keyword">else</span>
        fstrm(cssOpens:cssCloses+12) = [];
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> [sourceStart, sourceEnd] = find_source(fstrm)
    sourceStart = strfind(fstrm,<span class="string">'&lt;/head&gt;'</span>);
    sourceStart = sourceStart(1);
    sourceEnd   = strfind(fstrm,<span class="string">'##### SOURCE BEGIN #####'</span>);
    <span class="keyword">try</span>
        assert(~isempty(sourceEnd),<span class="string">'ERROR: Format of MATLAB-generated html file has changed.'</span>);
    <span class="keyword">catch</span> MEx
        throwAsCaller(MEx);
    <span class="keyword">end</span>
    sourceEnd = sourceEnd(1);
<span class="keyword">end</span>

<span class="keyword">function</span> [fstrm, htmlEnd] = process_target_and_jump_tags(fstrm, htmlEnd)
    targetTagList  = strfind(fstrm(1:htmlEnd),<span class="string">'[target'</span>);
    [fstrm, htmlEnd, targetTagList, ~ , targetIDList, targetTagEnds] = find_valid_prettify_tags(<span class="string">'target'</span>, targetTagList, [], [], fstrm, htmlEnd);
    <span class="keyword">for</span> j = 1:length(targetTagList)
        <span class="comment">% [targetn] -&gt; &lt;a id="targetn"&gt;&lt;/a&gt;</span>
        fstrm = [fstrm(1:targetTagList(j)-1) <span class="string">'&lt;a id="'</span> fstrm(targetTagList(j)+1:targetTagEnds(j)-1) <span class="string">'"&gt;&lt;/a&gt;'</span> fstrm(targetTagEnds(j)+1:end)];
        targetTagList = targetTagList + 11;
        targetTagEnds = targetTagEnds + 11;
        htmlEnd       = htmlEnd + 11;
    <span class="keyword">end</span>

    [jumpOpens, jumpCloses] = get_tag_pairs(<span class="string">'[jumpto]'</span>, fstrm, htmlEnd);
    [fstrm,htmlEnd,jumpOpens,jumpCloses,jumpIDList,jumpTagEnds] = find_valid_prettify_tags(<span class="string">'jumpto'</span>, jumpOpens, jumpCloses, targetIDList, fstrm, htmlEnd);
    <span class="keyword">for</span> j = 1:length(jumpOpens)
        <span class="comment">% [jumpton] -&gt; &lt;a href="#targetn"&gt;</span>
        fstrm = [fstrm(1:jumpOpens(j)-1) <span class="string">'&lt;a href="#target'</span> num2str(jumpIDList(j)) <span class="string">'"&gt;'</span> fstrm(jumpTagEnds(j)+1:end)];
        jumpCloses  = jumpCloses  + 10;
        <span class="comment">% [/jumpto] -&gt; "&lt;/a&gt;"</span>
        fstrm = [fstrm(1:jumpCloses(j)-1) <span class="string">'&lt;/a&gt;'</span> fstrm(jumpCloses(j)+9:end)];
        jumpCloses  = jumpCloses  - 5;
        jumpOpens   = jumpOpens   + 5;
        jumpTagEnds = jumpTagEnds + 5;
        htmlEnd     = htmlEnd     + 5;
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> [fstrm, htmlEnd, tagList, tagCloseList, valList, tagEnds] = find_valid_prettify_tags(type, tagList, tagCloseList, validValList, fstrm, htmlEnd)
    <span class="keyword">if</span> isempty(tagList), valList = []; tagEnds = []; <span class="keyword">return</span>, <span class="keyword">end</span>
    <span class="keyword">switch</span> type
        <span class="keyword">case</span> {<span class="string">'target'</span>,<span class="string">'jumpto'</span>}, sscanfFormat = [<span class="string">'['</span> type <span class="string">'%i'</span>];  generic = <span class="string">'n'</span>; valDescriptor = <span class="string">'target identifier'</span>; valType = <span class="string">'integer'</span>; long = 3;
        <span class="keyword">case</span> <span class="string">'br'</span>               , sscanfFormat = [<span class="string">'['</span> type <span class="string">'%g'</span>];  generic = <span class="string">'x'</span>; valDescriptor = <span class="string">'padding'</span>;           valType = <span class="string">'number'</span>;  long = 3;
        <span class="keyword">case</span> <span class="string">'scale'</span>            , sscanfFormat = [<span class="string">'['</span> type <span class="string">'%g'</span>];  generic = <span class="string">'x'</span>; valDescriptor = <span class="string">'scaling'</span>;           valType = <span class="string">'positive number'</span>; long = 5;
        <span class="keyword">case</span> <span class="string">'colour'</span>           , sscanfFormat = [<span class="string">'['</span> type <span class="string">'%s'</span>];  generic = <span class="string">'#'</span>; valDescriptor = <span class="string">'colour code'</span>;       valType = <span class="string">'str'</span>;     long = 6;
        <span class="keyword">case</span> <span class="string">'class'</span>            , sscanfFormat = [<span class="string">'['</span> type <span class="string">'.%s'</span>]; generic = <span class="string">''</span> ; valDescriptor = <span class="string">'class name'</span>;        valType = <span class="string">'str'</span>;     long = 100;
        <span class="keyword">case</span> <span class="string">'bottomMargin'</span>     , sscanfFormat = [<span class="string">'['</span> type <span class="string">'%g'</span>];  generic = <span class="string">'x'</span>; valDescriptor = <span class="string">'margin'</span>;            valType = <span class="string">'number'</span>;  long = 6;
    <span class="keyword">end</span>
    WARN_MSG_START = [<span class="string">'['</span> type <span class="string">'] tag %i is malformed: '</span>];
    <span class="keyword">if</span> strcmp(valType, <span class="string">'str'</span>), valList{length(tagList)} = <span class="string">''</span>;
    <span class="keyword">else</span>                     , valList(length(tagList)) = NaN;  <span class="keyword">end</span>
    tagEnds{length(tagList)} = [];
    <span class="keyword">for</span> i = 1:length(tagList)
        warningMsg = <span class="string">''</span>;
        tagEnds{i} = strfind(fstrm(tagList(i):htmlEnd),<span class="string">']'</span>);
        <span class="keyword">if</span> isempty(tagEnds{i}), error([<span class="string">'ERROR: '</span> sprintf(WARN_MSG_START,i) <span class="string">'there is no closing bracket.'</span>]); <span class="keyword">end</span>
        tagEnds{i} = tagEnds{i}(1) + tagList(i) - 1;
        <span class="keyword">if</span> (tagEnds{i}-tagList(i)-1-length(type))&gt;long
            show_warning([<span class="string">'The '</span> valDescriptor <span class="string">' for '</span> type generic <span class="string">' tag '</span> num2str(i) <span class="string">' is more than '</span><span class="keyword">...</span>
                          num2str(long) <span class="string">' characters long. Possible malformed tag?'</span>]);
        <span class="keyword">end</span>
        val = sscanf(fstrm(tagList(i):tagEnds{i}-1),sscanfFormat);
        <span class="keyword">if</span> strcmp(valType, <span class="string">'str'</span>) &amp;&amp; isempty(val)
            warningMsg = sprintf([WARN_MSG_START <span class="string">'%c should be a valid %s.'</span>], i, generic, valDescriptor);
        <span class="keyword">elseif</span> ~strcmp(valType, <span class="string">'str'</span>) &amp;&amp; ( isempty(val) || (contains(valType,<span class="string">'positive'</span>) &amp;&amp; val&lt;=0) )
            warningMsg = sprintf([WARN_MSG_START <span class="string">'%c should be a %s.'</span>], i, generic, valType);
        <span class="keyword">else</span>
            <span class="keyword">switch</span> type
                <span class="keyword">case</span> <span class="string">'target'</span> , <span class="keyword">if</span> any(valList == val)
                    warningMsg = sprintf([WARN_MSG_START <span class="string">'%i has already been used as a target.'</span>], i, val); <span class="keyword">end</span>
                <span class="keyword">case</span> <span class="string">'jumpto'</span> , <span class="keyword">if</span> ~any(validValList == val) <span class="comment">%#ok&lt;ALIGN&gt;</span>
                    warningMsg = sprintf([WARN_MSG_START <span class="string">'%i has not been specified as a jump target (no [target%i] tag in source).'</span>],<span class="keyword">...</span>
                                         i, val, val); <span class="keyword">end</span>
                <span class="keyword">case</span> <span class="string">'colour'</span>
                    valid = true;
                    <span class="keyword">if</span> length(val)~=6                , valid = false; <span class="keyword">end</span>
                    <span class="keyword">if</span> valid, <span class="keyword">try</span> hex2dec(val); <span class="keyword">catch</span>, valid = false; <span class="keyword">end</span>, <span class="keyword">end</span>
                    <span class="keyword">if</span> ~valid, warningMsg = sprintf([WARN_MSG_START val <span class="string">' is not a valid colour code.'</span>]); <span class="keyword">end</span>
                <span class="keyword">case</span> <span class="string">'class'</span>, <span class="keyword">if</span> ~any(cellfun(@(x)isequal(x,val),validValList))
                    warningMsg = sprintf([WARN_MSG_START <span class="string">'%s has not been defined as a CSS class.'</span>], i, val); <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> ~isempty(warningMsg)
            show_warning(warningMsg);
        <span class="keyword">elseif</span> ischar(val)
            valList{i} = val;
        <span class="keyword">else</span>
            valList(i) = val;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    tagEnds = cell2mat(tagEnds);
    <span class="keyword">if</span> strcmp(valType, <span class="string">'str'</span>), invalidIdxs = find(cellfun(@isempty,valList));
    <span class="keyword">else</span>                     , invalidIdxs = find(isnan(valList));                <span class="keyword">end</span>
    <span class="keyword">for</span> i = invalidIdxs
        fstrm(tagList(i):tagEnds(i)) = [];
        noOfCharsDeleted = (tagEnds(i)-tagList(i)+1);
        tagList(i+1:end) = tagList(i+1:end) - noOfCharsDeleted;
        tagEnds(i+1:end) = tagEnds(i+1:end) - noOfCharsDeleted;
        htmlEnd          = htmlEnd - noOfCharsDeleted;
        <span class="keyword">if</span> ismember(type,{<span class="string">'jumpto'</span>,<span class="string">'scale'</span>,<span class="string">'colour'</span>,<span class="string">'class'</span>})
            noOfCharsToRemove = 3 + length(type);
            tagCloseList(i:end)   = tagCloseList(i:end) - noOfCharsDeleted;
            fstrm(tagCloseList(i):tagCloseList(i)+2+length(type)) = [];
            tagCloseList(i)       = 0;
            tagCloseList(i+1:end) = tagCloseList(i+1:end) - noOfCharsToRemove;
            tagList     (i+1:end) = tagList     (i+1:end) - noOfCharsToRemove;
            tagEnds     (i+1:end) = tagEnds     (i+1:end) - noOfCharsToRemove;
            htmlEnd               = htmlEnd - noOfCharsToRemove;
        <span class="keyword">end</span>
        tagList(i) = 0;
    <span class="keyword">end</span>
    valList(tagList==0)=[];
    tagEnds(tagList==0)=[];
    tagList(tagList==0)=[];
    tagCloseList(tagCloseList==0)=[];
<span class="keyword">end</span>

<span class="keyword">function</span> [fstrm, htmlEnd] = prettyTag2htmlTag(type, tagOpens, tagCloses, vals, tagEnds, fstrm, sourceStart, htmlEnd, DEBUG)
    <span class="keyword">switch</span> type
        <span class="keyword">case</span> <span class="string">'scale'</span> , kind = <span class="string">'style'</span>; get_val = @(x, idx)sprintf(<span class="string">'font-size: %.3g%%;'</span>,x(idx)*100);
        <span class="keyword">case</span> <span class="string">'colour'</span>, kind = <span class="string">'style'</span>; get_val = @(x, idx)[<span class="string">'color: #'</span> x{idx} <span class="string">';'</span>];
        <span class="keyword">case</span> <span class="string">'class'</span> , kind = <span class="string">'class'</span>; get_val = @(x, idx)x{idx};
    <span class="keyword">end</span>
    <span class="keyword">if</span> strcmp(type,<span class="string">'class'</span>), [countOfTags, tagCloses] = sort_tag_closes(tagOpens, tagCloses);
    <span class="keyword">else</span>                   , countOfTags = length(tagOpens);                                  <span class="keyword">end</span>

    <span class="keyword">for</span> i = 1:countOfTags
        <span class="comment">% &lt;p&gt;[/type]&lt;/p&gt; -&gt; [/type]</span>
        <span class="keyword">if</span> strcmp(fstrm(tagCloses(i)-3:tagCloses(i)-1),<span class="string">'&lt;p&gt;'</span>) <span class="keyword">...</span>
        &amp;&amp; strcmp(fstrm(tagCloses(i)+length(type)+3:tagCloses(i)+length(type)+6),<span class="string">'&lt;/p&gt;'</span>)
            fstrm([tagCloses(i)-3:tagCloses(i)-1 tagCloses(i)+length(type)+3:tagCloses(i)+length(type)+6]) = [];
            update_idxs(tagCloses(i), -7);
            tagCloses(i) = tagCloses(i)-3;
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">% Deal with [type] ... [/type] tags enclosing non-compatible html tags such as &lt;p&gt;&lt;/p&gt;, &lt;table&gt;&lt;/table&gt;, &lt;ul&gt;&lt;/ul&gt;, etc.:</span>
    <span class="comment">% [type] ... [/type] fully encloses non-enclosable section:</span>
    <span class="comment">% [type] ... &lt;nonEnclosable&gt;...&lt;/nonEnclosable&gt; ... [/type] -&gt; [type] ... [/type]&lt;nonEnclosable kind=""&gt;...&lt;/nonEnclosable&gt;[type] ... [/type] (note kind</span>
    <span class="comment">% added to &lt;nonEnclosable&gt;)</span>
    <span class="comment">%</span>
    <span class="comment">% [type] ... [/type] encloses opening non-enclosable tag only:</span>
    <span class="comment">% [type] ... &lt;nonEnclosable&gt;... [/type] ... &lt;/nonEnclosable&gt;  -&gt; [type] ... [/type]&lt;nonEnclosable&gt;[type] ... [/type] ...&lt;/nonEnclosable&gt;  (note kind NOT</span>
    <span class="comment">% added to &lt;nonEnclosable&gt;)</span>
    <span class="comment">%</span>
    <span class="comment">% [type] ... [/type] encloses closing non-enclosable tag only:</span>
    <span class="comment">% &lt;nonEnclosable&gt; ... [type] ... &lt;/nonEnclosable&gt; ... [/type] -&gt; &lt;nonEnclosable&gt;...[type] ... [/type]&lt;/nonEnclosable&gt;[type]... [/type]  (note kind NOT</span>
    <span class="comment">% added to &lt;nonEnclosable&gt;)</span>
    <span class="comment">%</span>
    <span class="comment">% nested [type] tags -&gt; what might happen?</span>
    <span class="comment">%   1o                            2o                               2c     1c</span>
    <span class="comment">% [type] ... &lt;nonEnclosable&gt;... [type] ... &lt;/nonEnclosable&gt; ... [/type][/type] type pair 1 processed gives -&gt;</span>
    <span class="comment">%   1o       1c (new)                              3o (shift)                  2o (new)  3c (shift) 2c (shift)</span>
    <span class="comment">% [type] ... [/type]&lt;nonEnclosable kind="kind1"&gt;... [type] ... &lt;/nonEnclosable&gt;[type] ... [/type][/type] type pair 2 processed gives no change, type</span>
    <span class="comment">% pair 3 processed gives -&gt;</span>
    <span class="comment">%   1o          1c                                    3o       3c (new)             4o (new)  2o      4c (shift) 2c</span>
    <span class="comment">% [type] ... [/type]&lt;nonEnclosable kind="kind1"&gt;... [type] ... [/type]&lt;/nonEnclosable&gt;[type][type] ... [/type][/type] -&gt;</span>

    changesMade = true;
    <span class="keyword">while</span> changesMade
        changesMade = false;
        i = 1;
        <span class="keyword">while</span> i&lt;=length(tagOpens)
            <span class="keyword">for</span> nonEnclosableTag = {<span class="string">'&lt;p&gt;'</span>,<span class="string">'&lt;table&gt;'</span>,<span class="string">'&lt;ol&gt;'</span>,<span class="string">'&lt;ul&gt;'</span>,<span class="string">'&lt;pre&gt;'</span>,<span class="string">'&lt;div&gt;'</span>,<span class="string">'&lt;img&gt;'</span>,<span class="string">'&lt;dl&gt;'</span>,<span class="string">'&lt;h1&gt;'</span>,<span class="string">'&lt;h2&gt;'</span>,<span class="string">'&lt;h3&gt;'</span>,<span class="string">'&lt;h4&gt;'</span>,<span class="string">'&lt;h5&gt;'</span>,<span class="string">'&lt;h6&gt;'</span>}
                nonEnclosableTagAlt    = [nonEnclosableTag{:}(1:end-1) <span class="string">' '</span>];
                nonEnclosableTagCloser = [nonEnclosableTag{:}(1) <span class="string">'/'</span> nonEnclosableTag{:}(2:end)];
                <span class="keyword">if</span> contains(fstrm(tagOpens(i):tagCloses(i)), nonEnclosableTag{:}) <span class="keyword">...</span>
                || contains(fstrm(tagOpens(i):tagCloses(i)), nonEnclosableTagAlt) <span class="keyword">...</span>
                || contains(fstrm(tagOpens(i):tagCloses(i)), nonEnclosableTagCloser)
                    nonEnclosableTagOpens  = strfind(fstrm(tagOpens(i):tagCloses(i)), nonEnclosableTag{:}) + tagOpens(i) - 1;
                    nonEnclosableTagOpens  = sort( [ nonEnclosableTagOpens strfind(fstrm(tagOpens(i):tagCloses(i)), nonEnclosableTagAlt)+tagOpens(i)-1 ] );
                    nonEnclosableTagCloses = strfind(fstrm(tagOpens(i):tagCloses(i)), nonEnclosableTagCloser) + tagOpens(i) - 1;
                    addKindToTag = false;
                    <span class="keyword">if</span> ~isempty(nonEnclosableTagOpens) &amp;&amp; ~isempty(nonEnclosableTagCloses) &amp;&amp; nonEnclosableTagOpens(1)&lt;nonEnclosableTagCloses(end)
                        <span class="keyword">if</span> ~strcmp(nonEnclosableTag{:},<span class="string">'&lt;img&gt;'</span>), addKindToTag = true; <span class="keyword">end</span>
                        newTagCloseInsertPos = nonEnclosableTagOpens(1)-1;
                        newTagOpenInsertPos  = nonEnclosableTagCloses(end)+length(nonEnclosableTagCloser) + length(type)+2;
                    <span class="keyword">elseif</span> ~isempty(nonEnclosableTagOpens)
                        newTagCloseInsertPos = nonEnclosableTagOpens(1)-1;
                        newTagOpenInsertPos  = strfind(fstrm(nonEnclosableTagOpens(1):tagCloses(i)),<span class="string">'&gt;'</span>) + nonEnclosableTagOpens(1) - 1;
                        newTagOpenInsertPos  = newTagOpenInsertPos(1) + length(type)+3;
                    <span class="keyword">else</span>
                        newTagCloseInsertPos = nonEnclosableTagCloses(end)-1;
                        newTagOpenInsertPos  = nonEnclosableTagCloses(end)+length(nonEnclosableTagCloser) + length(type)+2;
                    <span class="keyword">end</span>
                    <span class="keyword">if</span> addKindToTag
                        tagClose = strfind(fstrm(nonEnclosableTagOpens(1):tagCloses(i)),<span class="string">'&gt;'</span>);
                        tagClose = tagClose(1) + nonEnclosableTagOpens(1) - 1;
                        [insertStr, insertIdx] = add_to_html_tag(kind, get_val(vals,i), fstrm, nonEnclosableTag{:}(2:end-1),<span class="keyword">...</span>
                                                                 nonEnclosableTagOpens(1), tagClose);
                        fstrm = [fstrm(1:insertIdx-1) insertStr fstrm(insertIdx:end)];
                        update_idxs(insertIdx, length(insertStr));
                        newTagOpenInsertPos = newTagOpenInsertPos + length(insertStr);
                    <span class="keyword">end</span>
                    <span class="comment">% insert new [/type] tag</span>
                    fstrm = [fstrm(1:newTagCloseInsertPos) <span class="string">'[/'</span> type <span class="string">']'</span> fstrm(newTagCloseInsertPos+1:end)];
                    update_idxs(newTagCloseInsertPos+1, length(type)+3);
                    <span class="comment">% insert new [type] tag</span>
                    tagLength = 1+tagEnds(i)-tagOpens(i);
                    fstrm = [fstrm(1:newTagOpenInsertPos) fstrm(tagOpens(i):tagEnds(i)) fstrm(newTagOpenInsertPos+1:end)];
                    tagOpens  = [tagOpens(1:i)    newTagOpenInsertPos+1         tagOpens(i+1:end)];
                    tagEnds   = [tagEnds(1:i)     newTagOpenInsertPos+tagLength tagEnds(i+1:end) ];
                    tagCloses = [tagCloses(1:i-1) newTagCloseInsertPos+1        tagCloses(i:end) ];
                    update_idxs(newTagOpenInsertPos, tagLength);
                    tagOpens(i+1) = newTagOpenInsertPos+1;
                    tagEnds(i+1)  = newTagOpenInsertPos+tagLength;
                    vals = [vals(1:i) vals(i) vals(i+1:end)];
                    changesMade = true;
                    <span class="keyword">break</span>;
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            i = i + 1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), [<span class="string">'after processing ['</span> type <span class="string">'] tags enclosing html tags.html'</span>], 1); <span class="keyword">end</span>
    <span class="comment">% delete consecutive [type][/type] tags</span>
    i = 1;
    <span class="keyword">while</span> i &lt;= length(tagOpens)
        <span class="keyword">if</span> tagEnds(i)+1==tagCloses(i)
            fstrm(tagOpens(i):tagCloses(i)+length(type)+2) = [];
            update_idxs(tagCloses(i), -(tagCloses(i)+length(type)+3-tagOpens(i)));
            tagOpens(i)  = [];
            tagCloses(i) = [];
            tagEnds(i)   = [];
            vals(i)      = [];
        <span class="keyword">else</span>
            i = i + 1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), [<span class="string">'after removing consecutive ['</span> type <span class="string">']['</span> type <span class="string">'close] tags.html'</span>], 1); <span class="keyword">end</span>

    <span class="keyword">for</span> i = 1:length(tagOpens)
        <span class="keyword">if</span> strcmp(type,<span class="string">'class'</span>) &amp;&amp; ismember(get_val(vals,i),{<span class="string">'codeinput'</span>,<span class="string">'codeoutput'</span>,<span class="string">'error'</span>}), htmlTag = <span class="string">'pre'</span>;
        <span class="keyword">else</span>                                                                                   , htmlTag = <span class="string">'span'</span>; <span class="keyword">end</span>
        spanOpen = strfind(fstrm(1:tagOpens(i)),[<span class="string">'&lt;'</span> htmlTag <span class="string">' '</span>]); <span class="comment">% could be "pre" rather than "span", but haven't changed variable names</span>
        <span class="keyword">if</span> ~isempty(spanOpen)
            spanOpen  = spanOpen(end);
            spanClose = strfind(fstrm(spanOpen:tagOpens(i)),<span class="string">'&gt;'</span>);
            <span class="keyword">if</span> ~isempty(spanClose), spanClose = spanClose(1) +spanOpen-1; <span class="keyword">end</span>
            <span class="keyword">if</span> ~strcmp(sscanf(fstrm(spanClose:tagOpens(i)),<span class="string">'%s'</span>),<span class="string">'&gt;['</span>)
                spanOpen = [];
            <span class="keyword">end</span>
        <span class="keyword">end</span> <span class="comment">% '&lt;/span&gt;'</span>
        <span class="keyword">if</span> ( ~isempty(spanOpen) || strcmp(fstrm(tagEnds(i)+1:tagEnds(i)+length(htmlTag)+2),[<span class="string">'&lt;'</span> htmlTag <span class="string">' '</span>]) ) <span class="keyword">...</span>
        &amp;&amp; (   strcmp(fstrm(tagCloses(i)-(length(htmlTag)+3):tagCloses(i)-1),[<span class="string">'&lt;/'</span> htmlTag <span class="string">'&gt;'</span>])                           <span class="keyword">...</span>
            || strcmp(fstrm(tagCloses(i)+length(type)+3:tagCloses(i)+length(type)+3+length(htmlTag)+2),[<span class="string">'&lt;/'</span> htmlTag <span class="string">'&gt;'</span>])    )
            <span class="comment">% [typex]&lt;span kind="blah&gt; -&gt; &lt;span kind="x blah (or "pre" rather than "span")</span>
            <span class="comment">% or &lt;span kind="blah&gt;[typex] -&gt; &lt;span kind="x blah</span>
            <span class="keyword">if</span> isempty(spanOpen)
                spanOpen  = tagEnds(i)+1;
                spanClose = strfind(fstrm(tagEnds(i):tagCloses(i)),<span class="string">'&gt;'</span>);
                spanClose = spanClose(1) + tagEnds(i) - 1;
            <span class="keyword">end</span>
            [insertStr, insertIdx] = add_to_html_tag(kind, get_val(vals,i), fstrm, htmlTag, spanOpen, spanClose);
            <span class="comment">% remove &lt;/span&gt; or &lt;/pre&gt; (will be replaced later)</span>
            <span class="keyword">if</span> strcmp(fstrm(tagCloses(i)-(length(htmlTag)+3):tagCloses(i)-1),[<span class="string">'&lt;/'</span> htmlTag <span class="string">'&gt;'</span>])
                fstrm(tagCloses(i)-(length(htmlTag)+3):tagCloses(i)-1)=[];
                tagCloses(tagCloses&gt;tagCloses(i)-1) = tagCloses(tagCloses&gt;tagCloses(i)-1) - (length(htmlTag)+3);
            <span class="keyword">else</span>
                fstrm(tagCloses(i)+length(type)+3:tagCloses(i)+length(type)+3+length(htmlTag)+2)=[];
                tagCloses(tagCloses&gt;tagCloses(i)) = tagCloses(tagCloses&gt;tagCloses(i)) - (length(htmlTag)+3);
            <span class="keyword">end</span>
            tagEnds (tagEnds &gt;tagCloses(i)) = tagEnds (tagEnds &gt;tagCloses(i)) - (length(htmlTag)+3);
            tagOpens(tagOpens&gt;tagCloses(i)) = tagOpens(tagOpens&gt;tagCloses(i)) - (length(htmlTag)+3);
        <span class="keyword">else</span>
            <span class="comment">% [type] -&gt; &lt;span kind="x"&gt; or &lt;pre kind="x"&gt;</span>
            insertStr = [<span class="string">'&lt;'</span> htmlTag <span class="string">' '</span> kind <span class="string">'="'</span> get_val(vals,i) <span class="string">'"&gt;'</span>];
            insertIdx = tagEnds(i)+1;
        <span class="keyword">end</span>
        fstrm = [fstrm(1:insertIdx-1) insertStr fstrm(insertIdx:end)];
        <span class="keyword">if</span> insertIdx&lt;tagOpens(i), fstrm(tagOpens(i)+length(insertStr):tagEnds(i)+length(insertStr)) = [];
        <span class="keyword">else</span>                    , fstrm(tagOpens(i):tagEnds(i)) = []; <span class="keyword">end</span>
        noOfCharsToRemove = 1+tagEnds(i)-tagOpens(i);
        charIncrease      = length(insertStr) - noOfCharsToRemove;
        update_idxs(insertIdx-1, charIncrease);
        <span class="comment">% [/"type"] -&gt; &lt;/span&gt; or &lt;/pre&gt;</span>
        closeTagLength = length(type)+3;
        insertPoint    = tagCloses(i)-1;
        fstrm = [fstrm(1:insertPoint) [<span class="string">'&lt;/'</span> htmlTag <span class="string">'&gt;'</span>] fstrm(insertPoint+1+closeTagLength:end)];
        update_idxs(tagCloses(i), (length(htmlTag)+3) - closeTagLength)
    <span class="keyword">end</span>

    <span class="keyword">function</span> update_idxs(insertPoint, idxAdj)
        tagEnds  (tagOpens &gt;insertPoint) = tagEnds  (tagOpens &gt;insertPoint) + idxAdj;
        tagCloses(tagCloses&gt;insertPoint) = tagCloses(tagCloses&gt;insertPoint) + idxAdj;
        tagOpens (tagOpens &gt;insertPoint) = tagOpens (tagOpens &gt;insertPoint) + idxAdj;
        htmlEnd = htmlEnd + idxAdj;
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> [insertStr, insertIdx] = add_to_html_tag(kind, val, fstrm, htmlTag, tagOpen, tagClose)
<span class="comment">% kind:     String defining the kind of attribute to be added to the htmlTag, e.g. 'style' or 'class'</span>
<span class="comment">% val :     The value of the attribute e.g. 'margin-bottom:10px'</span>
<span class="comment">% fstrm:    The html file in memory</span>
<span class="comment">% htmlTag:  String defining the html tag that the style or class will be applied to, and should not include the "&lt;" or "&gt;". e.g., if adding a style to a</span>
<span class="comment">%           table, htmlTag would be set to 'table'</span>
<span class="comment">% tagOpen:  Position of opening of tag in fstrm</span>
<span class="comment">% tagClose: Position of closing of tag (i.e., the tag's "&gt;" character</span>
    <span class="keyword">for</span> lookForStr = {[kind <span class="string">'="'</span>],[kind <span class="string">' ="'</span>],[kind <span class="string">'= "'</span>],[kind <span class="string">' = "'</span>]}
        lookForIdx = strfind(fstrm(tagOpen:tagClose),lookForStr{:});
        <span class="keyword">if</span> ~isempty(lookForIdx)
            lookForIdx = lookForIdx(1) + tagOpen - 1;
            insertStr  = [val <span class="string">' '</span>];
            insertIdx  = lookForIdx+length(lookForStr{:});
            <span class="keyword">break</span>;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> isempty(lookForIdx)
        insertStr = [<span class="string">' '</span> kind <span class="string">'="'</span> val <span class="string">'"'</span>];
        insertIdx = tagOpen+length(htmlTag)+1;
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> [tagOpens, tagCloses] = get_tag_pairs(tag, fstrm, htmlEnd)
    closeTag  = [<span class="string">'[/'</span> tag(2:end)];
    <span class="keyword">if</span> ismember(tag,{<span class="string">'[jumpto]'</span>,<span class="string">'[scale]'</span>,<span class="string">'[colour]'</span>,<span class="string">'[class]'</span>}), openTag = tag(1:end-1);
    <span class="keyword">else</span>                                                        , openTag = tag;         <span class="keyword">end</span>
    tagOpens  = strfind(fstrm(1:htmlEnd),openTag);
    tagCloses = strfind(fstrm(1:htmlEnd),closeTag);
    <span class="keyword">try</span>
        assert( length(tagOpens)==length(tagCloses), <span class="string">'ERROR: Number of %s tags (%i) does not match number of %s tags (%i)'</span>, <span class="keyword">...</span>
                                                             tag, length(tagOpens), closeTag, length(tagCloses));
        <span class="keyword">if</span> ~ismember(tag,{<span class="string">'[class]'</span>,<span class="string">'[dtls]'</span>}), check_tag_pairs(tagOpens, tagCloses, tag); <span class="keyword">end</span>
    <span class="keyword">catch</span> MEx
        throwAsCaller(MEx)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> check_tag_pairs(tagOpens, tagCloses, type)
    <span class="keyword">if</span> isempty(tagOpens), <span class="keyword">return</span>, <span class="keyword">end</span>
    <span class="keyword">try</span>
        closeBeforeOpenError = <span class="string">'ERROR: %s close tag %i appears before open tag %i'</span>;
        <span class="keyword">for</span> i = 1:length(tagOpens)-1
            assert(tagOpens(i)&lt;tagCloses(i),closeBeforeOpenError,type,i,i);
            assert(tagCloses(i)&lt;tagOpens(i+1),<span class="string">'ERROR: %s open tag %i appears before close tag %i'</span>,type,i+1,i);
        <span class="keyword">end</span>
        <span class="keyword">if</span> isempty(i), i = 1; <span class="keyword">end</span>
        assert(tagOpens(i)&lt;tagCloses(i),closeBeforeOpenError,type,i,i);
    <span class="keyword">catch</span> MEx
        throwAsCaller(MEx)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> [countOfTags, tagCloses] = sort_tag_closes(tagOpens, tagCloses)
    countOfTags       = length(tagOpens);
    tagClosesUnsorted = tagCloses;
    tagCloses(:) = 0;
    <span class="keyword">for</span> i = 1:countOfTags
        tagCloseIdx = 1;
        <span class="keyword">while</span> i+tagCloseIdx&lt;=countOfTags &amp;&amp; tagClosesUnsorted(tagCloseIdx)&gt;tagOpens(i+tagCloseIdx), tagCloseIdx = tagCloseIdx+1; <span class="keyword">end</span>
        tagCloses(i) = tagClosesUnsorted(tagCloseIdx);
        tagClosesUnsorted(tagCloseIdx) = [];
    <span class="keyword">end</span>
    assert(~any(tagCloses==0),<span class="string">'prettifyMATLABhtml:internalError'</span>,<span class="string">'Failed to sort nested tags'</span>);
<span class="keyword">end</span>
</pre><h2 id="60">&nbsp;&nbsp;&nbsp;&nbsp;Get path of this .m file</h2><pre class="codeinput"><span class="keyword">function</span> myPath = my_path()
<span class="comment">%</span>
<span class="comment">%   NOTE: path returned includes trailing file separator</span>
<span class="comment">%</span>
    myName = mfilename();
    myPath = mfilename(<span class="string">'fullpath'</span>);
    myPath = myPath(1:end-length(myName));
<span class="keyword">end</span>
</pre><h2 id="61">&nbsp;&nbsp;&nbsp;&nbsp;Save handle to built-in Publish function</h2><pre class="codeinput"><span class="keyword">function</span> save_publish_handle
    publishName = which(<span class="string">'publish'</span>);
    <span class="keyword">if</span> ~strcmp(publishName(end-1:end),<span class="string">'.p'</span>)
        error([<span class="string">'ERROR: You must run this before MATLAB''s "publish" function has been overloaded.'</span><span class="keyword">...</span>
               <span class="string">' In other words, the custom "publish" function must not be on the MATLAB path when you run save_publish_handle.'</span>]);
    <span class="keyword">else</span>
        setappdata(0,<span class="string">'real_publish'</span>,@publish);
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2 id="62">&nbsp;&nbsp;&nbsp;&nbsp;Warning functions</h2><pre class="codeinput"><span class="keyword">function</span> warningsIssued = show_warning(msg)
    <span class="keyword">persistent</span> warnCounter
    <span class="keyword">if</span> islogical(msg), warnCounter = []; <span class="keyword">return</span>; <span class="keyword">end</span>
    <span class="keyword">if</span> isempty(msg), warningsIssued = warnCounter; <span class="keyword">return</span>, <span class="keyword">end</span>
    <span class="keyword">if</span> isempty(warnCounter)
        fprintf(1, wrap_text(sprintf(<span class="string">'\n%s: prettify_MATLAB_html [\\bWARNING%cmessages:]\\b\n'</span>, datestr(now),char(160)),<span class="string">''</span>)); warnCounter = 0;
    <span class="keyword">end</span>
    warnCounter = warnCounter + 1;
    fprintf(1,<span class="string">'\n%i. [\b%s]\b\n'</span>, warnCounter, wrap_text(msg,<span class="string">'   '</span>));
<span class="keyword">end</span>

<span class="keyword">function</span> wrappedText = wrap_text(str, lineStart)
    commandWindowSize = get(0, <span class="string">'CommandWindowSize'</span>);
    numCols           = commandWindowSize(1)-2-length(lineStart);

    <span class="keyword">if</span> length(str)&lt;= numCols, wrappedText = str; <span class="keyword">return</span>; <span class="keyword">end</span>
    lines = strsplit(str,<span class="string">'\n'</span>);
    lineCounter = 1;
    <span class="keyword">while</span> lineCounter&lt;=length(lines)
        <span class="keyword">if</span> length(lines{lineCounter}) &gt; numCols
            lastChar = 1;
            spaces   = strfind(lines{lineCounter},<span class="string">' '</span>);
            insertNewLine = spaces(find(spaces&lt;=numCols,1,<span class="string">'last'</span>));
            <span class="keyword">if</span> isempty(insertNewLine)
                insertNewLine = numCols;
                lastChar      = 0;
            <span class="keyword">end</span>
            lines = [lines(1:lineCounter) {lines{lineCounter}(insertNewLine+1:end)} lines(lineCounter+1:end)];
            lines{lineCounter} = lines{lineCounter}(1:insertNewLine-lastChar);
        <span class="keyword">end</span>
        lineCounter = lineCounter + 1;
    <span class="keyword">end</span>
    wrappedText = strjoin(lines,[NL lineStart]);
<span class="keyword">end</span>
</pre><h2 id="63">&nbsp;&nbsp;&nbsp;&nbsp;Toolbar button functions</h2><pre class="codeinput"><span class="keyword">function</span> insert_target(document)
    targetTagList = strfind(document.Text,<span class="string">'[target'</span>);
    [~, ~, ~, ~, targetIDList, ~] = find_valid_prettify_tags(<span class="string">'target'</span>, targetTagList, [], [], document.Text, length(document.Text));
    <span class="keyword">if</span> ~isempty(targetIDList), targetID = max(targetIDList)+1;
    <span class="keyword">else</span>                     , targetID = 1; <span class="keyword">end</span>
    document.insertTextAtPositionInLine([<span class="string">'[target'</span> num2str(targetID) <span class="string">']'</span>], document.Selection(1), document.Selection(2))
<span class="keyword">end</span>

<span class="keyword">function</span> insert_table(document)
    <span class="keyword">if</span> document.Selection(2)&gt;1, document.goToPositionInLine(document.Selection(1)+1,1); <span class="keyword">end</span>
    HTML_TABLE_TEMPLATE = [<span class="string">'%'</span> NL <span class="keyword">...</span>
                           <span class="string">'% &lt;html&gt;'</span> NL <span class="keyword">...</span>
                           <span class="string">'% &lt;table class="MATLAB-Help"&gt;'</span> NL <span class="keyword">...</span>
                           <span class="string">'% &lt;thead&gt;&lt;tr&gt;'</span> NL <span class="keyword">...</span>
                           <span class="string">'%    &lt;th&gt;COLUMN1 HEADING&lt;/th&gt;'</span> NL <span class="keyword">...</span>
                           <span class="string">'%    &lt;th&gt;COLUMN2 HEADING&lt;/th&gt;'</span> NL <span class="keyword">...</span>
                           <span class="string">'% &lt;/tr&gt;&lt;/thead&gt;'</span> NL <span class="keyword">...</span>
                           <span class="string">'%    &lt;tr&gt;&lt;td&gt;CELL1&lt;/td&gt;&lt;td&gt;CELL2&lt;/td&gt;&lt;/tr&gt;'</span> NL <span class="keyword">...</span>
                           <span class="string">'%    &lt;tr&gt;&lt;td&gt;CELL3&lt;/td&gt;&lt;td&gt;CELL4&lt;/td&gt;&lt;/tr&gt;'</span> NL <span class="keyword">...</span>
                           <span class="string">'% &lt;/table&gt;'</span> NL <span class="keyword">...</span>
                           <span class="string">'% &lt;/html&gt;'</span> NL <span class="keyword">...</span>
                           <span class="string">'%'</span> NL];
    document.insertTextAtPositionInLine(HTML_TABLE_TEMPLATE, document.Selection(1), document.Selection(2))
<span class="keyword">end</span>

<span class="keyword">function</span> jumpton_wrap(document)
    targetTagList = strfind(document.Text,<span class="string">'[target'</span>);
    [~, ~, ~, ~, targetIDList, ~] = find_valid_prettify_tags(<span class="string">'target'</span>, targetTagList, [], [], document.Text, length(document.Text));
    targetIDList(targetIDList==0) = [];
    targetID = 0;
    <span class="keyword">if</span> ~isempty(targetIDList)
        <span class="keyword">if</span> length(targetIDList) &gt; 1
            targetIDList = sort(targetIDList);
            targetList   = arrayfun(@num2str,targetIDList,<span class="string">'UniformOutput'</span>,false);
            [indx, tf]   = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select target ID'</span>,<span class="string">'ListString'</span>,targetList,<span class="string">'SelectionMode'</span>,<span class="string">'single'</span>);
            <span class="keyword">if</span> tf, targetID = targetIDList(indx); <span class="keyword">end</span>
        <span class="keyword">else</span>
            targetID = targetIDList;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    wrap_text_in_tag(document, <span class="string">'[jumpto'</span>, targetID);
<span class="keyword">end</span>

<span class="keyword">function</span> class_wrap(document)
    [~, classNames] = process_cssClasses_tags(document.Text, true);
    <span class="keyword">if</span> contains(document.Text,<span class="string">'[themesEnabled]'</span>), classNames = [classNames {<span class="string">'show-if-light'</span>, <span class="string">'show-if-dark'</span>}]; <span class="keyword">end</span>
    className = <span class="string">'CLASS-NAME'</span>;
    <span class="keyword">if</span> ~isempty(classNames)
        <span class="keyword">if</span> length(classNames) &gt; 1
            [indx, tf]   = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select class name'</span>,<span class="string">'ListString'</span>,classNames,<span class="string">'SelectionMode'</span>,<span class="string">'single'</span>);
            <span class="keyword">if</span> tf, className = classNames(indx);
            <span class="keyword">else</span> , <span class="keyword">return</span>, <span class="keyword">end</span>
        <span class="keyword">else</span>
            className = classNames{1};
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> iscell(className), className = className{1}; <span class="keyword">end</span>
    wrap_text_in_tag(document, <span class="string">'[class'</span>, [<span class="string">'.'</span> className]);
<span class="keyword">end</span>

<span class="keyword">function</span> colour_wrap(document)
    c = uisetcolor;
    <span class="keyword">if</span> c==0, <span class="keyword">return</span>;
    <span class="keyword">else</span>   , c = round(255*c); c = [upper(dec2hex(c(1),2)) upper(dec2hex(c(2),2)) upper(dec2hex(c(3),2))]; <span class="keyword">end</span>
    wrap_text_in_tag(document, <span class="string">'[colour'</span>, c);
<span class="keyword">end</span>

<span class="keyword">function</span> wrap_text_in_tag(document, openTag, n)
    WHITE_SPACE  = char([9:13 32 133 160]);
    PUNCTUATION  = <span class="string">'(),.;:'</span>;
    <span class="keyword">if</span> strcmp(openTag,<span class="string">'[cssClasses]'</span>) &amp;&amp; contains(document.Text, openTag)
        uiwait(msgbox([<span class="string">'A cssClasses block already exists'</span> NL <span class="string">'Source files should have only one cssClasses block'</span>],<span class="string">''</span>,<span class="string">'help'</span>,<span class="string">'modal'</span>)); <span class="keyword">return</span>, <span class="keyword">end</span>
    selectedText = document.SelectedText;
    closeTag = [openTag(1) <span class="string">'/'</span> openTag(2:end)];
    <span class="keyword">if</span> nargin==3
        <span class="keyword">if</span> ~ischar(n)
            <span class="keyword">if</span> n == 0, n = <span class="string">'n'</span>;
            <span class="keyword">else</span>     , n = num2str(n); <span class="keyword">end</span>
        <span class="keyword">end</span>
        openTag = [openTag n <span class="string">']'</span>];
        closeTag(end+1) = <span class="string">']'</span>;
    <span class="keyword">end</span>
    <span class="comment">% convert the selection from Lines/Columns to index</span>
    selectionPosition = document.Selection;
    startPos          = matlab.desktop.editor.positionInLineToIndex(document, selectionPosition(1), selectionPosition(2));
    endPos            = matlab.desktop.editor.positionInLineToIndex(document, selectionPosition(3), selectionPosition(4));

    <span class="keyword">if</span> ~isempty(selectedText)
        <span class="keyword">while</span> startPos&gt;1
            <span class="keyword">if</span> ~ismember(document.Text(startPos-1),[WHITE_SPACE PUNCTUATION <span class="string">']'</span>]), startPos = startPos-1;
            <span class="keyword">else</span>                                                                 , <span class="keyword">break</span>,                 <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">while</span> endPos&lt;=(length(document.Text)-1)
            <span class="keyword">if</span> ~ismember(document.Text(endPos),[WHITE_SPACE PUNCTUATION <span class="string">'['</span>]), endPos = endPos+1;
            <span class="keyword">else</span>                                                             , <span class="keyword">break</span>,             <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> ismember(document.Text(startPos),{<span class="string">'*'</span>,<span class="string">'_'</span>,<span class="string">'&lt;'</span>,<span class="string">'|'</span>,<span class="string">'$'</span>}), openTag(end+1)  = <span class="string">' '</span>;     <span class="keyword">end</span>
        <span class="keyword">if</span> ismember(document.Text(endPos-1),{<span class="string">'*'</span>,<span class="string">'_'</span>,<span class="string">'&gt;'</span>,<span class="string">'|'</span>,<span class="string">'$'</span>}), closeTag = [<span class="string">' '</span> closeTag]; <span class="keyword">end</span>
    <span class="keyword">end</span>
    wrappedText   = [openTag document.Text(startPos:endPos-1) closeTag];
    document.Text = [document.Text(1:startPos-1) wrappedText document.Text(endPos:end)];
    <span class="comment">% Re-select</span>
    [selectionPosition(1), selectionPosition(2)] = matlab.desktop.editor.indexToPositionInLine(document, startPos+length(openTag));
    [selectionPosition(3), selectionPosition(4)] = matlab.desktop.editor.indexToPositionInLine(document, endPos  +length(openTag));
    document.Selection = selectionPosition;
<span class="keyword">end</span>

<span class="keyword">function</span> add_pretty_commands_to_toolbar
    PRETTY_CATEGORY = <span class="string">'PRETTIFY'</span>;
    COMMAND_LIST    = {<span class="string">'dtls'</span>,<span class="string">'smry'</span>,<span class="string">'targetn'</span>,<span class="string">'jumpton'</span>,<span class="string">'cssClasses'</span>,<span class="string">'class'</span>,<span class="string">'scale'</span>,<span class="string">'colour'</span>,<span class="string">'html table'</span>};
    COMMAND_START   = <span class="string">'prettify_MATLAB_html([],[],[],'</span>;
    COMMAND_FUNC    = {[COMMAND_START <span class="string">'''[dtls]'')'</span>],[COMMAND_START <span class="string">'''[smry]'')'</span>],[COMMAND_START <span class="string">'''target'')'</span>],[COMMAND_START <span class="string">'''jumpto'')'</span>],<span class="keyword">...</span>
                       [COMMAND_START <span class="string">'''[cssClasses]'')'</span>],[COMMAND_START <span class="string">'''class'')'</span>],[COMMAND_START <span class="string">'''scale'')'</span>],[COMMAND_START <span class="string">'''colour'')'</span>],<span class="keyword">...</span>
                       [COMMAND_START <span class="string">'''table'')'</span>]};
    fprintf(1,<span class="string">'\n'</span>);
    foundFlag(length(COMMAND_LIST)) = false;
    <span class="keyword">if</span> verLessThan(<span class="string">'matlab'</span>,<span class="string">'9.4'</span>)
        <span class="comment">% add shortcuts</span>
        scUtils   = com.mathworks.mlwidgets.shortcuts.ShortcutUtils;
        scVector  = scUtils.getShortcutsByCategory(PRETTY_CATEGORY);
        scArray   = scVector.toArray;  <span class="comment">% Java array</span>
        <span class="keyword">for</span> scIdx = 1:length(scArray)
           scName = char(scArray(scIdx));
           [alreadyExists, idx] = ismember(scName, COMMAND_LIST);
           <span class="keyword">if</span> alreadyExists, foundFlag(idx) = true; <span class="keyword">end</span>
        <span class="keyword">end</span>
        i = 1:length(COMMAND_LIST);
        <span class="keyword">for</span> i = i(~foundFlag)
            scUtils.addShortcutToBottom(COMMAND_LIST{i},COMMAND_FUNC{i},[<span class="string">'Lower Case '</span> COMMAND_LIST{i}(1)], PRETTY_CATEGORY, <span class="string">'true'</span>);
        <span class="keyword">end</span>
        <span class="keyword">if</span> isempty(i), fprintf(1,<span class="string">'[\bAll shortcuts already exist]\b\n'</span>);
        <span class="keyword">else</span>         , fprintf(1,<span class="string">'[\bShortcuts created]\b\n'</span>); <span class="keyword">end</span>
        MSG_END = <span class="string">' - please add the shortcuts to the Quick-Access Toolbar manually]\b\n'</span>;
        QA_XML  = [prefdir filesep <span class="string">'MATLABQuickAccess.xml'</span>];
        <span class="keyword">if</span> ~exist(QA_XML,<span class="string">'file'</span>)
            fprintf(1,[<span class="string">'[\bCouldn''t find the Quick Access xml file'</span> MSG_END]);
        <span class="keyword">elseif</span> exist([QA_XML <span class="string">'.bak'</span>],<span class="string">'file'</span>) <span class="keyword">...</span>
            || (   ~exist([QA_XML <span class="string">'.bak'</span>],<span class="string">'file'</span>) <span class="keyword">...</span>
                &amp;&amp; copyfile(QA_XML, [QA_XML <span class="string">'.bak'</span>]) )
            fstrm        = read_file_to_mem(QA_XML);
            configStart  = strfind(fstrm,<span class="string">'&lt;quick_access_configuration&gt;'</span>);
            <span class="keyword">if</span> length(configStart)~=1, fprintf(1,[<span class="string">'[\bUnexpected Quick Access xml file format'</span> MSG_END]); <span class="keyword">return</span>, <span class="keyword">end</span>
            linesToAdd = <span class="string">''</span>;
            <span class="keyword">for</span> command = COMMAND_LIST
                <span class="keyword">if</span> ~contains(char(fstrm), command{:})
                linesToAdd = [linesToAdd <span class="string">'   &lt;tool display_condition="always" label_visible="true" section_id="PRETTIFY" tab_id="shortcuts" tool_id="'</span> <span class="keyword">...</span>
                              command{:} <span class="string">'" toolset_id="matlab_shortcut_toolset"/&gt;'</span> NL]; <span class="comment">%#ok&lt;AGROW&gt;</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="keyword">if</span> isempty(linesToAdd)
                fprintf(<span class="string">'[\bAll shortcuts already in Quick-Access Toolbar]\b\n'</span>);
            <span class="keyword">else</span>
                fstrm = [fstrm(1:configStart+28) linesToAdd fstrm(configStart+29:end)];
                write_fstrm_to_file(fstrm, QA_XML);
                fprintf(1,<span class="string">'[\bPlease restart MATLAB to get the Prettify MATLAB html shortcuts in the Quick-Access Toolbar]\b\n'</span>);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        <span class="comment">% add favourites</span>
        FAV_XML = [prefdir filesep <span class="string">'FavoriteCommands.xml'</span>];
        <span class="keyword">if</span> ~exist(FAV_XML,<span class="string">'file'</span>)
            fprintf(1,<span class="string">'[\bCouldn''t find Favourites xml file; may result in duplicate Favourites]\b\n'</span>);
        <span class="keyword">else</span>
            fstrm = read_file_to_mem(FAV_XML);
            <span class="keyword">for</span> i = 1:length(COMMAND_LIST), <span class="keyword">if</span> contains(char(fstrm), COMMAND_LIST{i}), foundFlag(i) = true; <span class="keyword">end</span>, <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> all(foundFlag)
            fprintf(1,<span class="string">'[\bAll Toolbar buttons already exist]\b\n'</span>);
        <span class="keyword">else</span>
            fc = com.mathworks.mlwidgets.favoritecommands.FavoriteCommands.getInstance();
            i = 1:length(COMMAND_LIST);
            <span class="keyword">for</span> i = i(~foundFlag)
                <span class="comment">% thanks to Martin Lechner at https://uk.mathworks.com/matlabcentral/answers/411846-how-to-create-favorites-by-code-command-window</span>
                <span class="comment">% for this code!</span>
                command = com.mathworks.mlwidgets.favoritecommands.FavoriteCommandProperties();
                command.setCategoryLabel(PRETTY_CATEGORY);
                command.setLabel(COMMAND_LIST{i});
                command.setCode(COMMAND_FUNC{i});
                command.setIsOnQuickToolBar(true);
                command.setIsShowingLabelOnToolBar(true);
                command.setIconName([<span class="string">'favorite_command_'</span> COMMAND_LIST{i}(1)]);
                fc.addCommand(command);
            <span class="keyword">end</span>
            fprintf(1,<span class="string">'[\bToolbar buttons created]\b\n'</span>);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    fprintf(1,<span class="string">'\n'</span>);
<span class="keyword">end</span>
</pre><h2 id="64">&nbsp;&nbsp;&nbsp;&nbsp;File read &amp; write</h2><pre class="codeinput"><span class="keyword">function</span> fstrm = read_file_to_mem(fileName)
    <span class="keyword">try</span>
        fileH = fopen(fileName,<span class="string">'r'</span>);
        fstrm = fread(fileH, <span class="string">'uchar'</span>)';
    <span class="keyword">catch</span> MEx
        fclose(fileH);
        throwAsCaller(MException(<span class="string">'prettify:fileread'</span>, sprintf(<span class="string">'ERROR: Unable to read file %s: %s'</span>, fileName, MEx.message) ));
    <span class="keyword">end</span>
    fclose(fileH);
<span class="keyword">end</span>

<span class="keyword">function</span> write_fstrm_to_file(fstrm, fileName, isDebug)
    <span class="keyword">persistent</span> debugCount
    <span class="keyword">if</span>     nargin&lt;3, isDebug = false;
    <span class="keyword">elseif</span>   isempty(isDebug), debugCount = []; <span class="keyword">return</span>, <span class="keyword">end</span>
    <span class="keyword">if</span> isDebug
        <span class="keyword">if</span> isempty(debugCount), debugCount = 0; <span class="keyword">end</span>
        debugCount = debugCount + 1;
        fileName = [<span class="string">'debug '</span> sprintf(<span class="string">'%03i'</span>,debugCount) <span class="string">'. - '</span> fileName];
    <span class="keyword">end</span>
    <span class="keyword">if</span> length(fileName)&gt;=5 &amp;&amp; strcmp(fileName(end-4:end),<span class="string">'.html'</span>)
        <span class="comment">% Insert some line breaks to make source html a bit more readable</span>
        <span class="keyword">if</span> isDebug
            <span class="comment">% have to be careful as this could change how the html renders, so be conservative when doing this for non-debug output</span>
            fstrm = strrep(fstrm,<span class="string">'&gt;&lt;'</span>,[<span class="string">'&gt;'</span> NL <span class="string">'&lt;'</span>]);
        <span class="keyword">else</span>
            [sourceStart, htmlEnd] = find_source(fstrm);
            fstrm = strrep(fstrm,<span class="string">'&gt;&lt;details'</span>,[<span class="string">'&gt;'</span> NL <span class="string">'&lt;details'</span>]);
            fstrm = strrep(fstrm,<span class="string">'&lt;/div&gt;&lt;/details&gt;'</span>,[NL <span class="string">'&lt;/div&gt;'</span> NL <span class="string">'&lt;/details&gt;'</span>]);
            fstrm = strrep(fstrm,<span class="string">'&gt;&lt;div'</span>,[<span class="string">'&gt;'</span> NL <span class="string">'&lt;div'</span>]);
            fstrm = strrep(fstrm,<span class="string">'&lt;/li&gt;&lt;li&gt;'</span>,[<span class="string">'&lt;/li&gt;'</span> NL <span class="string">'&lt;li&gt;'</span>]);
            fstrm = strrep(fstrm,<span class="string">'&gt;&lt;p'</span>,[<span class="string">'&gt;'</span> NL <span class="string">'&lt;p'</span>]);
            preLocs = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;pre'</span>) + sourceStart - 1;
            <span class="keyword">if</span> isempty(preLocs)
                fstrm = strrep(fstrm,<span class="string">'&lt;br'</span>,[NL <span class="string">'&lt;br'</span>]);
            <span class="keyword">else</span>
                preCloseLocs = strfind(fstrm(sourceStart:htmlEnd),<span class="string">'&lt;/pre&gt;'</span>) + sourceStart - 1;
                [countOfPreTags, preCloseLocs] = sort_tag_closes(preLocs, preCloseLocs);
                preLocs        = [2 preLocs];
                preCloseLocs   = [1 preCloseLocs];
                countOfPreTags = countOfPreTags + 1;
                <span class="keyword">for</span> i = 2:countOfPreTags
                    <span class="keyword">if</span> preLocs(i)&gt;max(preCloseLocs(1:i-1))
                        lengthBefore = length(fstrm);
                        fstrm = [fstrm(1:max(preCloseLocs(1:i-1))) <span class="keyword">...</span>
                                 strrep(fstrm(max(preCloseLocs(1:i-1))+1:preLocs(i)),<span class="string">'&lt;br'</span>,[NL <span class="string">'&lt;br'</span>]) fstrm(preLocs(i)+1:end)];
                        charsAdded = length(fstrm) - lengthBefore;
                        preLocs     ( preLocs      &gt; max(preCloseLocs(1:i-1)) ) = preLocs     ( preLocs      &gt; max(preCloseLocs(1:i-1))) + charsAdded;
                        preCloseLocs( preCloseLocs &gt; max(preCloseLocs(1:i-1)) ) = preCloseLocs( preCloseLocs &gt; max(preCloseLocs(1:i-1))) + charsAdded;
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
                fstrm = [fstrm(1:max(preCloseLocs)) <span class="keyword">...</span>
                         strrep(fstrm(max(preCloseLocs)+1:htmlEnd),<span class="string">'&lt;br'</span>,[NL <span class="string">'&lt;br'</span>]) fstrm(htmlEnd+1:end)];
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">try</span>
        fileH = fopen(fileName,<span class="string">'w'</span>);
        fwrite(fileH, fstrm, <span class="string">'char*1'</span>);
    <span class="keyword">catch</span> MEx
        fclose(fileH);
        throwAsCaller(MException(<span class="string">'prettify:filewrite'</span>, sprintf(<span class="string">'ERROR: Unable to write file %s: %s'</span>,fileName, MEx.message) ));
    <span class="keyword">end</span>
    fclose(fileH);
<span class="keyword">end</span>
</pre><h2 id="65">&nbsp;&nbsp;&nbsp;&nbsp;New line constant</h2><pre class="codeinput"><span class="keyword">function</span> CONST = NL, CONST = char(10); <span class="keyword">end</span> <span class="comment">%#ok&lt;CHARTEN&gt; for backwards compatibility</span>
</pre><pre class="codeoutput error">Error using prettify_MATLAB_html
    Call syntax error. Call syntax is:
    prettify_MATLAB_html(inputhtmlFile, verbose, overloadPublish, addCommandsToToolbar)
    Where inputs verbose, overloadPublish, and addCommandsToToolbar are optional.
    Click &lt;a href="matlab:ans=dir(which('prettify_MATLAB_html.m'));open([ans.folder filesep 'prettify
    documentation' filesep 'html' filesep 'prettify_MATLAB_html_helpdoc.html']);clear ans"&gt;here&lt;/a&gt; to see
    the help document for more information.

</pre><h2 id="66">==========================================================================================================================================================</h2><h2 id="67">Version history:</h2><pre class="language-matlab">1.0     -- Original release
1.1     -- Improved method <span class="string">of</span> <span class="string">closing</span> <span class="string">&lt;details&gt;</span> <span class="string">sections</span>
        -- Better handling <span class="string">of</span> <span class="string">consecutive</span> <span class="string">[/dtls][dtls]</span> <span class="string">tags</span>
1.2     -- Minor change <span class="string">to</span> <span class="string">warning</span> <span class="string">shown</span> <span class="string">if</span> <span class="string">a</span> <span class="string">targetn</span>, jumpton, or <span class="string">brx</span> <span class="string">tag</span> <span class="string">seems</span> <span class="string">a</span> <span class="string">bit</span> <span class="string">long</span>
        -- Documentation tweaks
        -- Minor code <span class="string">tidying</span>; mainly <span class="string">adding</span> <span class="string">sections</span>
2.0     -- Added support <span class="string">functions</span> <span class="string">for</span> <span class="string">adding</span> <span class="string">shortcuts</span> <span class="string">to</span> <span class="string">Quick-Access</span> <span class="string">Toolbar</span>, that <span class="string">then</span> <span class="string">allow</span> <span class="string">easy</span> <span class="string">adding</span> <span class="string">of</span> <span class="string">tags</span> <span class="string">to</span> <span class="string">source</span> <span class="string">.m</span> <span class="string">file</span>
        -- Fixed bug <span class="string">that</span> <span class="string">occurred</span> <span class="string">when</span> <span class="string">removing</span> <span class="string">malformed</span> <span class="string">[targetn]</span> <span class="string">and</span> <span class="string">[jumpton]</span> <span class="string">tags</span>
2.1     -- Improved method <span class="string">of</span> <span class="string">adding</span> <span class="string">Toolbar</span> <span class="string">buttons</span>
3.0     -- Added support <span class="string">for</span> <span class="string">new</span> <span class="string">tags:</span> <span class="string">[cssClasses]</span>, [class.class-name], [scalex], [colour#], [themesEnabled], and <span class="string">[darkAlt]</span>
        -- Added dark <span class="string">theme</span>
        -- Improved handling <span class="string">of</span> <span class="string">Toolbar</span> <span class="string">buttons</span>
        -- Other minor <span class="string">code</span> <span class="string">cleanups</span> <span class="string">and</span> <span class="string">bug</span> <span class="string">fixes</span>
3.1     -- Added workaround <span class="string">for</span> <span class="string">MATLAB</span> <span class="string">central</span> <span class="string">miscalculating</span> <span class="string">page</span> <span class="string">height</span>
3.2     -- Improved method <span class="string">of</span> <span class="string">assigning</span> <span class="string">classes</span> <span class="string">and</span> <span class="string">styles</span>
3.3     -- Fixed bug <span class="string">with</span> <span class="string">"collapse/expand</span> <span class="string">all</span> <span class="string">on</span> <span class="string">page"</span> <span class="string">link</span> <span class="string">when</span> <span class="string">page</span> <span class="string">has</span> <span class="string">no</span> <span class="string">sections</span>
3.4     -- Added support <span class="string">for</span> <span class="string">nesting</span> <span class="string">of</span> <span class="string">css</span> <span class="string">classes</span> <span class="string">e.g.</span> <span class="string">[class.a][class.b]this</span> <span class="string">item</span> <span class="string">will</span> <span class="string">be</span> <span class="string">formatted</span> <span class="string">according</span> <span class="string">to</span> <span class="string">css</span> <span class="string">classes</span> <span class="string">a</span> <span class="string">and</span> <span class="string">b[/class][/class]</span>
        -- Increased robustness <span class="string">of</span> <span class="string">enclosing</span> <span class="string">inline</span> <span class="string">html</span> <span class="string">in</span> <span class="string">[dtls]</span> <span class="string">sections</span>
3.5     -- Improved enclosing <span class="string">of</span> <span class="string">inline</span> <span class="string">html</span> <span class="string">into</span> <span class="string">[dtls]</span> <span class="string">sections</span> <span class="string">(again)</span>
        -- Improved handling <span class="string">of</span> <span class="string">nested</span> <span class="string">[colour#]</span>, [scalex], [class.class-name] tags
3.6     -- Fixed bug <span class="string">when</span> <span class="string">multiple</span> <span class="string">images</span> <span class="string">appear</span> <span class="string">inside</span> <span class="string">[dtls]</span> <span class="string">sections</span>
        -- Added Toolbar <span class="string">button</span> <span class="string">to</span> <span class="string">insert</span> <span class="string">an</span> <span class="string">html-table</span> <span class="string">template</span>
3.7     -- Added <span class="string">"built-in"</span> MATLAB <span class="string">publish</span> <span class="string">CSS</span> <span class="string">classes</span> <span class="string">codeinput</span>, codeoutput, error, keyword, comment, string, untermstring, and <span class="string">syscmd</span>, as <span class="string">valid</span> <span class="string">class</span>
           names <span class="string">when</span> <span class="string">using</span> <span class="string">the</span> <span class="string">[class.class-name]</span> <span class="string">tag</span>, although <span class="string">these</span> <span class="untermstring">won't appear in the list presented when using the "class" Toolbar button</span>
        -- Handles some <span class="string">incorrect</span> <span class="string">syntax</span> <span class="string">more</span> <span class="string">gracefully</span>
3.7.1   -- Minor code <span class="string">tidy</span>
3.8     -- Fixed bug <span class="string">with</span> <span class="string">"collapse/expand</span> <span class="string">all"</span> <span class="string">controls</span> <span class="string">for</span> <span class="string">pages</span> <span class="string">with</span> <span class="string">10</span> <span class="string">or</span> <span class="string">more</span> <span class="string">sections</span>
3.9     -- Added [frameBufferx] tag
3.10    -- Fixed bug <span class="string">associated</span> <span class="string">with</span> <span class="string">[frameBufferx]</span> <span class="string">tag</span>
3.11    -- Better handling <span class="string">of</span> <span class="string">malformed</span> <span class="string">syntax</span>
3.12    -- Improved error <span class="string">handling</span>
3.13    -- Added [imageFolder=x] tag (undocumented companion to undocumented [png2svg] tag)
3.14    -- Fixed bug <span class="string">that</span> <span class="string">occured</span> <span class="string">when</span> <span class="string">any</span> <span class="string">[dtls]</span> <span class="string">sections</span> <span class="string">were</span> <span class="string">placed</span> <span class="string">before</span> <span class="untermstring">MATLAB's auto-generated page contents list</span>
4.0     -- Enables nesting <span class="string">of</span> <span class="string">[dtls]</span> <span class="string">boxes</span>
        -- [dtls] boxes <span class="string">are</span> <span class="string">now</span> <span class="string">rounded</span> <span class="string">on</span> <span class="string">all</span> <span class="string">four</span> <span class="string">corners</span> <span class="string">when</span> <span class="string">closed</span>
        -- Improved syntax <span class="string">checking</span> <span class="string">for</span> <span class="string">[/dtls]</span> <span class="string">tags</span>
        -- Uses new <span class="string">method</span> <span class="string">to</span> <span class="string">save</span> <span class="string">theme</span> <span class="string">preference</span> <span class="string">for</span> <span class="string">better</span> <span class="string">compatibility</span> <span class="string">with</span> <span class="string">the</span> <span class="string">MATLAB</span> <span class="string">web</span> <span class="string">browser</span>
        -- [bottomMarginx] tags <span class="string">are</span> <span class="string">now</span> <span class="string">documented</span>
        -- [bottomMarginx] now <span class="string">processed</span> <span class="string">after</span> <span class="string">[dtls]</span> <span class="string">and</span> <span class="string">[smry]</span> <span class="string">tags</span>
        -- Processes [class.codeinput], [class.codeoutput], and <span class="string">[class.error]</span> <span class="string">correctly</span> <span class="string">by</span> <span class="string">using</span> <span class="string">html</span> <span class="string">&lt;pre&gt;</span> <span class="string">elements</span> <span class="string">instead</span> <span class="string">of</span> <span class="string">&lt;span&gt;</span>
        -- Added undocumented <span class="string">[removepng]</span> <span class="string">tags</span>
4.1     -- Improved syntax <span class="string">checking</span> <span class="string">for</span> <span class="string">[dtls]</span> <span class="string">tags</span>
        -- Improved handling <span class="string">of</span> <span class="string">html</span> <span class="string">in</span> <span class="string">[dtls]</span> <span class="string">boxes</span> <span class="string">(also fixes potential bug when nesting [dtls] boxes)</span>
4.2     -- Fixed issue <span class="string">with</span> <span class="string">collapse-all/expand-all</span> <span class="string">links</span> <span class="string">in</span> <span class="string">help</span> <span class="string">browser</span> <span class="string">of</span> <span class="string">recent</span> <span class="string">versions</span> <span class="string">of</span> <span class="string">MATLAB</span>
        -- Improved spacing <span class="string">after</span> <span class="string">generated</span> <span class="string">code</span> <span class="string">output</span> <span class="string">and</span> <span class="string">lists</span> <span class="string">that</span> <span class="string">appear</span> <span class="string">at</span> <span class="string">the</span> <span class="string">end</span> <span class="string">of</span> <span class="string">[dtls]</span> <span class="string">boxes</span>
4.3     -- No longer <span class="string">creates</span> <span class="string">extra</span> <span class="string">space</span> <span class="string">after</span> <span class="string">monospaced</span> <span class="string">text</span> <span class="string">(e.g. |text| )</span> <span class="string">that</span> <span class="string">is</span> <span class="string">wrapped</span> <span class="string">in</span> <span class="string">[class]</span>, [scale], or <span class="string">[colour]</span> <span class="string">tags</span>
        -- Added the <span class="string">[delsp]</span> <span class="string">tag</span>
4.4     -- Now includes <span class="string">version</span> <span class="string">number</span> <span class="string">of</span> <span class="string">prettify_MATLAB_html</span> <span class="string">in</span> <span class="string">the</span> <span class="string">footer</span> <span class="string">link</span>
4.5     -- In-page links <span class="string">now</span> <span class="string">jump</span> <span class="string">to</span> <span class="string">correct</span> <span class="string">location</span> <span class="string">if</span> <span class="string">page</span> <span class="string">is</span> <span class="string">viewed</span> <span class="string">on</span> <span class="string">Matlab</span> <span class="string">Central</span> <span class="string">(e.g. in the "Examples" tab)</span> <span class="string">or</span> <span class="string">the</span> <span class="string">MATLAB</span> <span class="string">help</span> <span class="string">browser</span> <span class="string">(the</span>
           former, and <span class="string">some</span> <span class="string">versions</span> <span class="string">of</span> <span class="string">the</span> <span class="string">latter</span>, put <span class="string">a</span> <span class="string">floating</span> <span class="string">banner</span> <span class="string">across</span> <span class="string">the</span> <span class="string">top</span> <span class="string">of</span> <span class="string">the</span> <span class="string">page</span> <span class="string">that</span> <span class="string">must</span> <span class="string">be</span> <span class="string">accounted</span> <span class="string">for</span> <span class="string">when</span> <span class="string">jumping)</span>
        -- If viewed <span class="string">on</span> <span class="string">MATLAB</span> <span class="string">Central</span>, pages <span class="string">now</span> <span class="string">have</span> <span class="string">a</span> <span class="string">scroll</span> <span class="string">bar</span>, so <span class="string">the</span> <span class="string">[framebufferx]</span> <span class="string">tag</span> <span class="string">is</span> <span class="string">no</span> <span class="string">longer</span> <span class="string">required</span>
        -- Makes in-page links <span class="string">work</span> <span class="string">for</span> <span class="string">most</span> <span class="string">browsers</span>, <span class="keyword">if</span> the page <span class="string">is</span> <span class="string">viewed</span> <span class="string">in</span> <span class="string">the</span> <span class="string">"Examples"</span> <span class="string">tab</span> <span class="string">on</span> <span class="string">MATLAB</span> <span class="string">Central</span>
5.0     -- Bug fix - improved spacing <span class="string">after</span> <span class="string">numbered</span> <span class="string">lists</span> <span class="string">that</span> <span class="string">appear</span> <span class="string">at</span> <span class="string">the</span> <span class="string">end</span> <span class="string">of</span> <span class="string">[dtls]</span> <span class="string">boxes</span> <span class="string">now</span> <span class="string">works</span>
        -- Improved spacing <span class="string">if</span> <span class="string">a</span> <span class="string">[dtls]</span> <span class="string">box</span> <span class="string">is</span> <span class="string">the</span> <span class="string">last</span> <span class="string">element</span> <span class="string">on</span> <span class="string">the</span> <span class="string">page</span>
        -- Adds a <span class="string">"return"</span> <span class="string">floating</span> <span class="string">button/link</span> <span class="string">when</span> <span class="string">user</span> <span class="string">follows</span> <span class="string">an</span> <span class="string">in-page</span> <span class="string">link</span> <span class="string">(but not if page is viewed in MATLAB help browser)</span>
        -- Documented a <span class="string">method</span> <span class="string">for</span> <span class="string">adding</span> <span class="string">headings</span> <span class="string">with</span> <span class="string">collapse/expand</span> <span class="string">links</span> <span class="string">without</span> <span class="string">adding</span> <span class="string">the</span> <span class="string">heading</span> <span class="string">to</span> <span class="string">the</span> <span class="untermstring">page's contents list</span>
5.1     -- Improved floating <span class="string">back</span> <span class="string">button</span> <span class="string">functionality</span> <span class="string">when</span> <span class="string">page</span> <span class="string">is</span> <span class="string">viewed</span> <span class="string">on</span> <span class="string">MATLAB</span> <span class="string">Central</span>
        -- More robust <span class="string">positioning</span> <span class="string">of</span> <span class="string">collapse/expand</span> <span class="string">links</span>
6.0     -- Fixed html <span class="string">5</span> <span class="string">compliance</span> <span class="string">issues</span>, some <span class="string">due</span> <span class="string">to</span> <span class="string">the</span> <span class="string">built-in</span> <span class="string">publish</span>, and <span class="string">some</span> <span class="string">due</span> <span class="string">to</span> <span class="string">prettify</span>
        -- Added [h2] and <span class="string">[h2.CElink]</span> <span class="string">tags</span> <span class="string">to</span> <span class="string">create</span> <span class="string">headings</span> <span class="string">that</span> <span class="string">are</span> <span class="string">not</span> <span class="string">added</span> <span class="string">to</span> <span class="string">the</span> <span class="untermstring">page's contents list</span>
        -- Enhanced functionality <span class="string">of</span> <span class="string">floating</span> <span class="string">"return"</span> <span class="string">link</span> <span class="string">-</span> <span class="string">arrow</span> <span class="string">direction</span> <span class="string">now</span> <span class="string">updates</span> <span class="string">as</span> <span class="string">user</span> <span class="string">scrolls</span> <span class="string">up/down</span> <span class="string">past</span> <span class="string">the</span> <span class="string">return</span> <span class="string">target</span>
6.1     -- Fixed bug <span class="string">when</span> <span class="string">processing</span> <span class="string">&lt;style&gt;&lt;/style&gt;</span> <span class="string">tags</span> <span class="string">in</span> <span class="string">embedded</span> <span class="string">html</span>
6.2     -- Fixed bug <span class="string">when</span> <span class="string">processing</span> <span class="string">nested</span> <span class="string">[class.&lt;class name&gt;]</span> <span class="string">tags</span>
6.3     -- Now allows <span class="string">negative</span> <span class="string">values</span> <span class="string">for</span> <span class="string">the</span> <span class="string">[brx]</span> <span class="string">tag</span>
6.4     -- Fixed bug <span class="string">that</span> <span class="string">could</span> <span class="string">occur</span> <span class="string">when</span> <span class="string">using</span> <span class="string">[h2.CElink]</span> <span class="string">tags</span> <span class="string">in</span> <span class="string">conjunction</span> <span class="string">with</span> <span class="string">nested</span> <span class="string">[dtls]</span> <span class="string">sections.</span>
6.4.1   -- Fixed bug <span class="string">that</span> <span class="string">could</span> <span class="string">occur</span> <span class="string">when</span> <span class="string">&lt;tt&gt;</span> <span class="string">tags</span> <span class="string">are</span> <span class="string">replaced</span> <span class="string">by</span> <span class="string">&lt;code&gt;</span> <span class="string">tags</span> <span class="string">(HTML5 validation fix)</span>
6.5     -- 15 May <span class="string">2021</span>
        -- Details boxes <span class="string">now</span> <span class="string">open</span> <span class="string">automatically</span> <span class="string">if</span> <span class="string">they</span> <span class="string">are</span> <span class="string">closed</span> <span class="string">and</span> <span class="string">the</span> <span class="string">user</span> <span class="string">clicks</span> <span class="string">an</span> <span class="string">internal</span> <span class="string">page</span> <span class="string">link</span> <span class="string">that</span> <span class="string">links</span> <span class="string">to</span> <span class="string">the</span> <span class="string">box</span>
</pre><pre class="codeinput"><span class="comment">%============================================================================================================================================================</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2022a</a><br></p></div><!--
##### SOURCE BEGIN #####
function prettify_MATLAB_html(inputhtmlFile, verbose, overloadPublish, addCommandsToToolbar)
%%  prettify_MATLAB_html(inputhtmlFile, verbose, overloadPublish, addCommandsToToolbar)
%
%   Given a MATLAB-generated HTML file as an input, this function adds additional
%   features such as disclosure boxes and expand-all/collapse-all links. This makes
%   the document more closely resemble "official" MATLAB help files.
%   It also gives extended formatting options, provides an optional dark theme, and
%   automatically enhances the formatting of inline code and images.
%
%	Version 6.5
%
%   Inputs:
%
%   inputhtmlFile:    Character vector. The name or full path of the MATLAB-generated
%                     HTML file to be processed. The file is automatically over-
%                     written by the processed file.
%
%   verbose:          Logical. Optional input to suppress the begin and end messages
%                     that are printed to the command line when prettify_MATLAB_html
%                     is run. Set to "false" to suppress the messages.
%
%   overloadPublish:  Logical. When used, the first two inputs are ignored. This is an
%                     optional input to configure an overload for MATLAB's publish
%                     function, so that when you press "publish" in the toolbar of a
%                     MATLAB editor window, the generated HTML will automatically be
%                     processed by prettify_MATLAB_html. This only needs to be done
%                     once per MATLAB session. If you put a call to:
%                     prettify_MATLAB_html([], [], true);
%                     in your startup.m file, publish will get overloaded every time
%                     you run MATLAB. To stop overloading the built-in publish
%                     function, set overloadPublish to false:
%                     prettify_MATLAB_html([], [], false);
%
%   addCommandsToToolbar:
%                     Logical. When used, the first two inputs are ignored. This is
%                     an optional input used to add shortcuts to the quick-access
%                     toolbar that then allow you to easily add prettify_MATLAB_html
%                     tags to your .m files. Set to true to add the commands.
%                     In MATLAB versions prior to 2018a, the buttons are added to your
%                     shortcuts, and you have to restart to get them to be added to the
%                     Quick-Access Toolbar. If anyone knows how to add shortcuts to the
%                     Quick-Access Toolbar programatically, without requiring a
%                     restart, please let me know: harry.dymond@bristol.ac.uk
%
%   Most prettify_MATLAB_html features require you to use additional markup "tags" in
%   the original source .m file, for example to indicate where you want the disclosure
%   boxes (the "expand"/"collapse" links are automatically generated).
%
%   See the <a href="matlab:ans=dir(which('prettify_MATLAB_html.m'));
%   open([ans.folder filesep 'prettify documentation' filesep 'html' filesep 'prettify_MATLAB_html_helpdoc.html']);
%   clear ans">help document</a> for more information

%% ==========================================================================================================================================================
%
%% Documentation :
%
%   Please see the help document: /prettify documentation/html/prettify_MATLAB_html_helpdoc.html for more information (type "help prettify_MATLAB_html" at
%   the MATLAB command line to get a clickable link to the help document).
%
%============================================================================================================================================================
%
%% Version history :
%
%   Version history is at the end of this file
%
%============================================================================================================================================================
%
%% Notes :
%
%   This file uses "sections" to help segment the code for readability. It is recommended to enable folding of sections in MATLAB's preferences, so
%   that sections can be collapsed/expanded. Lines are 157 characters wide. The position of the vertical text-limit line (if shown) may be moved by going to
%   MATLAB preferences -> Editor/Debugger -> Display -> Right-hand text limit
%
%   The code uses the following naming convention :
%       _____________________________________________
%                         |
%           Item(s)       |   Naming convention
%       __________________|__________________________
%           Variables     |   initialLowerTitleCase
%       REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH+REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%           Functions     |   lower_case(...)
%       REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH+REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%           constants     |   UPPER_CASE
%       __________________|__________________________
%
%============================================================================================================================================================
%
%% Authorship:
%
%   Written by Harry Dymond, Electrical Energy Management Group, University of Bristol, UK; harry.dymond@bris.ac.uk. If you find any bugs, please email me!
%   Developed with MATLAB R2018a running on Windows 10 and macOS Mojave.
%
%% ==========================================================================================================================================================

    %% Constants
    HELP_URL     = ['    Click <a href="matlab:ans=dir(which(''prettify_MATLAB_html.m''));' ...
                    'open([ans.folder filesep ''prettify documentation'' filesep ''html'' filesep ''prettify_MATLAB_html_helpdoc.html'']);' ...
                    'clear ans">here</a> to see the help document for more information.'];
    NO_START_ERR = 'ERROR: couldn''t find start of content in html file';
    DEBUG        = getappdata(0,'PRETTY_DEBUG'); if isempty(DEBUG), DEBUG = false; end
    %% Check sufficient inputs
    assert(nargin>=1,['    Call syntax error. Call syntax is:' NL ...
                      '    prettify_MATLAB_html(inputhtmlFile, verbose, overloadPublish, addCommandsToToolbar)' NL ...
                      '    Where inputs verbose, overloadPublish, and addCommandsToToolbar are optional.' NL HELP_URL NL]);
    try
    %% Clear show_warning and write_fstrm_to_file sub-functions
    show_warning(true)
    write_fstrm_to_file([], [], [])
    %% Overload publish
    if nargin>=3 && islogical(overloadPublish)
        PUBLISH_OVERLOAD_FOLDER_NAME = 'publish overload';
        ERROR_MSG_START = 'Not installed correctly. In the folder that contains the prettify_MATLAB_html.m file, there should be a ';
        if ~exist([my_path PUBLISH_OVERLOAD_FOLDER_NAME],'dir'), error([ERROR_MSG_START 'folder named "' PUBLISH_OVERLOAD_FOLDER_NAME '"']); end
        pathList     = strsplit(path,':');
        overloadPath = pathList(cellfun(@(str)contains(str,PUBLISH_OVERLOAD_FOLDER_NAME),pathList));
        if ~isempty(overloadPath)
            for i=1:length(overloadPath)
                overloadPath{i} = strsplit(overloadPath{i},';');
                overloadPath{i} = overloadPath{i}{1};
                rmpath(overloadPath{i});
            end
        end
        if overloadPublish
            save_publish_handle;
            if ~isempty(overloadPath), for i=1:length(overloadPath), addpath(overloadPath{i}); end
            else                                                   , addpath([my_path PUBLISH_OVERLOAD_FOLDER_NAME]); end
        end
        if nargin == 3, return; end
    end
    %% Execute toolbar functions
    if nargin==4
        if islogical(addCommandsToToolbar) && addCommandsToToolbar
            add_pretty_commands_to_toolbar;
        elseif ischar(addCommandsToToolbar)
            document = matlab.desktop.editor.getActive;
            if isempty(document), return, end
            tagName = addCommandsToToolbar;
            switch tagName
                case {'[dtls]','[smry]','[cssClasses]'}, wrap_text_in_tag(document, tagName);
                case 'target'                          , insert_target(document);
                case 'jumpto'                          , jumpton_wrap(document);
                case 'class'                           , class_wrap(document);
                case 'scale'                           , wrap_text_in_tag(document, '[scale', 'x');
                case 'colour'                          , colour_wrap(document);
                case 'table'                           , insert_table(document);
            end
        end
        return
    end
    %% Some input checking
    assert(ischar(inputhtmlFile),['ERROR: First input to prettify_MATLAB_html should be a character vector specifying '...
                                  'the html file to be processed, either by just file name, or by full path.' NL HELP_URL NL]);
    if nargin < 2 || ~islogical(verbose), verbose = true; end
    if verbose, fprintf(1,'\nReading input file...\n'); end
    fInfo = dir(inputhtmlFile);
    assert(~isempty(fInfo),['ERROR: Specified html file could not be found. Make sure the html file '...
                            'is in the present working directory, or otherwise on the MATLAB path']);
    %% Open input file
    fstrm = read_file_to_mem(inputhtmlFile);
    if verbose, fprintf(1,'Processing:\n'); end
    %% Find [cssClass] tags
    [fstrm, classNames, userCSS] = process_cssClasses_tags(fstrm);
    % add built-in classes as valid class names (not done in process_cssClasses_tags so as not to pollute class list when "class" Toolbar button is used)
    classNames     = [classNames {'codeinput', 'codeoutput', 'error', 'keyword', 'comment', 'string', 'untermstring', 'syscmd'}];
    %% Themes
    themeSwitchPos = strfind(fstrm,'<div class="content">');
    assert (~isempty(themeSwitchPos), NO_START_ERR);
    themeSwitchPos = themeSwitchPos(1) + 20;
    if ~strcmp(char(fstrm(themeSwitchPos+1:themeSwitchPos+4)),'<h1>') ...
    || strcmp(char(fstrm(themeSwitchPos+1:themeSwitchPos+9)),'<h1></h1>'), extraStr = '<div>&nbsp;</div>'; %#ok<ALIGN>
    else                                                                 , extraStr = ''                 ; end
    themeSwitch    = '';
    if contains(char(fstrm),'[themesEnabled]')
        classNames     = [classNames {'show-if-light', 'show-if-dark'}];
        themeSwitch    = ['<div><p onclick="toggle_theme()" style="text-align:right; float:right; padding-left:10px; margin:0;">'...
                          '<a href="javascript:void(0);" id="ToggleTheme">&nbsp;</a></p></div>'...
                          '<script>set_theme(null)</script>' extraStr];
        fstrm = [fstrm(1:themeSwitchPos) themeSwitch fstrm(themeSwitchPos+1:end)];
        fstrm = strrep(fstrm,'[themesEnabled]','');
    else
        fstrm = [fstrm(1:themeSwitchPos) '<script>document.getElementById("dark-theme").sheet.disabled = true;</script>' fstrm(themeSwitchPos+1:end)];
    end
    %% Define extra css
    extraCSS = [userCSS NL ...
                '#tooltiptext {' NL ...
                '  visibility: hidden;' NL ...
                '  padding: 5px 10px;' NL ...
                '  font-size: 75%;' NL ...
                '  line-height:110%;' NL ...
                '  text-align: center;' NL ...
                '  background-color: black;' NL ...
                '  color: #ddd;' NL ...
                '  border-radius: 6px;' NL ...
                '  position: fixed;' NL ...
                '  bottom: 11px;' NL ...
                '  right: 62px;' NL ...
                '  z-index: 2;' NL ...
                '}' NL ...
                '#tooltiptext::after {' NL ...
                '  content: " ";' NL ...
                '  position: absolute;' NL ...
                '  top: 50%;' NL ...
                '  left: 100%;' NL ...
                '  margin-top: -5px;' NL ...
                '  border-width: 5px;' NL ...
                '  border-style: solid;' NL ...
                '  border-color: transparent transparent transparent black;' NL ...
                '}' NL ...
                '.tooltip:hover #tooltiptext {' NL ...
                '  visibility: visible;' NL ...
                '}' NL ...
                '#return-link {' NL ...
                '    position: fixed;' NL ...
                '    bottom: 10px;' NL ...
                '    right: 10px;' NL ...
                '    overflow: visible;' NL ...
                '    font-size:120%;' NL ...
                '    background: rgba(0, 0, 0, 0.75);' NL ...
                '    border-style: solid;' NL ...
                '    border-width: 3pt;' NL ...
                '    border-color: #202020;' NL ...
                '    border-radius: 4px;' NL ...
                '    cursor: pointer;' NL ...
                '    }' NL ...
                '#return-link > p { padding:3px; margin:0; color:#C0C0C0;}' NL ...
                '.MATLAB-Help {' NL ...
                'width: 100%;' NL ...
                'margin-bottom: 12px;' NL ...
                'border: 1px solid #ccc;' NL ...
                'border-right: none;' NL ...
                'border-bottom: none;' NL ...
                'font-size: 96%;' NL ...
                'line-height: 1.4;' NL ...
                'table-layout: fixed;' NL ...
                'overflow:hidden;}' NL ...
                NL ...
                '.MATLAB-Help > thead > tr > th {' NL ...
                'padding: 6px 5px;' NL ...
                'border: none;' NL ...
                'border-right: 1px solid #ccc;' NL ...
                'border-bottom: 1px solid #ccc;' NL ...
                'background: #F2F2F2;' NL ...
                'color: #000;' NL ...
                'font-weight: bold;' NL ...
                'text-align: left;' NL ...
                'vertical-align: middle;}' NL ...
                NL ...
                '.MATLAB-Help td{padding: 5px 5px;' NL ...
                'border: none;' NL ...
                'border-right: 1px solid #ccc;' NL ...
                'border-bottom: 1px solid #ccc;' NL ...
                'vertical-align: middle;}' NL ...
                NL...
                '.language-matlab { line-height:135% }' NL NL...
                '.collapse-link {float:right; line-height:200%; padding-left:10px; margin:0}' NL NL ...
                NL ...
                'details > summary,' NL ...
                '.details-div {' NL ...
                '  padding: 8px 20px;' NL ...
                '  border-style: solid;' NL ...
                '  border-width: 1.2pt;' NL ...
                '  border-color: #E0E0E0;' NL ...
                '}' NL ...
                'details > summary {' NL ...
                '  border-radius:6px 6px 0 0;' NL ...
                '  background-color: #F2F2F2;' NL ...
                '  cursor: pointer;' NL ...
                '}' NL ...
                '.details-div {' NL ...
                '  border-top-style: none;' NL ...
                '  border-radius: 0 0 6px 6px;' NL ...
                '}' NL ...
                '.image-fit-svg,' NL ...
                '.image-fit {' NL ...
                '    max-width:  95%;' NL ...
                '    max-height: 100%;' NL ...
                '    margin:     auto;' NL ...
                '}' NL ...
                '.image-fit-svg{ padding:0px; max-width:500px; }' NL ...
                'details > img.image-fit-svg{ padding: 0px 0px 10px; }' NL ...
                '@media (max-width: 580px) {' NL ...
                '  .image-fit-svg { max-width: 95%; }' NL ...
                '}' NL ...
                '.pretty-link  { color:#001188 !important; }' NL
                ];
    darkTheme = [NL '<style id="dark-theme">' NL ...
                '    h2, h3       { color: #B0B0B0; }' NL ...
                '    html body    { background-color: #101010; color: #B0B0B0; }' NL ...
                '    .pretty-link { color: #C46313 !important; }' NL ...
                '    a, a:visited { color: #C46313 }' NL ...
                '    a:hover      { color: orange; }' NL ...
                '    details > summary,' NL ...
                '    .details-div      { border-color:     #505050; }' NL ...
                '    details > summary { background-color: #202020; }' NL ...
                '    pre.codeinput     { border-width: 1.2pt; border-color:#001B33; background:#001129; color:#F0F0F0; }' NL ...
                '    pre.codeoutput    { color:#A5A5A5; }' NL ...
                '    span.keyword      { color:#FF9D00; }' NL ...
                '    span.comment      { color:#808080; }' NL ...
                '    span.string       { color:#3AD900; }' NL ...
                '    span.untermstring { color:#FFEE80; }' NL ...
                '    span.syscmd       { color:#CCCCCC; }' NL ...
                '    .MATLAB-Help, .MATLAB-Help > thead > tr > th, .MATLAB-Help td { border-color:#505050; }' NL ...
                '    .MATLAB-Help > thead > tr > th { background: #202020; color: #B0B0B0; }' NL ...
                '    .summary-sub-heading { color:#909090; }' NL ...
                '    .show-if-light    { display:none }' NL ...
                '</style>' NL ...
                '<style id="hide-dark">' NL ...
                '     .show-if-dark { display:none }' NL ...
                '</style>'...
                NL];
    jumpShift = [NL '<style id="anchor-offsets">' NL ...
                '    h2::before, a[id]::before{' NL ...
                '    content: "";' NL ...
                '    display: block;' NL ...
                '    height: 100px;' NL ...
                '    margin: -100px 0 0;' NL ...
                '    visibility: hidden;' NL ...
                '    width:10%;' NL ...
                '    z-index: -1;' NL ...
                '}' NL ...
                '</style>' ...
                NL];
    %% Define javascript
    javaScript =   ['<script>' NL ...
                    '          var returnElem = null;' NL ...
                    '          var skipCheck  = false;' NL NL ...
                    '          function hide_back_link()' NL ...
                    '          {' NL ...
                    '              returnButton.style.display = "none";' NL ...
                    '              try{' NL ...
                    '                 window.removeEventListener("scroll", update_back_position, true);' NL ...
                    '                 window.removeEventListener("resize", update_back_position, true);' NL ...
                    '                 parent.window.removeEventListener("scroll", update_back_position, true);' NL ...
                    '                 parent.window.removeEventListener("resize", update_back_position, true);}' NL ...
                    '              catch(e){}' NL ...
                    '          }' NL NL ...
                    '          function get_offset(element)' NL ...
                    '          {' NL ...
                    '              if (!element.getClientRects().length){ return { top: 0, left: 0 }; }' NL ...
                    '              var rect = element.getBoundingClientRect();' NL ...
                    '              var win  = element.ownerDocument.defaultView;' NL ...
                    '              return ( {top:  rect.top  + win.pageYOffset,' NL ...
                    '                        left: rect.left + win.pageXOffset} );' NL ...
                    '          }' NL NL ...
                    '          function jump_to()' NL ...
                    '          {' NL ...
                    '              var clickedElem = event.target;' NL ...
                    '              var clickedID   = clickedElem.closest("span");' NL ...
                    '              if (clickedID){' NL ...
                    '                clickedID = clickedID.getAttribute("id");' NL ...
                    '                if (clickedID.localeCompare("jump-close")===0) { return };}' NL ...
                    '              clickedID = clickedElem.closest("div").getAttribute("id");' NL ...
                    '              if (clickedID && clickedID.localeCompare("return-link")===0)' NL ...
                    '              {' NL ...
                    '                  if (returnElem)' NL ...
                    '                  {' NL ...
                    '                      event.preventDefault();' NL ...
                    '                      hide_back_link();' NL ...
                    '                      returnElem.scrollIntoView();' NL ...
                    '                      if (contentDiv.getAttribute("data-isHelpBrowser")){' NL ...
                    '                         contentDiv.scrollTop = contentDiv.scrollTop-100; }' NL ...
                    '                      if (contentDiv.getAttribute("data-isMATLABCentral")){' NL ...
                    '                         parent.window.scrollBy(0,-100)}' NL ...
                    '                      returnElem = null;' NL ...
                    '                  }' NL ...
                    '              }' NL ...
                    '              else' NL ...
                    '              {' NL ...
                    '                  var href = clickedElem.closest("a").getAttribute("href");' NL ...
                    '                  if ( href && href[0] == "#" )' NL ...
                    '                  {' NL ...
                    '                     var target = document.getElementById(href.substring(1));' NL ...
                    '                     var enclosingBox = target;' NL ...
                    '                     while ( enclosingBox )' NL ...
                    '                     {' NL ...
                    '                        prevBox      = enclosingBox;' NL ...
                    '                        enclosingBox = enclosingBox.closest("details");' NL ...
                    '                        if ( enclosingBox===prevBox ){' NL ...
                    '                           enclosingBox = enclosingBox.parentElement' NL ...
                    '                           if ( enclosingBox ) { enclosingBox = enclosingBox.closest("details"); }  }' NL ...
                    '                        if (enclosingBox && !enclosingBox.open) { open_details(enclosingBox.id) }' NL ...
                    '                     }' NL ...
                    '                     if (target && in_iFrame() && !contentDiv.getAttribute("data-isHelpBrowser") ){' NL ...
                    '                        event.preventDefault();' NL ...
                    '                        target.scrollIntoView(); }' NL ...
                    '                     var nextElem = target.nextElementSibling;' NL ...
                    '                     var nextNode = target.nextSibling;' NL ...
                    '                     while ( nextNode && nextNode.nodeType==Node.TEXT_NODE && nextNode.data.trim().length == 0 ){' NL ...
                    '                        nextNode = nextNode.nextSibling;}' NL ...
                    '                     if ( nextElem && nextElem===nextNode && nextElem.localName.localeCompare("details")===0 && '...
                                                                                                                                    '!nextElem.open){' NL ...
                    '                        open_details(nextElem.id);}' NL ...
                    '                  }' NL ...
                    '                  else { return }' NL ...
                    '                  if (!contentDiv.getAttribute("data-isHelpBrowser"))' NL ...
                    '                  {' NL ...
                    '                      update_back_position();' NL ...
                    '                      returnButton.style.display = "block";' NL ...
                    '                      var linkTop   = clickedElem.offsetTop;' NL ...
                    '                      var targetTop = target.offsetTop;' NL ...
                    '                      if (targetTop>linkTop){' NL ...
                    '                          document.getElementById("down").style.display = "none";' NL ...
                    '                          document.getElementById("up").style.display   = "inline"; }' NL ...
                    '                      else{' NL ...
                    '                          document.getElementById("up").style.display   = "none";' NL ...
                    '                          document.getElementById("down").style.display = "inline"; }' NL ...
                    '                      returnElem = clickedElem;' NL ...
                    '                  }' NL ...
                    '              }' NL ...
                    '          }' NL NL ...
                    '          function open_details(detailsID)' NL ...
                    '          {' NL ...
                    '              var details  = document.getElementById(detailsID);' NL ...
                    '              skipCheck    = true;' NL ...
                    '              state_check(details.id);' NL ...
                    '              details.open = true;' NL ...
                    '          }' NL NL ...
                    '          function update_back_position()' NL ...
                    '          {' NL ...
                    '              try' NL ...
                    '              {' NL ...
                    '                  window.addEventListener("scroll", update_back_position, true);' NL ...
                    '                  window.addEventListener("resize", update_back_position, true);' NL ...
                    '                  var scrollPos;' NL ...
                    '                  if (in_iFrame())' NL ...
                    '                  {' NL ...
                    '                      parent.window.addEventListener("scroll", update_back_position, true);' NL ...
                    '                      parent.window.addEventListener("resize", update_back_position, true);' NL ...
                    '                      var iFrame         = window.frameElement;' NL ...
                    '                      var frameOffset    = get_offset(iFrame);' NL ...
                    '                      var documentBottom = parent.window.innerHeight  + parent.window.scrollY;' NL ...
                    '                      var extHeight      = Math.round(frameOffset.top + iFrame.getBoundingClientRect().height - documentBottom);' NL ...
                    '                      if (extHeight<0) { extHeight = 0; }' NL ...
                    '                      returnButton.style.bottom = (10+extHeight) + "px";' NL ...
                    '                      document.getElementById("tooltiptext").style.bottom = (11+extHeight) + "px";' NL ...
                    '                      scrollPos = contentDiv.scrollTop - 25 + iFrame.getBoundingClientRect().height - extHeight;' NL ...
                    '                  }' NL ...
                    '                  else{' NL ...
                    '                      scrollPos = window.scrollY + window.innerHeight - 25;}' NL ...
                    '                  if (returnElem.offsetTop>scrollPos){' NL ...
                    '                      document.getElementById("down").style.display = "inline";' NL ...
                    '                      document.getElementById("up").style.display   = "none";   }' NL ...
                    '                  else{' NL ...
                    '                      document.getElementById("down").style.display = "none";' NL ...
                    '                      document.getElementById("up").style.display   = "inline"; }' NL ...
                    '              }' NL ...
                    '              catch(e){}' NL ...
                    '          }' NL ...
                    '          function set_theme(themePref)' NL ...
                    '          {' NL ...
                    '            var themeSwitch     = document.getElementById("ToggleTheme");' NL ...
                    '            var themeSwitchText = "switch to";' NL ...
                    '            var switchToText    = null;' NL ...
                    '            if (!themePref){ themePref = get_theme_pref(); }' NL ...
                    '            if (themePref.localeCompare("light")===0){' NL ...
                    '                document.getElementById("dark-theme").sheet.disabled = true;' NL ...
                    '                document.getElementById("hide-dark").sheet.disabled  = false;' NL ...
                    '                switchToText = " dark theme";}' NL ...
                    '            else{' NL ...
                    '                document.getElementById("dark-theme").sheet.disabled = false;' NL ...
                    '                document.getElementById("hide-dark").sheet.disabled  = true;' NL ...
                    '                switchToText = " light theme";}' NL ...
                    '            themeSwitch.innerHTML = themeSwitchText + switchToText;' NL ...
                    '            set_theme_pref(themePref);' NL ...
                    '          }' NL NL ...
                    '          function toggle_theme()' NL ...
                    '          {' NL ...
                    '            if (document.getElementById("dark-theme").sheet.disabled) { set_theme("dark");  }' NL ...
                    '            else                                                      { set_theme("light"); }' NL ...
                    '          }' NL NL ...
                    '          function set_theme_pref(themePref)' NL ...
                    '          {' NL ...
                    '              var d = new Date();' NL ...
                    '              d.setTime(d.getTime() + (2*365*24*60*60*1000));' NL ...
                    '              var expires = "expires="+ d.toUTCString();' NL ...
                    '              document.cookie = "themepref=" + themePref + ";" + expires + "path=/";' NL ...
                    '              localStorage.setItem("PRETTY_THEME", themePref);' NL ...
                    '          }' NL ...
                    NL ...
                    '          function get_theme_pref() {' NL ...
                    '              var name = "themepref=";' NL ...
                    '              var decodedCookie = decodeURIComponent(document.cookie);' NL ...
                    '              var ca = decodedCookie.split('';'');' NL ...
                    '              for(var i = 0; i < ca.length; i++) {' NL ...
                    '                var c = ca[i];' NL ...
                    '                while (c.charAt(0) == '' '') {' NL ...
                    '                  c = c.substring(1);' NL ...
                    '                }' NL ...
                    '                if (c.indexOf(name) == 0) {' NL ...
                    '                  return c.substring(name.length, c.length);' NL ...
                    '                }' NL ...
                    '              }' NL ...
                    '              var docTheme = localStorage.getItem("PRETTY_THEME");' NL ...
                    '              if (docTheme) { return docTheme }' NL ...
                    '              else          { return "light"  }' NL ...
                    '          }' NL ...
                    NL ...
                    '          function toggle_details(section)' NL ...
                    '          {' NL ...
                    '            var link;' NL ...
                    '            var subSection;' NL ...
                    '            var details;' NL ...
                    '            var linkText;' NL ...
                    '            var i;' NL ...
                    '            var openState  = true;' NL ...
                    '            var border     = "6px 6px 0 0;"' NL ...
                    '            if (section===0)' NL ...
                    '            {' NL ...
                    '              link = document.getElementById("Toggle"+section.toString());' NL ...
                    '              if (link.innerHTML.localeCompare("collapse all on page")===0){' NL ...
                    '                  openState = false;' NL ...
                    '                  border    = "6px;"' NL ...
                    '                  linkText  = "expand all";}' NL ...
                    '              else{' NL ...
                    '                  linkText   = "collapse all";}' NL ...
                    '              link.innerHTML = linkText + " on page";' NL ...
                    '              for (i = 0; i < allDetails.length; i++){' NL ...
                    '                 allDetails[i].open = openState;' NL ...
                    '                 allDetails[i].children[0].setAttribute( ''style'', "border-radius:"+border );' NL ...
                    '                 link = document.getElementById("Toggle"+allDetails[i].id.split(".", 1));' NL ...
                    '                 if (allDetails[i].id.charAt(0).localeCompare("0") && link){link.innerHTML = linkText;}}' NL ...
                    '            }' NL ...
                    '            else' NL ...
                    '            {' NL ...
                    '               link = document.getElementById("Toggle"+section.toString());' NL ...
                    '               subSection = 1;' NL ...
                    '               if (link.innerHTML.localeCompare("collapse all")===0){' NL ...
                    '                  openState      = false;' NL ...
                    '                  border         = "6px;"' NL ...
                    '                  link.innerHTML = "expand all";}' NL ...
                    '               else{' NL ...
                    '                  link.innerHTML = "collapse all";}' NL ...
                    '               details = document.getElementById(section.toString()+"."+subSection.toString());' NL ...
                    '               while (details){' NL ...
                    '                    details.open = openState;' NL ...
                    '                    details.children[0].setAttribute( ''style'', "border-radius:"+border );' NL ...
                    '                    subSection++;' NL ...
                    '                    details = document.getElementById(section.toString()+"."+subSection.toString());}' NL ...
                    '               var allCollapsed = true;' NL ...
                    '               var allExpanded  = true;' NL ...
                    '               for (i = 0; i < allDetails.length; i++){' NL ...
                    '                   check_if_open(allDetails[i]);}' NL ...
                    '               link = document.getElementById("Toggle0");' NL ...
                    '               if (allExpanded) {link.innerHTML = "collapse all on page";}' NL ...
                    '               if (allCollapsed){link.innerHTML = "expand all on page";}' NL ...
                    '            }' NL ...
                    '            function check_if_open(details)' NL ...
                    '            {' NL ...
                    '                if (details.open){allCollapsed = false;}' NL ...
                    '                else             {allExpanded  = false;}' NL ...
                    '            }' NL ...
                    '          }' NL NL ...
                    '          function state_check(detailsID)' NL ...
                    '          {' NL ...
                    '              // first deal with just the section' NL ...
                    '              if (event.detail){document.activeElement.blur();}' NL ...
                    '              var clickedElem   = event.target;' NL ...
                    '              if (!skipCheck && clickedElem.localName.localeCompare("summary"))' NL ...
                    '              { ' NL ...
                    '                if (!(clickedElem.closest("summary"))) { return };' NL ...
                    '              };' NL ...
                    '              var details       = document.getElementById(detailsID);' NL ...
                    '              if ( !skipCheck ) {' NL ...
                    '                  var parentID  = clickedElem.closest("details").id;' NL ...
                    '                  if (details.id.localeCompare(parentID)) { return };}' NL ...
                    '              skipCheck         = false;' NL ...
                    '              var clickedStatus = details.open;' NL ...
                    '              var section       = detailsID.split(".", 1);' NL ...
                    '              var subSection    = 1;' NL ...
                    '              var allCollapsed  = true;' NL ...
                    '              var allExpanded   = true;' NL ...
                    '              var link          = document.getElementById("Toggle"+section);' NL ...
                    '              if (clickedStatus) { details.children[0].setAttribute( ''style'', "border-radius:6px;" ); }' NL ...
                    '              else               { details.children[0].setAttribute( ''style'', "border-radius:6px 6px 0 0;" ); }' NL ...
                    '              if (link)' NL ...
                    '              {' NL ...
                    '                  details = document.getElementById(section+"."+subSection.toString());' NL ...
                    '                  while (details){' NL ...
                    '                    check_if_open(details);' NL ...
                    '                    subSection++;' NL ...
                    '                    details = document.getElementById(section+"."+subSection.toString());}' NL ...
                    '                  if (allExpanded) {link.innerHTML = "collapse all";}' NL ...
                    '                  if (allCollapsed){link.innerHTML = "expand all";}' NL ...
                    '              }' NL ...
                    '              // then the whole page' NL ...
                    '              allCollapsed   = true;' NL ...
                    '              allExpanded    = true;' NL ...
                    '              for (var i = 0; i < allDetails.length; i++){' NL ...
                    '                  check_if_open(allDetails[i]);}' NL ...
                    '              link = document.getElementById("Toggle0");' NL ...
                    '              if (allExpanded) {link.innerHTML = "collapse all on page";}' NL ...
                    '              if (allCollapsed){link.innerHTML = "expand all on page";}' NL NL ...
                    '              function check_if_open(details)' NL ...
                    '              {' NL ...
                    '                  var openStatus' NL ...
                    '                  if (detailsID.localeCompare( details.id )===0 ){openStatus = !clickedStatus;}' NL ...
                    '                  else                                           {openStatus = details.open;}' NL ...
                    '                  if (openStatus){allCollapsed = false;}' NL ...
                    '                  else           {allExpanded  = false;}' NL ...
                    '              }' NL ...
                    '          }' NL ...
                    NL ...
                    '          function in_iFrame ()' NL ...
                    '          {' NL ...
                    '               try {' NL ...
                    '                   return window.self !== window.top;' NL ...
                    '               } catch (e) {' NL ...
                    '                   return true;' NL ...
                    '               }' NL ...
                    '          }' NL ...
                    '</script>' NL];
    %% Insert extra css and javascript
    STYLE_CLOSE = '</style>';
    cssClose    = strfind(fstrm,STYLE_CLOSE);
    cssClose    = cssClose(1);
    rewindCount = 0;
    while fstrm(cssClose)~=NL, rewindCount = rewindCount+1; cssClose = cssClose-1; end
    fstrm = [fstrm(1:cssClose-1+length(STYLE_CLOSE)+rewindCount) NL javaScript fstrm(cssClose+length(STYLE_CLOSE)+rewindCount:end)];
    fstrm = [fstrm(1:cssClose-1) extraCSS '</style>' darkTheme jumpShift fstrm(cssClose+length(STYLE_CLOSE)+rewindCount:end)];
    %% Fix/tweak publish's css
    fstrm = strrep(fstrm, '.content { font-size:1.2em; line-height:140%;', '.content { font-size:1.2em; line-height:160%;');
    fstrm = strrep(fstrm, 'pre { margin:0px 0px 20px; }', 'pre { margin:0px 0px 15px; overflow-x:auto; }');
    fstrm = strrep(fstrm, 'pre, code { font-size:12px; }', 'pre { font-size:12px; }');
    fstrm = strrep(fstrm, 'tt { font-size: 1.2em; }','code { font-size: 1.15em; }');
    fstrm = strrep(fstrm, 'pre.codeoutput { padding:10px 11px; margin:0px 0px 20px;','pre.codeoutput { padding:10px 11px; margin:0px 0px 15px;');
    %% html validation fixes
    fstrm = strrep(fstrm, ['<!DOCTYPE html' NL '  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">'],'<!DOCTYPE html>');
    fstrm = strrep(fstrm, '<html>', '<html lang="en">');
    fstrm = strrep(fstrm, '<style type="text/css">','<style>');
    fstrm = strrep(fstrm, ':focus{outine:0}','');
    fstrm = strrep(fstrm, '<tt','<code'); fstrm = strrep(fstrm, '</tt>','</code>');
    %% Insert floating "return" link
    fstrm = strrep(fstrm,'<div class="content">',...
                         ['<div class="content">' NL ...
                          '<div id="return-link" style="display:none;" class="tooltip">' NL ...
                          '<p onclick="jump_to()">' NL ...
                          '    <span onclick="jump_to()"><span id="up">&#8679;</span><span id="down">&#8681;</span>' NL ...
                          '    <span onclick="hide_back_link()" style="padding:2px; font-size:120%;" id="jump-close">' ...
                              '<b onclick="hide_back_link()">&times;</b></span></span>' NL ...
                          '</p>' NL ...
                          '<div id="tooltiptext">click to return<br>(click <b>&times;</b> to hide)</div>' NL ...
                          '</div>']);
    %% Find start and end of page body source
    [sourceStart, htmlEnd] = find_source(fstrm);
    if DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), 'input.html', 1); end
    %% Move any <style></style> section to before the body
    styleStart = strfind(fstrm(sourceStart:htmlEnd),'<style');
    if ~isempty(styleStart)
        styleStart = styleStart + sourceStart - 1;
        styleEnd   = strfind(fstrm(sourceStart:htmlEnd),'</style>');
        assert(length(styleStart)==length(styleEnd),'ERROR: Imbalanced <style></style> tags; there are %i opening tags and %i closing tags', ...
                                                    length(styleStart), length(styleEnd));
        styleEnd = styleEnd + sourceStart - 1;
        for i = 1:length(styleStart)
            sectionLength = 1+styleEnd(i)+7-styleStart(i);
            fstrm = [fstrm(1:sourceStart-1) fstrm(styleStart(i):styleEnd(i)+7) fstrm(sourceStart:end)];
            styleStart(i) = styleStart(i) + sectionLength;
            styleEnd(i)   = styleEnd(i)   + sectionLength;
            sourceStart   = sourceStart   + sectionLength;
            fstrm(styleStart(i):styleEnd(i)+7) = [];
        end
    end
    %% Process [h2] tags
    if verbose, fprintf(1,'   [h2] tags...\n'); end
    userHeadingCounter = 0;
    fstrm = strrep(fstrm,'[h2]' ,'<h2>' );
    fstrm = strrep(fstrm,'[/h2]','</h2>');
    userHeadings = strfind(fstrm(sourceStart:htmlEnd),'[h2.CElink]');
    if ~isempty(userHeadings)
        userHeadings = userHeadings + sourceStart - 1;
        for i = 1:length(userHeadings)
            userHeadingCounter = userHeadingCounter+1;
            headingTag = ['<h2 id="userHeading' num2str(userHeadingCounter) '">'];
            fstrm = [fstrm(1:userHeadings(i)-1) headingTag fstrm(userHeadings(i)+11:end)];
            userHeadings = userHeadings + length(headingTag)-11;
            htmlEnd      = htmlEnd      + length(headingTag)-11;
        end
    end
    if DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), 'after processing [h2] tags.html', 1); end
    %% Process [targetn] and [jumpton] tags
    if verbose, fprintf(1,'   target and jump tags...\n'); end
    [fstrm, htmlEnd] = process_target_and_jump_tags(fstrm, htmlEnd);
    if DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), 'after processing internal links.html', 1); end
    %% Process colour, scale, and class tags
    if verbose, fprintf(1,'   colour, scale, and class tags...\n'); end
    tagList = {'colour','scale','class'};
    validValList = {[],[],classNames};
    for i = 1:length(tagList)
        tagName = tagList{i};
        [tagOpens, tagCloses] = get_tag_pairs(['[' tagName ']'], fstrm, htmlEnd);
        [fstrm, htmlEnd, tagOpens, tagCloses, vals, tagEnds] = find_valid_prettify_tags(tagName, tagOpens, tagCloses, validValList{i}, fstrm, htmlEnd);
        [fstrm, htmlEnd] = prettyTag2htmlTag(tagName, tagOpens, tagCloses, vals, tagEnds, fstrm, sourceStart, htmlEnd, DEBUG);
        if DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), ['after processing ' tagName '.html'], 1); end
    end
    %% Find [dtls] and [smry] tags
    if verbose, fprintf(1,'   dtls tags...\n'); end
    [detailsOpens, detailsCloses] = get_tag_pairs('[dtls]', fstrm, htmlEnd);
    [summaryOpens, summaryCloses] = get_tag_pairs('[smry]', fstrm, htmlEnd);
    assert(length(summaryOpens)==length(detailsOpens), 'ERROR: Number of [smry] tags does not match the number of [dtls] tags');
    detailsTags = {detailsOpens, detailsCloses};
    wrapTags = {'<span','<pre'};
    for i = 1:2
        if i == 1, slash = '';
        else     , slash = '/'; end
        for j = 1:length(detailsOpens)
            for k = 1:length(wrapTags)
                wrapTag  = wrapTags{k};
                wrapIdxs = strfind(fstrm(sourceStart:detailsTags{i}(j)), wrapTag) + sourceStart - 1;
                if ~isempty(wrapIdxs)
                    wrapIdxs = wrapIdxs(end);
                    if ~contains(fstrm(wrapIdxs:detailsTags{i}(j)),['</' wrapTag(2:end) '>'])
                        if k == 1, warnStr1 = 'appears inside a comment section of';  warnStr2 = 'forgotten a space';
                        else     , warnStr1 = 'is wrapped in <pre>...</pre> tags in'; warnStr2 = 'put too many spaces'; end
                        show_warning(sprintf(['[%cdtls] tag %i %s the html document - this may cause an error.\n' ...
                                              'Possibly you have forgotten to start a new section in the source .m file, or %s '    ...
                                              'between the start-of-line "%%" and the [%cdtls] tag.'], slash, j, warnStr1, warnStr2, slash));
                        break
                    end
                end
            end
        end
    end
    [countOfDtlsTags, detailsCloses] = sort_tag_closes(detailsOpens, detailsCloses);
    for i = 1:countOfDtlsTags
        assert(summaryOpens (i)>detailsOpens (i),'ERROR: [smry] tag %i opened before [dtls] tag %i', i, i);
        assert(summaryCloses(i)<detailsCloses(i),'ERROR: [dtls] tag pair %i closed before [smry] tag pair %i', i, i);
    end
    imgTags = [];
    %% Process [dtls] and [smry] tags
    if ~isempty(detailsOpens)
        dummySections        = 0;
        revertedCount        = false;
        revertAt             = 0;
        subSectionCounterBak = NaN;
        collapseAllStyle = 'class="collapse-link"';
        collapseAllPos   = strfind(fstrm(sourceStart:htmlEnd),'<h2>Contents</h2>') + sourceStart - 1;
        noSections       = false;
        insertPoint      = detailsOpens(1)-1;
        if isempty(collapseAllPos) || any(detailsOpens<collapseAllPos(1))
            if isempty(collapseAllPos), noSections = true; collapseAllPos=0; end
            firstP = strfind(fstrm(sourceStart:htmlEnd),'<div class="content">') + sourceStart - 1;
            firstP = strfind(fstrm(firstP(1):htmlEnd),'<p>') + firstP(1) - 1;
            assert (~isempty(firstP),[NO_START_ERR ' - is entire source .m file comment-only? Did you forget to start a section?']);
            if isempty(themeSwitch)
                collapseAll = ['<p style="margin:0px; line-height:0;">&nbsp;</p><p onclick="toggle_details(0)"'...
                               ' style="float:right; padding-left:10px; margin:0;"><a href="javascript:void(0);" id="Toggle0">collapse all on page</a></p>'];
                fstrm       = strrep(fstrm,'<script>document.getElementById("dark-theme")',[collapseAll '<script>document.getElementById("dark-theme")']);
            else
                newThemeSwitch = strrep(themeSwitch,['<p onclick="toggle_theme()" style="text-align:right; float:right; padding-left:10px; margin:0;">'...
                                                     '<a '],...
                                                    ['<p style="text-align:right; float:right; padding-left:10px; margin:0;"><span ' ...
                                                     'onclick="toggle_theme()" style="line-height:100%; padding-bottom:1px; border-bottom:1px ' ...
                                                     'solid #d6d4d4;"><a ']);
                newThemeSwitch = strrep(newThemeSwitch,'</a>','</a></span>');
                fstrm          = strrep(fstrm,themeSwitch,newThemeSwitch);

                update_idxs(length(newThemeSwitch)-length(themeSwitch));
                collapseAll = '<br><span onclick="toggle_details(0)"><a href="javascript:void(0);" id="Toggle0">collapse all on page</a></span>&nbsp;';
                fstrm       = strrep(fstrm,'</p></div><script>set_theme(null)</script>',[collapseAll '</p></div><script>set_theme(null)</script>']);
            end
        else
            collapseAllPos = collapseAllPos(1);
            collapseAll = ['<p style="margin:0px; line-height:0;">&nbsp;</p><p onclick="toggle_details(0)" ' collapseAllStyle '>'...
                           '<a href="javascript:void(0);" id="Toggle0">collapse all on page</a></p>'];
            fstrm = [fstrm(1:collapseAllPos-1) collapseAll fstrm(collapseAllPos:end)];
        end
        update_idxs(length(collapseAll));
        collapseAllPos = collapseAllPos(1)+length(collapseAll);
        sectionsCounter   = 0;
        subSectionCounter = 1;
        detailsBeforeContents = detailsOpens<collapseAllPos;
        for detailsSectionCounter = 1:countOfDtlsTags
            if revertAt && detailsOpens(detailsSectionCounter)>detailsCloses(revertAt)
                sectionsCounter      = sectionsCounterBak;
                subSectionCounter    = subSectionCounterBak;
                subSectionCounterBak = NaN;
                revertedCount        = true;
                revertAt             = 0;
            end
            if ~noSections
                if detailsBeforeContents(detailsSectionCounter)
                    sectionsCounter=-1;
                    if subSectionCounter==1
                        sectionCollapseState = ['<div style="display:none;"><p id="Toggle' num2str(sectionsCounter) '">collapse all</p></div>'];
                        fstrm = [fstrm(1:detailsOpens(detailsSectionCounter)-1) sectionCollapseState fstrm(detailsOpens(detailsSectionCounter):end)];
                        insertPoint = detailsOpens(detailsSectionCounter)-1;
                        update_idxs(length(sectionCollapseState));
                    end
                elseif sectionsCounter==-1
                    sectionsCounter = 0;
                end
            elseif sectionsCounter == 0
                sectionsCounter = 1;
            end
            if detailsSectionCounter==1, headingSearchStart = 1;
            else                       , headingSearchStart = detailsOpens(detailsSectionCounter-1); end
            headingIdx = strfind( fstrm(headingSearchStart:detailsOpens(detailsSectionCounter)), '<h2 id="' );
            if ~isempty(headingIdx)
                skipHeading = false;
                headingIdx  = headingSearchStart-1+headingIdx(end);
                idEnd       = strfind(fstrm(headingIdx+9:detailsOpens(detailsSectionCounter)),'"');
                if isempty(idEnd), error('ERROR: malformed <h2> tag (no closing " for id)'); end
                idEnd = idEnd(1) + headingIdx + 7;
                headingNum = str2double(fstrm(headingIdx+8:idEnd));
                if isnan(headingNum), isDummySection = true;
                else                , isDummySection = false; end
                headingNestLevel = sum(headingIdx<detailsCloses(1:detailsSectionCounter-1));
                if detailsSectionCounter>1 && headingNestLevel
                    if ~isDummySection
                        error('ERROR: Section heading %i is inside a [dtls] box: this is not supported', headingNum);
                    elseif headingNestLevel > sum(detailsOpens(detailsSectionCounter)<detailsCloses(1:detailsSectionCounter-1))
                        skipHeading = true;
                    elseif ~noSections
                        revertAt = find(headingIdx<detailsCloses(1:detailsSectionCounter-1),1,'last');
                    end
                end
                if ~skipHeading
                    sectionsCounter = sectionsCounter + 1;
                    if ~isDummySection
                        subSectionCounterBak = NaN;
                    else
                        if isnan(subSectionCounterBak)
                            sectionsCounterBak   = sectionsCounter - 1;
                            subSectionCounterBak = subSectionCounter;
                        end
                    end
                    if revertedCount, sectionsCounter = sectionsCounter + dummySections; end
                    revertedCount = false;
                    subSectionCounter = 1;
                    headingClose  = strfind(fstrm(headingIdx:detailsOpens(detailsSectionCounter)),'</h2>');
                    headingClose  = headingClose(1) + headingIdx - 1;
                    if ~contains(fstrm(headingIdx:headingClose),'display:none')
                        sectionHeader     = ['<p style="margin:0px; line-height:0;">&nbsp;</p><p onclick="toggle_details(' num2str(sectionsCounter)...
                                             ')" class="collapse-link"><a href="javascript:void(0);" id="Toggle' num2str(sectionsCounter) ...
                                             '">collapse all</a></p>'];
                        fstrm = [fstrm(1:headingIdx-1) sectionHeader fstrm(headingIdx:end)];
                        insertPoint = headingIdx-1;
                        update_idxs(length(sectionHeader));
                    end
                    if isDummySection, dummySections = dummySections+1; end
                end
            end
            % <p>...[dtls] -> ...[dtls][smry]...[/smry]<p>
            % look for unbalanced <p></p> tags before the [dtls] tag
            pBeforeDtls = strfind(fstrm(sourceStart:detailsOpens(detailsSectionCounter)),'<p') + sourceStart - 1;
            if ~isempty(pBeforeDtls)
                closepBeforeDtls = strfind(fstrm(sourceStart:detailsOpens(detailsSectionCounter)),'</p>') + sourceStart - 1;
                if length(pBeforeDtls) > length(closepBeforeDtls)
                    while closepBeforeDtls(end)>pBeforeDtls(end)
                        closepBeforeDtls(end) = [];
                        pBeforeDtls(end)      = [];
                    end
                    % move pBeforeDtls(end) to after the [/smry] tag associated with this [dtls] tag, but only if the pBeforeDtls is a plain "<p>"
                    if strcmp(fstrm(pBeforeDtls(end):pBeforeDtls(end)+2),'<p>')
                        fstrm(pBeforeDtls(end):pBeforeDtls(end)+2) = [];
                        detailsOpens ( detailsSectionCounter ) = detailsOpens ( detailsSectionCounter ) - 3;
                        summaryCloses( detailsSectionCounter ) = summaryCloses( detailsSectionCounter ) - 3;
                        fstrm = [fstrm(1:summaryCloses(detailsSectionCounter)+6) '<p>' fstrm(summaryCloses(detailsSectionCounter)+7:end)];
                    end
                end
            end
            % [/dtls]...</p> -> [/dtls]<p>...</p> + delete the previous <p>
            % or [/dtls]</p> -> [/dtls] + delete the previous <p>
            closepAfterDtls = strfind(fstrm(detailsCloses(detailsSectionCounter):htmlEnd),'</p>') + detailsCloses(detailsSectionCounter) - 1;
            if ~isempty(closepAfterDtls)
                closepAfterDtls = closepAfterDtls(1);
                pAfterDtls      = strfind(fstrm(detailsCloses(detailsSectionCounter):htmlEnd),'<p') + detailsCloses(detailsSectionCounter) - 1;
                if isempty(pAfterDtls) || pAfterDtls(1)>closepAfterDtls
                    if strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+10),'</p>')
                        fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+10) = [];
                        insertPoint = detailsCloses(detailsSectionCounter);
                        update_idxs(-4);
                    else
                        fstrm = [fstrm(1:detailsCloses(detailsSectionCounter)+6) '<p>' fstrm(detailsCloses(detailsSectionCounter)+7:end)];
                        insertPoint = detailsCloses(detailsSectionCounter);
                        update_idxs(3);
                    end
                    pInDtls = strfind(fstrm(detailsOpens(detailsSectionCounter):detailsCloses(detailsSectionCounter)),'<p>');
                    if ~isempty(pInDtls)
                        pInDtls = pInDtls(end) + detailsOpens(detailsSectionCounter) - 1;
                        fstrm(pInDtls:pInDtls+2) = [];
                        insertPoint = pInDtls;
                        update_idxs(-3);
                    end
                end
            end
            % [dtls] -> <details open onclick="state_check(<ID>)" id="<ID>">
            detailsId     = [num2str(sectionsCounter) '.' num2str(subSectionCounter)];
            detailsOpener = ['<details open onclick="state_check(''' detailsId ''')" id="' detailsId '">'];
            fstrm = [fstrm(1:detailsOpens(detailsSectionCounter)-1) detailsOpener fstrm(detailsOpens(detailsSectionCounter)+6:end)];
            insertPoint = detailsOpens(detailsSectionCounter)-1;
            update_idxs(length(detailsOpener)-6);
            % [/dtls] -> </div></details>
            addBreak = '';
            % add line break after [dtls] section, if necessary
            if ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+13),'<p></p>')                ...
            && ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+14),'<p> </p>')               ...
            && ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+14),['<p>' char(160) '</p>']) ...
            && ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+24),'<p class="footer">')     ...
            && ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+12),'<p><br')                 ...
            && ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+12),'<p>[br')                 ...
            && ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+9) ,'<br')                    ...
            && ~strcmp(fstrm(detailsCloses(detailsSectionCounter)+7:detailsCloses(detailsSectionCounter)+9) ,'[br')
                addBreak = '<br>';
            end
            dtlsClose = ['</div></details>' addBreak];
            fstrm = [fstrm(1:detailsCloses(detailsSectionCounter)-1) dtlsClose fstrm(detailsCloses(detailsSectionCounter)+7:end)];
            insertPoint = detailsCloses(detailsSectionCounter)-1;
            update_idxs(length(dtlsClose)-7);
            subSectionCounter = subSectionCounter + 1;
            if DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), ['after replacing [dtls] tag set ' num2str(detailsSectionCounter) '.html'], 1); end
        end
        fstrm = strrep(fstrm,'[smry]','<summary>');
        fstrm = strrep(fstrm,'[/smry]','</summary><div class="details-div">');
        if DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), 'after replacing [smry] tags.html', 1); end
        insertPoint = detailsOpens(1)-1;
        update_idxs(31*countOfDtlsTags);
        %%     Remove excess line breaks after any tables in details sections
        detailsOpens  = strfind(fstrm(sourceStart:htmlEnd),'<details open ') + sourceStart - 1;
        detailsCloses = strfind(fstrm(sourceStart:htmlEnd),'</details>') + sourceStart - 1;
        [countOfDtlsTags, detailsCloses] = sort_tag_closes(detailsOpens, detailsCloses);
        for detailsCounter = 1:countOfDtlsTags
            tableCloseIdxs = strfind(fstrm(detailsOpens(detailsCounter):detailsCloses(detailsCounter)),'</table>')  + detailsOpens(detailsCounter) - 1;
            for i = 1:length(tableCloseIdxs)
                brIdx = strfind(fstrm(tableCloseIdxs(i)+8:detailsCloses(detailsCounter)-5),'<br>');
                if isempty(brIdx), continue, end
                brIdx = brIdx(1) + tableCloseIdxs(i) + 7;
                if strcmp(sscanf( fstrm(tableCloseIdxs(i)+8:brIdx+3),'%s' ),'<br>')
                    fstrm(brIdx:brIdx+3) = [];
                    tableCloseIdxs = tableCloseIdxs-4;
                    insertPoint    = brIdx;
                    update_idxs(-4);
                end
            end
        end
        %%     Remove excess spacing after any lists at the end of details sections
        for listTag = {'ul','ol'}
            for detailsCounter = 1:countOfDtlsTags
                listIdxs = strfind(fstrm(detailsOpens(detailsCounter):detailsCloses(detailsCounter)),['<' listTag{:} '>']);
                listIdxs = sort( [listIdxs strfind(fstrm(detailsOpens(detailsCounter):detailsCloses(detailsCounter)),['<' listTag{:} ' style="'])] );
                if ~isempty(listIdxs)
                    listIdxs   = listIdxs(end) + detailsOpens(detailsCounter) - 1;
                    listTagEnd = strfind(fstrm(listIdxs:detailsCloses(detailsCounter)),'>');
                    listTagEnd = listTagEnd(1) + listIdxs - 1;
                    listEnd  = strfind(fstrm(listIdxs:detailsCloses(detailsCounter)),['</' listTag{:} '>']) + listIdxs - 1;
                    if ~isempty(listEnd) && ~contains(fstrm(listIdxs:listTagEnd),'margin')
                        if strcmp(fstrm(listEnd:detailsCloses(detailsCounter)),['</' listTag{:} '></div></span></div><']) ...
                        || strcmp(fstrm(listEnd:detailsCloses(detailsCounter)),['</' listTag{:} '></div></div><']) ...
                        || strcmp(fstrm(listEnd:detailsCloses(detailsCounter)),['</' listTag{:} '></span></div><']) ...
                        || strcmp(fstrm(listEnd:detailsCloses(detailsCounter)),['</' listTag{:} '></div><'])
                            if fstrm(listIdxs+3)=='>'
                                fstrm = [fstrm(1:listIdxs+2) ' style="margin-bottom:0px;"' fstrm(listIdxs+3:end)];
                                insertPoint = listIdxs+2;
                                update_idxs(27);
                            else % <ul style="blah -> <ul style="margin-bottome:0px; blah
                                fstrm = [fstrm(1:listIdxs+10) 'margin-bottom:0px; ' fstrm(listIdxs+11:end)];
                                insertPoint = listIdxs+10;
                                update_idxs(19);
                            end
                        end
                    end
                end
            end
        end
        if DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), 'before adding breaks between tables and images.html', 1); end
        %%     Add breaks between tables and images
        for detailsCounter = 1:countOfDtlsTags
            tableThenImage = strfind(fstrm(detailsOpens(detailsCounter):detailsCloses(detailsCounter)),'</table><img ')  + detailsOpens(detailsCounter) - 1;
            for i = 1:length(tableThenImage)
                fstrm = [fstrm(1:tableThenImage(i)+7) '[br15]' fstrm(tableThenImage(i)+8:end)];
                insertPoint = tableThenImage(i)+7;
                update_idxs(6);
                tableThenImage = tableThenImage+6;
            end
        end
        if DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), 'after adding [br15].html', 1); end
    end
    %% Process [bottomMarginx] tags
    if verbose, fprintf(1,'   bottom margin tags...\n'); end
    marginTagList = strfind(fstrm(sourceStart:htmlEnd),'[bottomMargin') + sourceStart - 1;
    [fstrm, htmlEnd, marginTagList, ~ , margins, marginTagEnds] = find_valid_prettify_tags('bottomMargin', marginTagList, [], [], fstrm, htmlEnd);
    for i = 1:length(marginTagList)
        tagLength = 1+marginTagEnds(i)-marginTagList(i);
        if strcmp(fstrm(marginTagList(i)-3:marginTagList(i)-1),'<p>')
            style     = [' style="margin-bottom: ' num2str(margins(i)) 'px;"'];
            if strcmp(fstrm(marginTagEnds(i)+1:marginTagEnds(i)+9),'</p><div>')
                % <p>[bottomMarginx]</p><div> -> <div style="margin-bottom:xpx;">
                fstrm = [fstrm(1:marginTagEnds(i)+8) style fstrm(marginTagEnds(i)+9:end)];
                fstrm(marginTagList(i)-3:marginTagEnds(i)+4) = [];
                charsAdded = length(style) - (tagLength+7);
            else
                % <p>[bottomMarginx] -> <p style="margin-bottom:xpx;">
                fstrm = [fstrm(1:marginTagList(i)-2) style fstrm(marginTagList(i)-1:end)];
                fstrm(marginTagList(i)+length(style):marginTagEnds(i)+length(style)) = [];
                charsAdded = length(style) - tagLength;
            end
        else
            fstrm(marginTagList(i):marginTagEnds(i)) = [];
            charsAdded = -tagLength;
        end
        marginTagList = marginTagList + charsAdded;
        marginTagEnds = marginTagEnds + charsAdded;
        htmlEnd       = htmlEnd       + charsAdded;
    end
    if DEBUG && ~isempty(marginTagList), write_fstrm_to_file(fstrm(sourceStart:htmlEnd), 'after processing bottomMarginx.html', 1); end
    %% Assign image-fit class to all images
    imgTags = strfind(fstrm(sourceStart:htmlEnd),'<img ') + sourceStart - 1;
    for i = 1:length(imgTags)
        srcIdx    = strfind(fstrm(imgTags(i):htmlEnd),' src=');
        srcIdx    = srcIdx(1) + imgTags(i) - 1;
        imgTagEnd = strfind(fstrm(imgTags(i):htmlEnd),'>');
        imgTagEnd = imgTagEnd(1) + imgTags(i) - 1;
        assert(~isempty(srcIdx) && ~isempty(imgTagEnd),'ERROR: malformed image tags found');
        if contains(fstrm(srcIdx:imgTagEnd),'.svg'), fitClass = 'image-fit-svg';
        else                                       , fitClass = 'image-fit';     end
        classStrs = {'class="','class ="','class= "','class = "'};
        for classStr = classStrs
            classIdx = strfind(fstrm(imgTags(i):imgTagEnd),classStr{:});
            if ~isempty(classIdx)
                classIdx = classIdx(1) + imgTags(i) - 1;
                if contains(fstrm(imgTags(i):imgTagEnd),'image-fit')
                    break
                end
                fstrm       = [fstrm(1:classIdx-1) classStr{:} fitClass ' ' fstrm(classIdx+length(classStr{:}):end)];
                insertPoint = classIdx-1;
                update_idxs(length(fitClass)+1);
                break
            end
        end
        if isempty(classIdx)
            classToAdd    = ['class="' fitClass '"'];
            if contains(fstrm(imgTags(i):imgTagEnd),'vspace="5" hspace="5"')
                charsToRemove = srcIdx - imgTags(i) - 5;
                fstrm         = [fstrm(1:imgTags(i)+4) classToAdd fstrm(srcIdx:end)];
            else
                charsToRemove = -1;
                fstrm         = [fstrm(1:imgTags(i)+4) classToAdd ' ' fstrm(imgTags(i)+5:end)];
            end
            insertPoint = imgTags(i)+4;
            update_idxs(length(classToAdd)-charsToRemove);
        end
    end
    %% Process undocumented [png2svg] tags
    % WARNING - MATLAB central does not support .svg images, so they have to be hosted externally
    [png2svgOpens, png2svgCloses] = get_tag_pairs('[png2svg]', fstrm, htmlEnd);
    imageFolder = strfind(fstrm(1:htmlEnd),'[imageFolder=');
    if ~isempty(imageFolder)
        imageFolder    = imageFolder(1);
        imageFolderEnd = strfind(fstrm(imageFolder:htmlEnd),']');
        imageFolder    = fstrm(imageFolder+13:imageFolder+imageFolderEnd(1)-2);
    end
    for i = 1:length(png2svgOpens)
        imgTags = strfind(fstrm(png2svgOpens(i):png2svgCloses(i)),'<img ') + png2svgOpens(i) - 1;
        for j = 1:length(imgTags)
            srcIdx    = strfind(fstrm(imgTags(j):png2svgCloses(i)),' src=');
            srcIdx    = srcIdx(1) + imgTags(j) - 1;
            imgTagEnd = strfind(fstrm(srcIdx:png2svgCloses(i)),'>');
            imgTagEnd = imgTagEnd(1) + srcIdx - 1;
            if contains(fstrm(srcIdx:imgTagEnd),'.png" alt="">')
                fstrm = [fstrm(1:srcIdx-1) strrep(fstrm(srcIdx:imgTagEnd),'.png" alt="">','_.svg" alt="">') fstrm(imgTagEnd+1:end)];
                imgTags(j+1:end) = imgTags(j+1:end) + 1;
                imgTagEnd        = imgTagEnd + 1;
                % image-fit -> image-fit-svg
                fstrm = [fstrm(1:imgTags(j)-1) strrep(fstrm(imgTags(j):imgTagEnd),'image-fit','image-fit-svg') fstrm(imgTagEnd+1:end)];
                insertPoint = imgTags(j)-1;
                update_idxs(5);
                png2svgOpens  = png2svgOpens  + 5;
                png2svgCloses = png2svgCloses + 5;
                if ~isempty(imageFolder)
                    fstrm = [fstrm(1:srcIdx+9) imageFolder '/' fstrm(srcIdx+10:end)];
                    insertPoint = srcIdx+9;
                    update_idxs(length(imageFolder)+1);
                    png2svgOpens  = png2svgOpens  + length(imageFolder)+1;
                    png2svgCloses = png2svgCloses + length(imageFolder)+1;
                end
            end
        end
    end
    %% Process undocumented [removepng] tags
    [removepngOpens, removepngCloses] = get_tag_pairs('[removepng]', fstrm, htmlEnd);
    for i = 1:length(removepngOpens)
        imgTags = strfind(fstrm(removepngOpens(i):removepngCloses(i)),'<img ') + removepngOpens(i) - 1;
        for j = 1:length(imgTags)
            srcIdx    = strfind(fstrm(imgTags(j):removepngCloses(i)),' src=');
            srcIdx    = srcIdx(1) + imgTags(j) - 1;
            imgTagEnd = strfind(fstrm(srcIdx:removepngCloses(i)),'>');
            imgTagEnd = imgTagEnd(1) + srcIdx - 1;
            if contains(fstrm(srcIdx:imgTagEnd),'.png" alt="">')
                fstrm(imgTags(j):imgTagEnd) = [];
                imgTagLength = (imgTagEnd+1-imgTags(j));
                insertPoint  = imgTags(j);
                update_idxs(-imgTagLength);
                removepngOpens   = removepngOpens   - imgTagLength;
                removepngCloses  = removepngCloses  - imgTagLength;
            end
        end
    end
    %% Process [darkAlt] tags
    if verbose, fprintf(1,'   darkAlt tags...\n'); end
    IMG_EXTS = {'png','jpg','jpeg','svg'};
    IMG_EXTS = [IMG_EXTS upper(IMG_EXTS)];
    [darkAltOpens, darkAltCloses] = get_tag_pairs('[darkAlt]', fstrm, htmlEnd);
    for i = 1:length(darkAltOpens)
        imgTags = strfind(fstrm(darkAltOpens(i):darkAltCloses(i)),'<img ') + darkAltOpens(i) - 1;
        if ~isempty(imgTags)
            fstrm = [fstrm(1:darkAltOpens(i)-1) ...
                     strrep(fstrm(darkAltOpens(i):darkAltCloses(i)),'image-fit"','image-fit show-if-light"') ...
                     fstrm(darkAltCloses(i)+1:end)];
            fstrm = [fstrm(1:darkAltOpens(i)-1) ...
                     strrep(fstrm(darkAltOpens(i):darkAltCloses(i)),'image-fit-svg','image-fit-svg show-if-light') ...
                     fstrm(darkAltCloses(i)+1:end)];
            insertPoint = darkAltOpens(i)-1;
            update_idxs(14*length(imgTags))
            darkAltOpens(i+1:end)  = darkAltOpens(i+1:end) + 14*length(imgTags);
            darkAltCloses          = darkAltCloses         + 14*length(imgTags);
        end
        imgTags = strfind(fstrm(darkAltOpens(i):darkAltCloses(i)),'<img ') + darkAltOpens(i) - 1;
        for j = 1:length(imgTags)
            srcIdx    = strfind(fstrm(imgTags(j):darkAltCloses(i)),' src=');
            srcIdx    = srcIdx(1) + imgTags(j) - 1;
            imgTagEnd = strfind(fstrm(srcIdx:darkAltCloses(i)),'>');
            imgTagEnd = imgTagEnd(1) + srcIdx - 1;
            duplicate = fstrm(imgTags(j):imgTagEnd);
            for ext = IMG_EXTS
                if contains(fstrm(srcIdx:imgTagEnd),['.' ext{:} '" alt="">'])
                    fstrm = [fstrm(1:imgTagEnd) ...
                             strrep(strrep(duplicate,['.' ext{:} '" alt="">'],['_dark.' ext{:} '" alt="">']),'show-if-light','show-if-dark') ...
                             fstrm(imgTagEnd+1:end)];
                    insertPoint = imgTagEnd;
                    update_idxs(length(duplicate)+4);
                    darkAltOpens(i+1:end)  = darkAltOpens(i+1:end) + length(duplicate)+4;
                    darkAltCloses          = darkAltCloses         + length(duplicate)+4;
                end
            end
        end
    end
    %% Replace [br] with <br>
    if verbose, fprintf(1,'   [br] tags...\n'); end
    fstrm = strrep(fstrm,'[br]','<br>');
    %% Process undocumented [rembr] and [delbr] tags
    rembrTags = strfind(fstrm(sourceStart:htmlEnd),'[rembr]') + sourceStart - 1;
    for i = 1:length(rembrTags)
        brTag = strfind(fstrm(sourceStart:rembrTags(i)),'<br>');
        brTag = brTag(end) + sourceStart - 1;
        if strcmp(sscanf(fstrm(brTag:rembrTags(i)-1),'%s'),'<br>')
            fstrm(brTag:brTag+3) = [];
            rembrTags = rembrTags - 4;
            htmlEnd   = htmlEnd   - 4;
        end
    end
    delbrTags = strfind(fstrm(sourceStart:htmlEnd),'[delbr]') + sourceStart - 1;
    for i = 1:length(delbrTags)
        brTag = strfind(fstrm(delbrTags(i):htmlEnd),'<br>');
        brTag = brTag(1) + delbrTags(i) - 1;
        if strcmp(sscanf(fstrm(delbrTags(i)+7:brTag+3),'%s'),'<br>')
            fstrm(brTag:brTag+3) = [];
            delbrTags = delbrTags - 4;
            htmlEnd   = htmlEnd   - 4;
        end
    end
    if verbose, fprintf(1,'   [delsp] tags...\n'); end
    delspTags = strfind(fstrm(sourceStart:htmlEnd),'[delsp]') + sourceStart - 1;
    for i = 1:length(delspTags)
        if fstrm(delspTags(i)+7) == ' '
            fstrm(delspTags(i)+7) = [];
            delspTags = delspTags - 1;
            htmlEnd   = htmlEnd   - 1;
        end
    end
    %% Insert breaks of specified pixel height ([brx] tags)
    if verbose, fprintf(1,'   [brx] tags...\n'); end
    brxTagList = strfind(fstrm(sourceStart:htmlEnd),'[br') + sourceStart - 1;
    [fstrm, htmlEnd, brxTagList, ~ , ~, brTagEnds] = find_valid_prettify_tags('br', brxTagList, [], [], fstrm, htmlEnd);
    for j = 1:length(brxTagList)
        %[brx] -> <br style="display:block; content:''; margin-top:xpx;">
        fstrm = [fstrm(1:brxTagList(j)-1) '<br style="display:block; content:''''; margin-top:' fstrm(brxTagList(j)+3:brTagEnds(j)-1) ...
                 'px;">' fstrm(brTagEnds(j)+1:end)];
        brxTagList = brxTagList + 50;
        brTagEnds  = brTagEnds  + 50;
        htmlEnd    = htmlEnd    + 50;
    end
    %% Remove excess spacing after codeoutput sections
    codeoutLoc = strfind(fstrm(sourceStart:htmlEnd),'<pre class="codeoutput">') + sourceStart - 1;
    for i = 1:length(codeoutLoc)
        codeoutEnd = strfind(fstrm(codeoutLoc(i):htmlEnd),'</pre>');
        charsDeleted = 0;
        if ~isempty(codeoutEnd)
            codeoutEnd = codeoutEnd(1) + codeoutLoc(i) - 1;
            while fstrm(codeoutEnd-1-charsDeleted)==NL
                fstrm(codeoutEnd-1-charsDeleted)=[];
                charsDeleted = charsDeleted + 1;
            end
        end
        htmlEnd             = htmlEnd             - charsDeleted;
        codeoutLoc(i+1:end) = codeoutLoc(i+1:end) - charsDeleted;
        if strcmp(fstrm(codeoutEnd-charsDeleted+6:codeoutEnd-charsDeleted+21),'</div></details>')
            fstrm = [fstrm(1:codeoutLoc(i)+4) 'style=margin-bottom:0px; ' fstrm(codeoutLoc(i)+5:end)];
            htmlEnd             = htmlEnd             + 25;
            codeoutLoc(i+1:end) = codeoutLoc(i+1:end) + 25;
        end
    end
    %% Remove erroneous <p></p> tags
    pOpens    = strfind(fstrm(sourceStart:htmlEnd),'<p ')  + sourceStart - 1;
    unstyledP = strfind(fstrm(sourceStart:htmlEnd),'<p>') + sourceStart - 1;
    pOpens    = sort([pOpens unstyledP]);
    pCloses   = strfind(fstrm(sourceStart:htmlEnd),'</p>') + sourceStart - 1;
    assert(length(pOpens)==length(pCloses),'ERROR: Imbalanced <p></p> tags detected. There are %i opening tags and %i closing tags',...
                                            length(pOpens),length(pCloses))
    [~, pCloses] = sort_tag_closes(pOpens, pCloses);
    pCloses      = pCloses(ismember(pOpens,unstyledP));
    pOpens       = pOpens (ismember(pOpens,unstyledP));
    for i = 1:length(pOpens)
        if contains(fstrm(pOpens(i):pCloses(i)), {'</p>','</table>','</ol>','</ul>','</pre>','</div>','</img>','</dl>','</h1>','</h2>','</h3>','</h4>', ...
                                                  '</h5>','</h6>'})
            fstrm(pOpens(i):pOpens(i)+2) = [];
            pCloses(pCloses>pOpens(i)) = pCloses(pCloses>pOpens(i)) - 3;
            pOpens (pCloses>pOpens(i)) = pOpens (pCloses>pOpens(i)) - 3;
            fstrm(pCloses(i):pCloses(i)+3) = [];
            pOpens (pCloses>pCloses(i)) = pOpens (pCloses>pCloses(i)) - 4;
            pCloses(pCloses>pCloses(i)) = pCloses(pCloses>pCloses(i)) - 4;
        end
    end
    %% Insert link to FEX page
    % handle defunct [frameBufferx] tag
    frameBufferTag = strfind(fstrm(sourceStart:htmlEnd),'[frameBuffer') + sourceStart - 1;
    if ~isempty(frameBufferTag)
        assert(length(frameBufferTag)==1,'ERROR: only one [frameBufferx] tag is allowed');
        frameBufferTagEnd = strfind(fstrm(frameBufferTag:htmlEnd),']') + frameBufferTag - 1;
        fstrm(frameBufferTag:frameBufferTagEnd) = [];
    end
    frameBuffer = '<p id="iFrameBuf">&nbsp;</p>';
    finalA = strfind(fstrm(sourceStart:htmlEnd),'<a');
    finalA = finalA(end) + sourceStart - 1;
    if strcmp(fstrm(finalA-4:finalA-1),'<br>'), fstrm(finalA-4:finalA-1) = []; end
    finalCloseA = strfind(fstrm(sourceStart:htmlEnd),'</a>');
    finalCloseA = finalCloseA(end) + sourceStart - 1;
    % get version number from opening comments
    fid    = fopen([mfilename('fullpath') '.m'],'r');
    line   = ''; while ~contains(line,'Version'), line = fgetl(fid); end
    verStr = sscanf(line,'%%   Version %s');
    fclose(fid);
    % add link and frame buffer to footer
    fstrm  = [fstrm(1:finalCloseA+3) ' and subsequently processed by ' ...
              '<a class="pretty-link" href="https://www.mathworks.com/matlabcentral/fileexchange/78059-prettify-matlab-html">prettify_MATLAB_html</a>' ...
              ' V' verStr '</p>' frameBuffer fstrm(finalCloseA+12:end)]; % skip over <br></p> in original source
    %% Remove/modify remaining prettify_MATLAB_html tags
    tagsToRemove = {'[rembr]','[delbr]','[delsp]','[png2svg]','[/png2svg]','[removepng]','[/removepng]','[darkAlt]','[/darkAlt]','[imageFolder='};
    for tag = tagsToRemove
        if tag{:}(end)~=']'
            tagStarts = strfind(fstrm,tag{:});
            for tagStart = tagStarts
                tagEnd = strfind(fstrm(tagStart:end),']');
                fstrm(tagStart:tagStart+tagEnd(1)-1)=[];
            end
        else
            fstrm = strrep(fstrm,tag{:},'');
        end
    end
    fstrm = strrep(fstrm,'[ targetn]','[target<i>n</i>]');
    fstrm = strrep(fstrm,'[ jumpton]','[jumpto<i>n</i>]');
    fstrm = strrep(fstrm,'[ scalex]' ,'[scale<i>x</i>]');
    fstrm = strrep(fstrm,'[ class.class-name]' ,'[class.<i>class-name</i>]');
    fstrm = strrep(fstrm,'[ brx]'    ,'[br<i>x</i>]');
    fstrm = strrep(fstrm,'[ bottomMarginx]'    ,'[bottomMargin<i>x</i>]');
    tagsToModify = {'[ br','[ bottomMargin','[ target','[ rembr]','[ delbr]','[ delsp]','[ frameBufferx]'};
    for tag = tagsToModify
        fstrm = strrep(fstrm,tag{:},[tag{:}(1) tag{:}(3:end)]);
    end
    tagsToModify = {'[ dtls]','[ smry]','[ jumpto','[ cssClasses','[ colour','[ scale','[ class','[ themesEnabled]','[ darkAlt]','[ h2]','[ h2.CElink]'};
    for tag = tagsToModify
        fstrm = strrep(fstrm,tag{:},[tag{:}(1) tag{:}(3:end)]);
        fstrm = strrep(fstrm,[tag{:}(1:2) '/' tag{:}(3:end)],[tag{:}(1) '/' tag{:}(3:end)]);
    end
    %% Final bit of javascript
    fstrm = strrep(fstrm,'</body>',['<script>' NL ...
                                    'var allDetails   = document.getElementsByTagName(''details'');' NL ...
                                    'var contentDiv   = document.getElementsByClassName("content"); contentDiv = contentDiv[0];' NL ...
                                    'var returnButton = document.getElementById("return-link");' NL ...
                                    'document.getElementById("iFrameBuf").style.display = "none";' NL ...
                                    'if(in_iFrame())' NL ...
                                    '{' NL ...
                                    '   try{' NL ...
                                    '      var footerNav = parent.document.getElementsByClassName("footernav");' NL ...
                                    '      var tabPane   = parent.document.getElementsByClassName("tab-pane");}' NL ...
                                    '   catch(err) { var footerNav = []; var tabPane = [];};' NL ...
                                    '   if(!(footerNav.length) || tabPane.length)' NL ... we are embedded in a frame that's not a MATLAB help browser frame
                                    '   {' NL ...
                                    '      contentDiv.style.overflowY = "scroll";'   NL ...
                                    '      contentDiv.style.overflowX = "hidden";'   NL ...
                                    '      contentDiv.style.position  = "absolute";' NL ...
                                    '      contentDiv.style.width     = "95%";'      NL ...
                                    '      contentDiv.style.top       = 0;'          NL ...
                                    '      contentDiv.style.bottom    = 0;'          NL ...
                                    '      if (tabPane.length){' NL ...
                                    '         contentDiv.setAttribute("data-isMATLABCentral","1");' NL ...
                                    '         returnButton.style.right = "40px";' NL ...
                                    '         document.getElementById("tooltiptext").style.right = "92px"; }' NL ...
                                    '      document.getElementById("iFrameBuf").style.display = "block";' NL ...
                                    '   }' NL ...
                                    '   else { contentDiv.setAttribute("data-isHelpBrowser","1"); }' NL ...
                                    '}' NL ...
                                    'if (!contentDiv.getAttribute("data-isHelpBrowser") && !contentDiv.getAttribute("data-isMATLABCentral") ){' NL ...
                                    '   document.getElementById("anchor-offsets").sheet.disabled = true; }' NL ...
                                    'var jumpLinks = document.getElementsByTagName("a");' NL ...
                                    'for (var i = 0; i < jumpLinks.length; i++){' NL ...
                                    '  href = jumpLinks[i].getAttribute("href");' NL ...
                                    '  if (href && href[0] == "#") { jumpLinks[i].onclick = jump_to;}}' NL ...
                                    '</script></body>']);
    %% Write the output file
    if verbose, fprintf(1,'Writing output file...\n'); end
    write_fstrm_to_file(fstrm, inputhtmlFile);
    if DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), 'processing complete.html', 1); end
    if verbose, fprintf(1,'Processing complete.\n'); end
    show_warning_dialogue;
    catch MEx
        show_warning_dialogue;
        throwError = false;
        if ~isempty(MEx.identifier)
            fprintf(2,'\nPLEASE REPORT BUGS TO: <a href="mailto:harry.dymond@bristol.ac.uk">harry.dymond@bristol.ac.uk</a>\n\n');
            errorMsg = ['Error!' NL 'Please see MATLAB command line for more information'];
            throwError = true;
        else
            errorMsg = MEx.message;
        end
        callStack = dbstack;
        if length(callStack)>1 && strcmp(callStack(2).file,'publish.m')
            uiwait(msgbox(errorMsg,'','error','modal'));
        else
            fprintf(2,errorMsg);
        end
        if throwError
            fprintf(2,'Error in %s on <a href="matlab:opentoline(''%s'', %i)">line %i</a>:\n', ...
                      MEx.stack(1).name, MEx.stack(1).file, MEx.stack(1).line, MEx.stack(1).line)
            throw(MEx)
        end
    end
    %% Subroutines
    function update_idxs(insertionLength)
        %%     Index updater
        detailsOpens ( detailsOpens  > insertPoint ) = detailsOpens ( detailsOpens  > insertPoint ) + insertionLength;
        detailsCloses( detailsCloses > insertPoint ) = detailsCloses( detailsCloses > insertPoint ) + insertionLength;
        summaryCloses( summaryCloses > insertPoint ) = summaryCloses( summaryCloses > insertPoint ) + insertionLength;
        imgTags      ( imgTags       > insertPoint ) = imgTags      ( imgTags       > insertPoint ) + insertionLength;

        htmlEnd = htmlEnd + insertionLength;
    end

    function show_warning_dialogue
        %%     Show warning dialogue if warnings were generated
        callStack = dbstack;
        if length(callStack)>1 && ismember('publish.m',{callStack.file}) && ~isempty(show_warning([]))
            uiwait(msgbox([num2str(show_warning([])) ' warnings generated' NL 'Please see MATLAB command line for more information'],'','warn','modal'));
        end
    end
end

%% ==========================================================================================================================================================
%% Helper functions
%%     Tag processing
function [fstrm, classNames, userCSS] = process_cssClasses_tags(fstrm, getClassNamesOnly)
    if nargin<2, getClassNamesOnly = false; end
    if getClassNamesOnly,     htmlEnd  = length(fstrm);
    else                , [~, htmlEnd] = find_source(fstrm); end
    [cssOpens, cssCloses] = get_tag_pairs('[cssClasses]', fstrm, htmlEnd);
    userCSS = '';
    if isempty(cssOpens), classNames = {}; return, end
    if length(cssOpens)>1
        throwAsCaller(MException('prettify:too many cssClass blocks','There should only be one pair of [cssClasses][/cssClasses] tags in your source file'))
    end
    openBraces   = strfind(fstrm(cssOpens:cssCloses),'{') + cssOpens - 1;
    closeBraces  = strfind(fstrm(cssOpens:cssCloses),'}') + cssOpens - 1;
    classNames{length(openBraces)} = '';
    fileIdx      = cssOpens + 12;
    for classCounter = 1:length(openBraces)
        % check first char after [cssClass]
        % [/cssClass]
        warnMsg        = '';
        WARN_MSG_START = ['css class ' num2str(classCounter) ' is malformed: '];
        while fileIdx<cssCloses && char(fstrm(fileIdx))~='.'
            fileIdx = fileIdx + 1;
        end
        if fstrm(fileIdx) ~= '.'
            warnMsg = [WARN_MSG_START 'css class declarations should start with a dot'];
        else
            if isempty(warnMsg) && openBraces(classCounter)>closeBraces(classCounter)
                warnMsg = [WARN_MSG_START 'opening ''{'' found after closing ''}'''];
            end
            classNames{classCounter} = sscanf(char(fstrm(fileIdx:openBraces(classCounter)-1)),'.%s');
            if any( cellfun( @(x)isequal(x,classNames{classCounter}), classNames( 1:length(classNames)~=classCounter ) )  )
                warnMsg = [WARN_MSG_START classNames{classCounter} ' has already been declared'];
                classNames{classCounter} = '';
            end
        end
        if ~isempty(warnMsg)
            show_warning(warnMsg)
        elseif ~getClassNamesOnly
            userCSS = [userCSS '.' classNames{classCounter} ' ' fstrm(openBraces(classCounter):closeBraces(classCounter)) NL]; %#ok<AGROW>
        end
        fileIdx = closeBraces(classCounter) + 1;
        if ~isempty(warnMsg), openBraces(classCounter) = 0; end
    end
    classNames(openBraces==0)=[];
    if getClassNamesOnly
        clear userCSS;
    else
        fstrm(cssOpens:cssCloses+12) = [];
    end
end

function [sourceStart, sourceEnd] = find_source(fstrm)
    sourceStart = strfind(fstrm,'</head>');
    sourceStart = sourceStart(1);
    sourceEnd   = strfind(fstrm,'##### SOURCE BEGIN #####');
    try
        assert(~isempty(sourceEnd),'ERROR: Format of MATLAB-generated html file has changed.');
    catch MEx
        throwAsCaller(MEx);
    end
    sourceEnd = sourceEnd(1);
end

function [fstrm, htmlEnd] = process_target_and_jump_tags(fstrm, htmlEnd)
    targetTagList  = strfind(fstrm(1:htmlEnd),'[target');
    [fstrm, htmlEnd, targetTagList, ~ , targetIDList, targetTagEnds] = find_valid_prettify_tags('target', targetTagList, [], [], fstrm, htmlEnd);
    for j = 1:length(targetTagList)
        % [targetn] -> <a id="targetn"></a>
        fstrm = [fstrm(1:targetTagList(j)-1) '<a id="' fstrm(targetTagList(j)+1:targetTagEnds(j)-1) '"></a>' fstrm(targetTagEnds(j)+1:end)];
        targetTagList = targetTagList + 11;
        targetTagEnds = targetTagEnds + 11;
        htmlEnd       = htmlEnd + 11;
    end

    [jumpOpens, jumpCloses] = get_tag_pairs('[jumpto]', fstrm, htmlEnd);
    [fstrm,htmlEnd,jumpOpens,jumpCloses,jumpIDList,jumpTagEnds] = find_valid_prettify_tags('jumpto', jumpOpens, jumpCloses, targetIDList, fstrm, htmlEnd);
    for j = 1:length(jumpOpens)
        % [jumpton] -> <a href="#targetn">
        fstrm = [fstrm(1:jumpOpens(j)-1) '<a href="#target' num2str(jumpIDList(j)) '">' fstrm(jumpTagEnds(j)+1:end)];
        jumpCloses  = jumpCloses  + 10;
        % [/jumpto] -> "</a>"
        fstrm = [fstrm(1:jumpCloses(j)-1) '</a>' fstrm(jumpCloses(j)+9:end)];
        jumpCloses  = jumpCloses  - 5;
        jumpOpens   = jumpOpens   + 5;
        jumpTagEnds = jumpTagEnds + 5;
        htmlEnd     = htmlEnd     + 5;
    end
end

function [fstrm, htmlEnd, tagList, tagCloseList, valList, tagEnds] = find_valid_prettify_tags(type, tagList, tagCloseList, validValList, fstrm, htmlEnd)
    if isempty(tagList), valList = []; tagEnds = []; return, end
    switch type
        case {'target','jumpto'}, sscanfFormat = ['[' type '%i'];  generic = 'n'; valDescriptor = 'target identifier'; valType = 'integer'; long = 3;
        case 'br'               , sscanfFormat = ['[' type '%g'];  generic = 'x'; valDescriptor = 'padding';           valType = 'number';  long = 3;
        case 'scale'            , sscanfFormat = ['[' type '%g'];  generic = 'x'; valDescriptor = 'scaling';           valType = 'positive number'; long = 5;
        case 'colour'           , sscanfFormat = ['[' type '%s'];  generic = '#'; valDescriptor = 'colour code';       valType = 'str';     long = 6;
        case 'class'            , sscanfFormat = ['[' type '.%s']; generic = '' ; valDescriptor = 'class name';        valType = 'str';     long = 100;
        case 'bottomMargin'     , sscanfFormat = ['[' type '%g'];  generic = 'x'; valDescriptor = 'margin';            valType = 'number';  long = 6;
    end
    WARN_MSG_START = ['[' type '] tag %i is malformed: '];
    if strcmp(valType, 'str'), valList{length(tagList)} = '';
    else                     , valList(length(tagList)) = NaN;  end
    tagEnds{length(tagList)} = [];
    for i = 1:length(tagList)
        warningMsg = '';
        tagEnds{i} = strfind(fstrm(tagList(i):htmlEnd),']');
        if isempty(tagEnds{i}), error(['ERROR: ' sprintf(WARN_MSG_START,i) 'there is no closing bracket.']); end
        tagEnds{i} = tagEnds{i}(1) + tagList(i) - 1;
        if (tagEnds{i}-tagList(i)-1-length(type))>long
            show_warning(['The ' valDescriptor ' for ' type generic ' tag ' num2str(i) ' is more than '...
                          num2str(long) ' characters long. Possible malformed tag?']);
        end
        val = sscanf(fstrm(tagList(i):tagEnds{i}-1),sscanfFormat);
        if strcmp(valType, 'str') && isempty(val)
            warningMsg = sprintf([WARN_MSG_START '%c should be a valid %s.'], i, generic, valDescriptor);
        elseif ~strcmp(valType, 'str') && ( isempty(val) || (contains(valType,'positive') && val<=0) )
            warningMsg = sprintf([WARN_MSG_START '%c should be a %s.'], i, generic, valType);
        else
            switch type
                case 'target' , if any(valList == val)
                    warningMsg = sprintf([WARN_MSG_START '%i has already been used as a target.'], i, val); end
                case 'jumpto' , if ~any(validValList == val) %#ok<ALIGN>
                    warningMsg = sprintf([WARN_MSG_START '%i has not been specified as a jump target (no [target%i] tag in source).'],...
                                         i, val, val); end
                case 'colour'
                    valid = true;
                    if length(val)~=6                , valid = false; end
                    if valid, try hex2dec(val); catch, valid = false; end, end
                    if ~valid, warningMsg = sprintf([WARN_MSG_START val ' is not a valid colour code.']); end
                case 'class', if ~any(cellfun(@(x)isequal(x,val),validValList))
                    warningMsg = sprintf([WARN_MSG_START '%s has not been defined as a CSS class.'], i, val); end
            end
        end
        if ~isempty(warningMsg)
            show_warning(warningMsg);
        elseif ischar(val)
            valList{i} = val;
        else
            valList(i) = val;
        end
    end
    tagEnds = cell2mat(tagEnds);
    if strcmp(valType, 'str'), invalidIdxs = find(cellfun(@isempty,valList));
    else                     , invalidIdxs = find(isnan(valList));                end
    for i = invalidIdxs
        fstrm(tagList(i):tagEnds(i)) = [];
        noOfCharsDeleted = (tagEnds(i)-tagList(i)+1);
        tagList(i+1:end) = tagList(i+1:end) - noOfCharsDeleted;
        tagEnds(i+1:end) = tagEnds(i+1:end) - noOfCharsDeleted;
        htmlEnd          = htmlEnd - noOfCharsDeleted;
        if ismember(type,{'jumpto','scale','colour','class'})
            noOfCharsToRemove = 3 + length(type);
            tagCloseList(i:end)   = tagCloseList(i:end) - noOfCharsDeleted;
            fstrm(tagCloseList(i):tagCloseList(i)+2+length(type)) = [];
            tagCloseList(i)       = 0;
            tagCloseList(i+1:end) = tagCloseList(i+1:end) - noOfCharsToRemove;
            tagList     (i+1:end) = tagList     (i+1:end) - noOfCharsToRemove;
            tagEnds     (i+1:end) = tagEnds     (i+1:end) - noOfCharsToRemove;
            htmlEnd               = htmlEnd - noOfCharsToRemove;
        end
        tagList(i) = 0;
    end
    valList(tagList==0)=[];
    tagEnds(tagList==0)=[];
    tagList(tagList==0)=[];
    tagCloseList(tagCloseList==0)=[];
end

function [fstrm, htmlEnd] = prettyTag2htmlTag(type, tagOpens, tagCloses, vals, tagEnds, fstrm, sourceStart, htmlEnd, DEBUG)
    switch type
        case 'scale' , kind = 'style'; get_val = @(x, idx)sprintf('font-size: %.3g%%;',x(idx)*100);
        case 'colour', kind = 'style'; get_val = @(x, idx)['color: #' x{idx} ';'];
        case 'class' , kind = 'class'; get_val = @(x, idx)x{idx};
    end
    if strcmp(type,'class'), [countOfTags, tagCloses] = sort_tag_closes(tagOpens, tagCloses);
    else                   , countOfTags = length(tagOpens);                                  end

    for i = 1:countOfTags
        % <p>[/type]</p> -> [/type]
        if strcmp(fstrm(tagCloses(i)-3:tagCloses(i)-1),'<p>') ...
        && strcmp(fstrm(tagCloses(i)+length(type)+3:tagCloses(i)+length(type)+6),'</p>')
            fstrm([tagCloses(i)-3:tagCloses(i)-1 tagCloses(i)+length(type)+3:tagCloses(i)+length(type)+6]) = [];
            update_idxs(tagCloses(i), -7);
            tagCloses(i) = tagCloses(i)-3;
        end
    end

    % Deal with [type] ... [/type] tags enclosing non-compatible html tags such as <p></p>, <table></table>, <ul></ul>, etc.:
    % [type] ... [/type] fully encloses non-enclosable section:
    % [type] ... <nonEnclosable>...</nonEnclosable> ... [/type] -> [type] ... [/type]<nonEnclosable kind="">...</nonEnclosable>[type] ... [/type] (note kind
    % added to <nonEnclosable>)
    %
    % [type] ... [/type] encloses opening non-enclosable tag only:
    % [type] ... <nonEnclosable>... [/type] ... </nonEnclosable>  -> [type] ... [/type]<nonEnclosable>[type] ... [/type] ...</nonEnclosable>  (note kind NOT
    % added to <nonEnclosable>)
    %
    % [type] ... [/type] encloses closing non-enclosable tag only:
    % <nonEnclosable> ... [type] ... </nonEnclosable> ... [/type] -> <nonEnclosable>...[type] ... [/type]</nonEnclosable>[type]... [/type]  (note kind NOT
    % added to <nonEnclosable>)
    %
    % nested [type] tags -> what might happen?
    %   1o                            2o                               2c     1c
    % [type] ... <nonEnclosable>... [type] ... </nonEnclosable> ... [/type][/type] type pair 1 processed gives ->
    %   1o       1c (new)                              3o (shift)                  2o (new)  3c (shift) 2c (shift)
    % [type] ... [/type]<nonEnclosable kind="kind1">... [type] ... </nonEnclosable>[type] ... [/type][/type] type pair 2 processed gives no change, type
    % pair 3 processed gives ->
    %   1o          1c                                    3o       3c (new)             4o (new)  2o      4c (shift) 2c
    % [type] ... [/type]<nonEnclosable kind="kind1">... [type] ... [/type]</nonEnclosable>[type][type] ... [/type][/type] ->

    changesMade = true;
    while changesMade
        changesMade = false;
        i = 1;
        while i<=length(tagOpens)
            for nonEnclosableTag = {'<p>','<table>','<ol>','<ul>','<pre>','<div>','<img>','<dl>','<h1>','<h2>','<h3>','<h4>','<h5>','<h6>'}
                nonEnclosableTagAlt    = [nonEnclosableTag{:}(1:end-1) ' '];
                nonEnclosableTagCloser = [nonEnclosableTag{:}(1) '/' nonEnclosableTag{:}(2:end)];
                if contains(fstrm(tagOpens(i):tagCloses(i)), nonEnclosableTag{:}) ...
                || contains(fstrm(tagOpens(i):tagCloses(i)), nonEnclosableTagAlt) ...
                || contains(fstrm(tagOpens(i):tagCloses(i)), nonEnclosableTagCloser)
                    nonEnclosableTagOpens  = strfind(fstrm(tagOpens(i):tagCloses(i)), nonEnclosableTag{:}) + tagOpens(i) - 1;
                    nonEnclosableTagOpens  = sort( [ nonEnclosableTagOpens strfind(fstrm(tagOpens(i):tagCloses(i)), nonEnclosableTagAlt)+tagOpens(i)-1 ] );
                    nonEnclosableTagCloses = strfind(fstrm(tagOpens(i):tagCloses(i)), nonEnclosableTagCloser) + tagOpens(i) - 1;
                    addKindToTag = false;
                    if ~isempty(nonEnclosableTagOpens) && ~isempty(nonEnclosableTagCloses) && nonEnclosableTagOpens(1)<nonEnclosableTagCloses(end)
                        if ~strcmp(nonEnclosableTag{:},'<img>'), addKindToTag = true; end
                        newTagCloseInsertPos = nonEnclosableTagOpens(1)-1;
                        newTagOpenInsertPos  = nonEnclosableTagCloses(end)+length(nonEnclosableTagCloser) + length(type)+2;
                    elseif ~isempty(nonEnclosableTagOpens)
                        newTagCloseInsertPos = nonEnclosableTagOpens(1)-1;
                        newTagOpenInsertPos  = strfind(fstrm(nonEnclosableTagOpens(1):tagCloses(i)),'>') + nonEnclosableTagOpens(1) - 1;
                        newTagOpenInsertPos  = newTagOpenInsertPos(1) + length(type)+3;
                    else
                        newTagCloseInsertPos = nonEnclosableTagCloses(end)-1;
                        newTagOpenInsertPos  = nonEnclosableTagCloses(end)+length(nonEnclosableTagCloser) + length(type)+2;
                    end
                    if addKindToTag
                        tagClose = strfind(fstrm(nonEnclosableTagOpens(1):tagCloses(i)),'>');
                        tagClose = tagClose(1) + nonEnclosableTagOpens(1) - 1;
                        [insertStr, insertIdx] = add_to_html_tag(kind, get_val(vals,i), fstrm, nonEnclosableTag{:}(2:end-1),...
                                                                 nonEnclosableTagOpens(1), tagClose);
                        fstrm = [fstrm(1:insertIdx-1) insertStr fstrm(insertIdx:end)];
                        update_idxs(insertIdx, length(insertStr));
                        newTagOpenInsertPos = newTagOpenInsertPos + length(insertStr);
                    end
                    % insert new [/type] tag
                    fstrm = [fstrm(1:newTagCloseInsertPos) '[/' type ']' fstrm(newTagCloseInsertPos+1:end)];
                    update_idxs(newTagCloseInsertPos+1, length(type)+3);
                    % insert new [type] tag
                    tagLength = 1+tagEnds(i)-tagOpens(i);
                    fstrm = [fstrm(1:newTagOpenInsertPos) fstrm(tagOpens(i):tagEnds(i)) fstrm(newTagOpenInsertPos+1:end)];
                    tagOpens  = [tagOpens(1:i)    newTagOpenInsertPos+1         tagOpens(i+1:end)];
                    tagEnds   = [tagEnds(1:i)     newTagOpenInsertPos+tagLength tagEnds(i+1:end) ];
                    tagCloses = [tagCloses(1:i-1) newTagCloseInsertPos+1        tagCloses(i:end) ];
                    update_idxs(newTagOpenInsertPos, tagLength);
                    tagOpens(i+1) = newTagOpenInsertPos+1;
                    tagEnds(i+1)  = newTagOpenInsertPos+tagLength;
                    vals = [vals(1:i) vals(i) vals(i+1:end)];
                    changesMade = true;
                    break;
                end
            end
            i = i + 1;
        end
    end
    if DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), ['after processing [' type '] tags enclosing html tags.html'], 1); end
    % delete consecutive [type][/type] tags
    i = 1;
    while i <= length(tagOpens)
        if tagEnds(i)+1==tagCloses(i)
            fstrm(tagOpens(i):tagCloses(i)+length(type)+2) = [];
            update_idxs(tagCloses(i), -(tagCloses(i)+length(type)+3-tagOpens(i)));
            tagOpens(i)  = [];
            tagCloses(i) = [];
            tagEnds(i)   = [];
            vals(i)      = [];
        else
            i = i + 1;
        end
    end
    if DEBUG, write_fstrm_to_file(fstrm(sourceStart:htmlEnd), ['after removing consecutive [' type '][' type 'close] tags.html'], 1); end

    for i = 1:length(tagOpens)
        if strcmp(type,'class') && ismember(get_val(vals,i),{'codeinput','codeoutput','error'}), htmlTag = 'pre';
        else                                                                                   , htmlTag = 'span'; end
        spanOpen = strfind(fstrm(1:tagOpens(i)),['<' htmlTag ' ']); % could be "pre" rather than "span", but haven't changed variable names
        if ~isempty(spanOpen)
            spanOpen  = spanOpen(end);
            spanClose = strfind(fstrm(spanOpen:tagOpens(i)),'>');
            if ~isempty(spanClose), spanClose = spanClose(1) +spanOpen-1; end
            if ~strcmp(sscanf(fstrm(spanClose:tagOpens(i)),'%s'),'>[')
                spanOpen = [];
            end
        end % '</span>'
        if ( ~isempty(spanOpen) || strcmp(fstrm(tagEnds(i)+1:tagEnds(i)+length(htmlTag)+2),['<' htmlTag ' ']) ) ...
        && (   strcmp(fstrm(tagCloses(i)-(length(htmlTag)+3):tagCloses(i)-1),['</' htmlTag '>'])                           ...
            || strcmp(fstrm(tagCloses(i)+length(type)+3:tagCloses(i)+length(type)+3+length(htmlTag)+2),['</' htmlTag '>'])    )
            % [typex]<span kind="blah> -> <span kind="x blah (or "pre" rather than "span")
            % or <span kind="blah>[typex] -> <span kind="x blah
            if isempty(spanOpen)
                spanOpen  = tagEnds(i)+1;
                spanClose = strfind(fstrm(tagEnds(i):tagCloses(i)),'>');
                spanClose = spanClose(1) + tagEnds(i) - 1;
            end
            [insertStr, insertIdx] = add_to_html_tag(kind, get_val(vals,i), fstrm, htmlTag, spanOpen, spanClose);
            % remove </span> or </pre> (will be replaced later)
            if strcmp(fstrm(tagCloses(i)-(length(htmlTag)+3):tagCloses(i)-1),['</' htmlTag '>'])
                fstrm(tagCloses(i)-(length(htmlTag)+3):tagCloses(i)-1)=[];
                tagCloses(tagCloses>tagCloses(i)-1) = tagCloses(tagCloses>tagCloses(i)-1) - (length(htmlTag)+3);
            else
                fstrm(tagCloses(i)+length(type)+3:tagCloses(i)+length(type)+3+length(htmlTag)+2)=[];
                tagCloses(tagCloses>tagCloses(i)) = tagCloses(tagCloses>tagCloses(i)) - (length(htmlTag)+3);
            end
            tagEnds (tagEnds >tagCloses(i)) = tagEnds (tagEnds >tagCloses(i)) - (length(htmlTag)+3);
            tagOpens(tagOpens>tagCloses(i)) = tagOpens(tagOpens>tagCloses(i)) - (length(htmlTag)+3);
        else
            % [type] -> <span kind="x"> or <pre kind="x">
            insertStr = ['<' htmlTag ' ' kind '="' get_val(vals,i) '">'];
            insertIdx = tagEnds(i)+1;
        end
        fstrm = [fstrm(1:insertIdx-1) insertStr fstrm(insertIdx:end)];
        if insertIdx<tagOpens(i), fstrm(tagOpens(i)+length(insertStr):tagEnds(i)+length(insertStr)) = [];
        else                    , fstrm(tagOpens(i):tagEnds(i)) = []; end
        noOfCharsToRemove = 1+tagEnds(i)-tagOpens(i);
        charIncrease      = length(insertStr) - noOfCharsToRemove;
        update_idxs(insertIdx-1, charIncrease);
        % [/"type"] -> </span> or </pre>
        closeTagLength = length(type)+3;
        insertPoint    = tagCloses(i)-1;
        fstrm = [fstrm(1:insertPoint) ['</' htmlTag '>'] fstrm(insertPoint+1+closeTagLength:end)];
        update_idxs(tagCloses(i), (length(htmlTag)+3) - closeTagLength)
    end

    function update_idxs(insertPoint, idxAdj)
        tagEnds  (tagOpens >insertPoint) = tagEnds  (tagOpens >insertPoint) + idxAdj;
        tagCloses(tagCloses>insertPoint) = tagCloses(tagCloses>insertPoint) + idxAdj;
        tagOpens (tagOpens >insertPoint) = tagOpens (tagOpens >insertPoint) + idxAdj;
        htmlEnd = htmlEnd + idxAdj;
    end
end

function [insertStr, insertIdx] = add_to_html_tag(kind, val, fstrm, htmlTag, tagOpen, tagClose)
% kind:     String defining the kind of attribute to be added to the htmlTag, e.g. 'style' or 'class'
% val :     The value of the attribute e.g. 'margin-bottom:10px'
% fstrm:    The html file in memory
% htmlTag:  String defining the html tag that the style or class will be applied to, and should not include the "<" or ">". e.g., if adding a style to a
%           table, htmlTag would be set to 'table'
% tagOpen:  Position of opening of tag in fstrm
% tagClose: Position of closing of tag (i.e., the tag's ">" character
    for lookForStr = {[kind '="'],[kind ' ="'],[kind '= "'],[kind ' = "']}
        lookForIdx = strfind(fstrm(tagOpen:tagClose),lookForStr{:});
        if ~isempty(lookForIdx)
            lookForIdx = lookForIdx(1) + tagOpen - 1;
            insertStr  = [val ' '];
            insertIdx  = lookForIdx+length(lookForStr{:});
            break;
        end
    end
    if isempty(lookForIdx)
        insertStr = [' ' kind '="' val '"'];
        insertIdx = tagOpen+length(htmlTag)+1;
    end
end

function [tagOpens, tagCloses] = get_tag_pairs(tag, fstrm, htmlEnd)
    closeTag  = ['[/' tag(2:end)];
    if ismember(tag,{'[jumpto]','[scale]','[colour]','[class]'}), openTag = tag(1:end-1);
    else                                                        , openTag = tag;         end
    tagOpens  = strfind(fstrm(1:htmlEnd),openTag);
    tagCloses = strfind(fstrm(1:htmlEnd),closeTag);
    try
        assert( length(tagOpens)==length(tagCloses), 'ERROR: Number of %s tags (%i) does not match number of %s tags (%i)', ...
                                                             tag, length(tagOpens), closeTag, length(tagCloses));
        if ~ismember(tag,{'[class]','[dtls]'}), check_tag_pairs(tagOpens, tagCloses, tag); end
    catch MEx
        throwAsCaller(MEx)
    end
end

function check_tag_pairs(tagOpens, tagCloses, type)
    if isempty(tagOpens), return, end
    try
        closeBeforeOpenError = 'ERROR: %s close tag %i appears before open tag %i';
        for i = 1:length(tagOpens)-1
            assert(tagOpens(i)<tagCloses(i),closeBeforeOpenError,type,i,i);
            assert(tagCloses(i)<tagOpens(i+1),'ERROR: %s open tag %i appears before close tag %i',type,i+1,i);
        end
        if isempty(i), i = 1; end
        assert(tagOpens(i)<tagCloses(i),closeBeforeOpenError,type,i,i);
    catch MEx
        throwAsCaller(MEx)
    end
end

function [countOfTags, tagCloses] = sort_tag_closes(tagOpens, tagCloses)
    countOfTags       = length(tagOpens);
    tagClosesUnsorted = tagCloses;
    tagCloses(:) = 0;
    for i = 1:countOfTags
        tagCloseIdx = 1;
        while i+tagCloseIdx<=countOfTags && tagClosesUnsorted(tagCloseIdx)>tagOpens(i+tagCloseIdx), tagCloseIdx = tagCloseIdx+1; end
        tagCloses(i) = tagClosesUnsorted(tagCloseIdx);
        tagClosesUnsorted(tagCloseIdx) = [];
    end
    assert(~any(tagCloses==0),'prettifyMATLABhtml:internalError','Failed to sort nested tags');
end

%%     Get path of this .m file
function myPath = my_path()
%
%   NOTE: path returned includes trailing file separator
%
    myName = mfilename();
    myPath = mfilename('fullpath');
    myPath = myPath(1:end-length(myName));
end

%%     Save handle to built-in Publish function
function save_publish_handle
    publishName = which('publish');
    if ~strcmp(publishName(end-1:end),'.p')
        error(['ERROR: You must run this before MATLAB''s "publish" function has been overloaded.'...
               ' In other words, the custom "publish" function must not be on the MATLAB path when you run save_publish_handle.']);
    else
        setappdata(0,'real_publish',@publish);
    end
end

%%     Warning functions
function warningsIssued = show_warning(msg)
    persistent warnCounter
    if islogical(msg), warnCounter = []; return; end
    if isempty(msg), warningsIssued = warnCounter; return, end
    if isempty(warnCounter)
        fprintf(1, wrap_text(sprintf('\n%s: prettify_MATLAB_html [\\bWARNING%cmessages:]\\b\n', datestr(now),char(160)),'')); warnCounter = 0;
    end
    warnCounter = warnCounter + 1;
    fprintf(1,'\n%i. [\b%s]\b\n', warnCounter, wrap_text(msg,'   '));
end

function wrappedText = wrap_text(str, lineStart)
    commandWindowSize = get(0, 'CommandWindowSize');
    numCols           = commandWindowSize(1)-2-length(lineStart);

    if length(str)<= numCols, wrappedText = str; return; end
    lines = strsplit(str,'\n');
    lineCounter = 1;
    while lineCounter<=length(lines)
        if length(lines{lineCounter}) > numCols
            lastChar = 1;
            spaces   = strfind(lines{lineCounter},' ');
            insertNewLine = spaces(find(spaces<=numCols,1,'last'));
            if isempty(insertNewLine)
                insertNewLine = numCols;
                lastChar      = 0;
            end
            lines = [lines(1:lineCounter) {lines{lineCounter}(insertNewLine+1:end)} lines(lineCounter+1:end)];
            lines{lineCounter} = lines{lineCounter}(1:insertNewLine-lastChar);
        end
        lineCounter = lineCounter + 1;
    end
    wrappedText = strjoin(lines,[NL lineStart]);
end

%%     Toolbar button functions
function insert_target(document)
    targetTagList = strfind(document.Text,'[target');
    [~, ~, ~, ~, targetIDList, ~] = find_valid_prettify_tags('target', targetTagList, [], [], document.Text, length(document.Text));
    if ~isempty(targetIDList), targetID = max(targetIDList)+1;
    else                     , targetID = 1; end
    document.insertTextAtPositionInLine(['[target' num2str(targetID) ']'], document.Selection(1), document.Selection(2))
end

function insert_table(document)
    if document.Selection(2)>1, document.goToPositionInLine(document.Selection(1)+1,1); end
    HTML_TABLE_TEMPLATE = ['%' NL ...
                           '% <html>' NL ...
                           '% <table class="MATLAB-Help">' NL ...
                           '% <thead><tr>' NL ...
                           '%    <th>COLUMN1 HEADING</th>' NL ...
                           '%    <th>COLUMN2 HEADING</th>' NL ...
                           '% </tr></thead>' NL ...
                           '%    <tr><td>CELL1</td><td>CELL2</td></tr>' NL ...
                           '%    <tr><td>CELL3</td><td>CELL4</td></tr>' NL ...
                           '% </table>' NL ...
                           '% </html>' NL ...
                           '%' NL];
    document.insertTextAtPositionInLine(HTML_TABLE_TEMPLATE, document.Selection(1), document.Selection(2))
end

function jumpton_wrap(document)
    targetTagList = strfind(document.Text,'[target');
    [~, ~, ~, ~, targetIDList, ~] = find_valid_prettify_tags('target', targetTagList, [], [], document.Text, length(document.Text));
    targetIDList(targetIDList==0) = [];
    targetID = 0;
    if ~isempty(targetIDList)
        if length(targetIDList) > 1
            targetIDList = sort(targetIDList);
            targetList   = arrayfun(@num2str,targetIDList,'UniformOutput',false);
            [indx, tf]   = listdlg('PromptString','Select target ID','ListString',targetList,'SelectionMode','single');
            if tf, targetID = targetIDList(indx); end
        else
            targetID = targetIDList;
        end
    end
    wrap_text_in_tag(document, '[jumpto', targetID);
end

function class_wrap(document)
    [~, classNames] = process_cssClasses_tags(document.Text, true);
    if contains(document.Text,'[themesEnabled]'), classNames = [classNames {'show-if-light', 'show-if-dark'}]; end
    className = 'CLASS-NAME';
    if ~isempty(classNames)
        if length(classNames) > 1
            [indx, tf]   = listdlg('PromptString','Select class name','ListString',classNames,'SelectionMode','single');
            if tf, className = classNames(indx);
            else , return, end
        else
            className = classNames{1};
        end
    end
    if iscell(className), className = className{1}; end
    wrap_text_in_tag(document, '[class', ['.' className]);
end

function colour_wrap(document)
    c = uisetcolor;
    if c==0, return;
    else   , c = round(255*c); c = [upper(dec2hex(c(1),2)) upper(dec2hex(c(2),2)) upper(dec2hex(c(3),2))]; end
    wrap_text_in_tag(document, '[colour', c);
end

function wrap_text_in_tag(document, openTag, n)
    WHITE_SPACE  = char([9:13 32 133 160]);
    PUNCTUATION  = '(),.;:';
    if strcmp(openTag,'[cssClasses]') && contains(document.Text, openTag)
        uiwait(msgbox(['A cssClasses block already exists' NL 'Source files should have only one cssClasses block'],'','help','modal')); return, end
    selectedText = document.SelectedText;
    closeTag = [openTag(1) '/' openTag(2:end)];
    if nargin==3
        if ~ischar(n)
            if n == 0, n = 'n';
            else     , n = num2str(n); end
        end
        openTag = [openTag n ']'];
        closeTag(end+1) = ']';
    end
    % convert the selection from Lines/Columns to index
    selectionPosition = document.Selection;
    startPos          = matlab.desktop.editor.positionInLineToIndex(document, selectionPosition(1), selectionPosition(2));
    endPos            = matlab.desktop.editor.positionInLineToIndex(document, selectionPosition(3), selectionPosition(4));

    if ~isempty(selectedText)
        while startPos>1
            if ~ismember(document.Text(startPos-1),[WHITE_SPACE PUNCTUATION ']']), startPos = startPos-1;
            else                                                                 , break,                 end
        end
        while endPos<=(length(document.Text)-1)
            if ~ismember(document.Text(endPos),[WHITE_SPACE PUNCTUATION '[']), endPos = endPos+1;
            else                                                             , break,             end
        end
        if ismember(document.Text(startPos),{'*','_','<','|','$'}), openTag(end+1)  = ' ';     end
        if ismember(document.Text(endPos-1),{'*','_','>','|','$'}), closeTag = [' ' closeTag]; end
    end
    wrappedText   = [openTag document.Text(startPos:endPos-1) closeTag];
    document.Text = [document.Text(1:startPos-1) wrappedText document.Text(endPos:end)];
    % Re-select
    [selectionPosition(1), selectionPosition(2)] = matlab.desktop.editor.indexToPositionInLine(document, startPos+length(openTag));
    [selectionPosition(3), selectionPosition(4)] = matlab.desktop.editor.indexToPositionInLine(document, endPos  +length(openTag));
    document.Selection = selectionPosition;
end

function add_pretty_commands_to_toolbar
    PRETTY_CATEGORY = 'PRETTIFY';
    COMMAND_LIST    = {'dtls','smry','targetn','jumpton','cssClasses','class','scale','colour','html table'};
    COMMAND_START   = 'prettify_MATLAB_html([],[],[],';
    COMMAND_FUNC    = {[COMMAND_START '''[dtls]'')'],[COMMAND_START '''[smry]'')'],[COMMAND_START '''target'')'],[COMMAND_START '''jumpto'')'],...
                       [COMMAND_START '''[cssClasses]'')'],[COMMAND_START '''class'')'],[COMMAND_START '''scale'')'],[COMMAND_START '''colour'')'],...
                       [COMMAND_START '''table'')']};
    fprintf(1,'\n');
    foundFlag(length(COMMAND_LIST)) = false;
    if verLessThan('matlab','9.4')
        % add shortcuts
        scUtils   = com.mathworks.mlwidgets.shortcuts.ShortcutUtils;
        scVector  = scUtils.getShortcutsByCategory(PRETTY_CATEGORY);
        scArray   = scVector.toArray;  % Java array
        for scIdx = 1:length(scArray)
           scName = char(scArray(scIdx));
           [alreadyExists, idx] = ismember(scName, COMMAND_LIST);
           if alreadyExists, foundFlag(idx) = true; end
        end
        i = 1:length(COMMAND_LIST);
        for i = i(~foundFlag)
            scUtils.addShortcutToBottom(COMMAND_LIST{i},COMMAND_FUNC{i},['Lower Case ' COMMAND_LIST{i}(1)], PRETTY_CATEGORY, 'true');
        end
        if isempty(i), fprintf(1,'[\bAll shortcuts already exist]\b\n');
        else         , fprintf(1,'[\bShortcuts created]\b\n'); end
        MSG_END = ' - please add the shortcuts to the Quick-Access Toolbar manually]\b\n';
        QA_XML  = [prefdir filesep 'MATLABQuickAccess.xml'];
        if ~exist(QA_XML,'file')
            fprintf(1,['[\bCouldn''t find the Quick Access xml file' MSG_END]);
        elseif exist([QA_XML '.bak'],'file') ...
            || (   ~exist([QA_XML '.bak'],'file') ...
                && copyfile(QA_XML, [QA_XML '.bak']) )
            fstrm        = read_file_to_mem(QA_XML);
            configStart  = strfind(fstrm,'<quick_access_configuration>');
            if length(configStart)~=1, fprintf(1,['[\bUnexpected Quick Access xml file format' MSG_END]); return, end
            linesToAdd = '';
            for command = COMMAND_LIST
                if ~contains(char(fstrm), command{:})
                linesToAdd = [linesToAdd '   <tool display_condition="always" label_visible="true" section_id="PRETTIFY" tab_id="shortcuts" tool_id="' ...
                              command{:} '" toolset_id="matlab_shortcut_toolset"/>' NL]; %#ok<AGROW>
                end
            end
            if isempty(linesToAdd)
                fprintf('[\bAll shortcuts already in Quick-Access Toolbar]\b\n');
            else
                fstrm = [fstrm(1:configStart+28) linesToAdd fstrm(configStart+29:end)];
                write_fstrm_to_file(fstrm, QA_XML);
                fprintf(1,'[\bPlease restart MATLAB to get the Prettify MATLAB html shortcuts in the Quick-Access Toolbar]\b\n');
            end
        end
    else
        % add favourites
        FAV_XML = [prefdir filesep 'FavoriteCommands.xml'];
        if ~exist(FAV_XML,'file')
            fprintf(1,'[\bCouldn''t find Favourites xml file; may result in duplicate Favourites]\b\n');
        else
            fstrm = read_file_to_mem(FAV_XML);
            for i = 1:length(COMMAND_LIST), if contains(char(fstrm), COMMAND_LIST{i}), foundFlag(i) = true; end, end
        end
        if all(foundFlag)
            fprintf(1,'[\bAll Toolbar buttons already exist]\b\n');
        else
            fc = com.mathworks.mlwidgets.favoritecommands.FavoriteCommands.getInstance();
            i = 1:length(COMMAND_LIST);
            for i = i(~foundFlag)
                % thanks to Martin Lechner at https://uk.mathworks.com/matlabcentral/answers/411846-how-to-create-favorites-by-code-command-window
                % for this code!
                command = com.mathworks.mlwidgets.favoritecommands.FavoriteCommandProperties();
                command.setCategoryLabel(PRETTY_CATEGORY);
                command.setLabel(COMMAND_LIST{i});
                command.setCode(COMMAND_FUNC{i});
                command.setIsOnQuickToolBar(true);
                command.setIsShowingLabelOnToolBar(true);
                command.setIconName(['favorite_command_' COMMAND_LIST{i}(1)]);
                fc.addCommand(command);
            end
            fprintf(1,'[\bToolbar buttons created]\b\n');
        end
    end
    fprintf(1,'\n');
end

%%     File read & write
function fstrm = read_file_to_mem(fileName)
    try
        fileH = fopen(fileName,'r');
        fstrm = fread(fileH, 'uchar')';
    catch MEx
        fclose(fileH);
        throwAsCaller(MException('prettify:fileread', sprintf('ERROR: Unable to read file %s: %s', fileName, MEx.message) ));
    end
    fclose(fileH);
end

function write_fstrm_to_file(fstrm, fileName, isDebug)
    persistent debugCount
    if     nargin<3, isDebug = false;
    elseif   isempty(isDebug), debugCount = []; return, end
    if isDebug
        if isempty(debugCount), debugCount = 0; end
        debugCount = debugCount + 1;
        fileName = ['debug ' sprintf('%03i',debugCount) '. - ' fileName];
    end
    if length(fileName)>=5 && strcmp(fileName(end-4:end),'.html')
        % Insert some line breaks to make source html a bit more readable
        if isDebug
            % have to be careful as this could change how the html renders, so be conservative when doing this for non-debug output
            fstrm = strrep(fstrm,'><',['>' NL '<']);
        else
            [sourceStart, htmlEnd] = find_source(fstrm);
            fstrm = strrep(fstrm,'><details',['>' NL '<details']);
            fstrm = strrep(fstrm,'</div></details>',[NL '</div>' NL '</details>']);
            fstrm = strrep(fstrm,'><div',['>' NL '<div']);
            fstrm = strrep(fstrm,'</li><li>',['</li>' NL '<li>']);
            fstrm = strrep(fstrm,'><p',['>' NL '<p']);
            preLocs = strfind(fstrm(sourceStart:htmlEnd),'<pre') + sourceStart - 1;
            if isempty(preLocs)
                fstrm = strrep(fstrm,'<br',[NL '<br']);
            else
                preCloseLocs = strfind(fstrm(sourceStart:htmlEnd),'</pre>') + sourceStart - 1;
                [countOfPreTags, preCloseLocs] = sort_tag_closes(preLocs, preCloseLocs);
                preLocs        = [2 preLocs];
                preCloseLocs   = [1 preCloseLocs];
                countOfPreTags = countOfPreTags + 1;
                for i = 2:countOfPreTags
                    if preLocs(i)>max(preCloseLocs(1:i-1))
                        lengthBefore = length(fstrm);
                        fstrm = [fstrm(1:max(preCloseLocs(1:i-1))) ...
                                 strrep(fstrm(max(preCloseLocs(1:i-1))+1:preLocs(i)),'<br',[NL '<br']) fstrm(preLocs(i)+1:end)];
                        charsAdded = length(fstrm) - lengthBefore;
                        preLocs     ( preLocs      > max(preCloseLocs(1:i-1)) ) = preLocs     ( preLocs      > max(preCloseLocs(1:i-1))) + charsAdded;
                        preCloseLocs( preCloseLocs > max(preCloseLocs(1:i-1)) ) = preCloseLocs( preCloseLocs > max(preCloseLocs(1:i-1))) + charsAdded;
                    end
                end
                fstrm = [fstrm(1:max(preCloseLocs)) ...
                         strrep(fstrm(max(preCloseLocs)+1:htmlEnd),'<br',[NL '<br']) fstrm(htmlEnd+1:end)];
            end
        end
    end
    try
        fileH = fopen(fileName,'w');
        fwrite(fileH, fstrm, 'char*1');
    catch MEx
        fclose(fileH);
        throwAsCaller(MException('prettify:filewrite', sprintf('ERROR: Unable to write file %s: %s',fileName, MEx.message) ));
    end
    fclose(fileH);
end

%%     New line constant
function CONST = NL, CONST = char(10); end %#ok<CHARTEN> for backwards compatibility

%% ==========================================================================================================================================================
%
%% Version history:
%
%   1.0     REPLACE_WITH_DASH_DASH Original release
%   1.1     REPLACE_WITH_DASH_DASH Improved method of closing <details> sections
%           REPLACE_WITH_DASH_DASH Better handling of consecutive [/dtls][dtls] tags
%   1.2     REPLACE_WITH_DASH_DASH Minor change to warning shown if a targetn, jumpton, or brx tag seems a bit long
%           REPLACE_WITH_DASH_DASH Documentation tweaks
%           REPLACE_WITH_DASH_DASH Minor code tidying; mainly adding sections
%   2.0     REPLACE_WITH_DASH_DASH Added support functions for adding shortcuts to Quick-Access Toolbar, that then allow easy adding of tags to source .m file
%           REPLACE_WITH_DASH_DASH Fixed bug that occurred when removing malformed [targetn] and [jumpton] tags
%   2.1     REPLACE_WITH_DASH_DASH Improved method of adding Toolbar buttons
%   3.0     REPLACE_WITH_DASH_DASH Added support for new tags: [cssClasses], [class.class-name], [scalex], [colour#], [themesEnabled], and [darkAlt]
%           REPLACE_WITH_DASH_DASH Added dark theme
%           REPLACE_WITH_DASH_DASH Improved handling of Toolbar buttons
%           REPLACE_WITH_DASH_DASH Other minor code cleanups and bug fixes
%   3.1     REPLACE_WITH_DASH_DASH Added workaround for MATLAB central miscalculating page height
%   3.2     REPLACE_WITH_DASH_DASH Improved method of assigning classes and styles
%   3.3     REPLACE_WITH_DASH_DASH Fixed bug with "collapse/expand all on page" link when page has no sections
%   3.4     REPLACE_WITH_DASH_DASH Added support for nesting of css classes e.g. [class.a][class.b]this item will be formatted according to css classes a and b[/class][/class]
%           REPLACE_WITH_DASH_DASH Increased robustness of enclosing inline html in [dtls] sections
%   3.5     REPLACE_WITH_DASH_DASH Improved enclosing of inline html into [dtls] sections (again)
%           REPLACE_WITH_DASH_DASH Improved handling of nested [colour#], [scalex], [class.class-name] tags
%   3.6     REPLACE_WITH_DASH_DASH Fixed bug when multiple images appear inside [dtls] sections
%           REPLACE_WITH_DASH_DASH Added Toolbar button to insert an html-table template
%   3.7     REPLACE_WITH_DASH_DASH Added "built-in" MATLAB publish CSS classes codeinput, codeoutput, error, keyword, comment, string, untermstring, and syscmd, as valid class
%              names when using the [class.class-name] tag, although these won't appear in the list presented when using the "class" Toolbar button
%           REPLACE_WITH_DASH_DASH Handles some incorrect syntax more gracefully
%   3.7.1   REPLACE_WITH_DASH_DASH Minor code tidy
%   3.8     REPLACE_WITH_DASH_DASH Fixed bug with "collapse/expand all" controls for pages with 10 or more sections
%   3.9     REPLACE_WITH_DASH_DASH Added [frameBufferx] tag
%   3.10    REPLACE_WITH_DASH_DASH Fixed bug associated with [frameBufferx] tag
%   3.11    REPLACE_WITH_DASH_DASH Better handling of malformed syntax
%   3.12    REPLACE_WITH_DASH_DASH Improved error handling
%   3.13    REPLACE_WITH_DASH_DASH Added [imageFolder=x] tag (undocumented companion to undocumented [png2svg] tag)
%   3.14    REPLACE_WITH_DASH_DASH Fixed bug that occured when any [dtls] sections were placed before MATLAB's auto-generated page contents list
%   4.0     REPLACE_WITH_DASH_DASH Enables nesting of [dtls] boxes
%           REPLACE_WITH_DASH_DASH [dtls] boxes are now rounded on all four corners when closed
%           REPLACE_WITH_DASH_DASH Improved syntax checking for [/dtls] tags
%           REPLACE_WITH_DASH_DASH Uses new method to save theme preference for better compatibility with the MATLAB web browser
%           REPLACE_WITH_DASH_DASH [bottomMarginx] tags are now documented
%           REPLACE_WITH_DASH_DASH [bottomMarginx] now processed after [dtls] and [smry] tags
%           REPLACE_WITH_DASH_DASH Processes [class.codeinput], [class.codeoutput], and [class.error] correctly by using html <pre> elements instead of <span>
%           REPLACE_WITH_DASH_DASH Added undocumented [removepng] tags
%   4.1     REPLACE_WITH_DASH_DASH Improved syntax checking for [dtls] tags
%           REPLACE_WITH_DASH_DASH Improved handling of html in [dtls] boxes (also fixes potential bug when nesting [dtls] boxes)
%   4.2     REPLACE_WITH_DASH_DASH Fixed issue with collapse-all/expand-all links in help browser of recent versions of MATLAB
%           REPLACE_WITH_DASH_DASH Improved spacing after generated code output and lists that appear at the end of [dtls] boxes
%   4.3     REPLACE_WITH_DASH_DASH No longer creates extra space after monospaced text (e.g. |text| ) that is wrapped in [class], [scale], or [colour] tags
%           REPLACE_WITH_DASH_DASH Added the [delsp] tag
%   4.4     REPLACE_WITH_DASH_DASH Now includes version number of prettify_MATLAB_html in the footer link
%   4.5     REPLACE_WITH_DASH_DASH In-page links now jump to correct location if page is viewed on Matlab Central (e.g. in the "Examples" tab) or the MATLAB help browser (the
%              former, and some versions of the latter, put a floating banner across the top of the page that must be accounted for when jumping)
%           REPLACE_WITH_DASH_DASH If viewed on MATLAB Central, pages now have a scroll bar, so the [framebufferx] tag is no longer required
%           REPLACE_WITH_DASH_DASH Makes in-page links work for most browsers, if the page is viewed in the "Examples" tab on MATLAB Central
%   5.0     REPLACE_WITH_DASH_DASH Bug fix - improved spacing after numbered lists that appear at the end of [dtls] boxes now works
%           REPLACE_WITH_DASH_DASH Improved spacing if a [dtls] box is the last element on the page
%           REPLACE_WITH_DASH_DASH Adds a "return" floating button/link when user follows an in-page link (but not if page is viewed in MATLAB help browser)
%           REPLACE_WITH_DASH_DASH Documented a method for adding headings with collapse/expand links without adding the heading to the page's contents list
%   5.1     REPLACE_WITH_DASH_DASH Improved floating back button functionality when page is viewed on MATLAB Central
%           REPLACE_WITH_DASH_DASH More robust positioning of collapse/expand links
%   6.0     REPLACE_WITH_DASH_DASH Fixed html 5 compliance issues, some due to the built-in publish, and some due to prettify
%           REPLACE_WITH_DASH_DASH Added [h2] and [h2.CElink] tags to create headings that are not added to the page's contents list
%           REPLACE_WITH_DASH_DASH Enhanced functionality of floating "return" link - arrow direction now updates as user scrolls up/down past the return target
%   6.1     REPLACE_WITH_DASH_DASH Fixed bug when processing <style></style> tags in embedded html
%   6.2     REPLACE_WITH_DASH_DASH Fixed bug when processing nested [class.<class name>] tags
%   6.3     REPLACE_WITH_DASH_DASH Now allows negative values for the [brx] tag
%   6.4     REPLACE_WITH_DASH_DASH Fixed bug that could occur when using [h2.CElink] tags in conjunction with nested [dtls] sections.
%   6.4.1   REPLACE_WITH_DASH_DASH Fixed bug that could occur when <tt> tags are replaced by <code> tags (HTML5 validation fix)
%   6.5     REPLACE_WITH_DASH_DASH 15 May 2021
%           REPLACE_WITH_DASH_DASH Details boxes now open automatically if they are closed and the user clicks an internal page link that links to the box
%
%============================================================================================================================================================

##### SOURCE END #####
--></body></html>